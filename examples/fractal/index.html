
<!DOCTYPE html>
<html>
<head>
<title>WebGL Shader Lab - Progressive Julia Fractal [Fullscreen]</title>
<style type="text/css">
  body {
    margin: 0px;
    padding: 0px;
  }

  #c {
    position: absolute;
    top: 0px;
    left: 0px;
    background: black;
  }

  a {
    color: #FFFFFF;
  }

  #overlay {
    position: absolute;
    color: #FFFFFF;
    top: 10px;
    left: 10px;
    z-index: 100;
    top: 10px;
  }
</style>

<script src="https://raw.github.com/senchalabs/philogl/master/build/PhiloGL.cls.js"></script>

<script id="shader-vs" type="x-shader/x-vertex"> 
  attribute vec3 position;
  attribute vec2 texCoord1;
  
  uniform mat4 worldMatrix;
  uniform mat4 projectionMatrix;
  
  varying   vec2 pixel;
  void main(void) {
     gl_Position = projectionMatrix * worldMatrix * vec4(position, 1.);
     pixel = texCoord1;
  }
</script>

<script id="shader-fs-advance" type="x-shader/x-fragment"> 
  #ifdef GL_ES
  precision highp float;
  #endif

  uniform sampler2D sampler1;//sampler_prev;

  varying vec2 pixel;
  uniform vec2 mouse;

  bool is_onscreen(vec2 uv){
    return (uv.x < 1.) && (uv.x > 0.) && (uv.y < 1.) && (uv.y > 0.);
  }

  void main(void) {
    vec2 c = vec2(-0.25, 0.0) + (mouse.yx-0.5)*vec2(0.2,-0.55);
    vec2 tuning =  vec2(1.8) - (mouse.y-0.5)*0.3;
    vec2 complexSquaredPlusC; // One steps towards the Julia Attractor
    vec2 uv = (pixel - vec2(0.5))*tuning;
    complexSquaredPlusC.x = (uv.x * uv.x - uv.y * uv.y + c.x + 0.5);
    complexSquaredPlusC.y = (2. * uv.x * uv.y + c.y + 0.5);
    
    if(is_onscreen(complexSquaredPlusC)){
      vec4 old = texture2D(sampler1, complexSquaredPlusC);
      gl_FragColor = old + vec4( .004, .008, .012, 1.); // increment to white
    }else{
      // return border color
      gl_FragColor = vec4(0., 0., 0., 1.); // out is black
    }
    gl_FragColor.a = 1.;
  }
</script>

<script id="shader-fs-composite" type="x-shader/x-fragment"> 
  #ifdef GL_ES
  precision highp float;
  #endif

    uniform sampler2D sampler1;//sampler_prev;

    varying vec2 pixel;
    uniform vec2 mouse;

  void main(void) {
    // negative
    gl_FragColor = texture2D(sampler1, pixel);
    gl_FragColor.a = 1.;
  }
</script>

<script>
PhiloGL.unpack();

function BrowserSize() {
  return {
    width: window.innerWidth || document.body.clientWidth,
    height: window.innerHeight || document.body.clientHeight
  };
}

var browserSize;
var halted = false;
var it = 1;
var time;
var mouseX = 0.5;
var mouseY = 0.5;
var animation;
var timer;
var sizeX = 512;
var sizeY = 512;
var viewX = 512;
var viewY = 512;
var c;

function setMaximalSize() {
  browserSize = new BrowserSize();
  c.width = viewX = browserSize.width;
  c.height = viewY = browserSize.height;
}

function load() {
  if (!PhiloGL.hasWebGL()) {
    alert("Your browser does not support WebGL");
    return;
  }

  c = document.getElementById('c');
  sizeX = 2048;
  sizeY = 2048;

  setMaximalSize();

  PhiloGL('c', {
    program: [{
      id: 'advance',
      from: 'ids',
      vs: 'shader-vs',
      fs: 'shader-fs-advance'
    }, {
      id: 'composite',
      from: 'ids',
      vs: 'shader-vs',
      fs: 'shader-fs-composite'
    }],
    events: {
      centerOrigin: false,
      onMouseMove: function(e) {
        mouseX = e.x / viewX;
        mouseY = 1 - e.y / viewY;
      },
      onClick: function(e) {
        halted = !halted;
      }
    },
    onError: function() {
      alert('There was an error, sorry :S');
    },
    onLoad: function(app) {
      //Set framebuffers
      var fboOpt = {
        width: sizeX,
        height: sizeY,
        bindToTexture: {
          parameters: [{
            name: 'TEXTURE_MAG_FILTER',
            value: 'LINEAR'
          }, {
            name: 'TEXTURE_MIN_FILTER',
            value: 'LINEAR',
            generateMipmap: false
          }]
        },
        bindToRenderBuffer: false
      };

      app.setFrameBuffer('main', fboOpt)
         .setFrameBuffer('main2', fboOpt);
		
      timer = setInterval(fr, 500);
      time = Date.now();
      animation = "animate";
      anim();
      
      function draw() {
        // advance
        if (it > 0) {
          Media.Image.postProcess({
            width: sizeX,
            height: sizeY,
            fromTexture: 'main-texture',
            toFrameBuffer: 'main2',
            program: 'advance',
            uniforms: getUniforms()
          }).postProcess({
            width: viewX,
            height: viewY,
            fromTexture: 'main2-texture',
            toScreen: true,
            program: 'composite',
            uniforms: getUniforms()
          });
        } else {
          Media.Image.postProcess({
            width: sizeX,
            height: sizeY,
            fromTexture: 'main2-texture',
            toFrameBuffer: 'main',
            program: 'advance',
            uniforms: getUniforms()
          }).postProcess({
            width: viewX,
            height: viewY,
            fromTexture: 'main-texture',
            toScreen: true,
            program: 'composite',
            uniforms: getUniforms()
          });
        }
        it = -it;
      }
      
      function getUniforms() {
        return {
          'time': time,
          'mouse': [mouseX, mouseY]
        };
      }

      function anim() {
        if (!halted) {
          draw();
        }
        switch (animation) {
        case "animate":
          setTimeout(function() { Fx.requestAnimationFrame(anim); }, 1);
          break;
        case "reset":
          load();
          break;
        }
      }
      
      function fr() {
        var ti = Date.now();
        time = ti;
      }
    }
  });
}
</script>

</head>
<body onload="load()" onresize="setMaximalSize()">
	<canvas id="c" width="100%" height="100%"></canvas>
	<div id="overlay">
		<b>Progressive Julia Fractal/Attractor - Original work by <a href="http://twitter.com/Flexi23/">Felix Woitzel</a></b>
		<p />
		<span id="fps"></span><br />
		<p />
	</div>
</body>
</html>


