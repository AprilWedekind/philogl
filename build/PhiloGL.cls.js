/*

 Copyright (c) 2011 Sencha Inc. - Author: Nicolas Garcia Belmonte (http://philogb.github.com/)

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.

*/
(function(){function t(w){return document.getElementById(w)}this.PhiloGL=null;(function(){PhiloGL=function(w,r){function s(a,b,f){t.type(b)!="object"&&b.use();var j=a.canvas,k=new PhiloGL.Camera(g.fov,j.width/j.height,g.near,g.far,g);k.update();var m=new PhiloGL.Scene(b,k,i),o={$$family:"app",gl:a,canvas:j,program:b,scene:m,camera:k};d&&PhiloGL.Events.create(o,t.extend(d,{bind:o}));if(h.src.length)new PhiloGL.IO.Textures(b,t.extend(h,{onComplete:function(){f(o)}}));else f(o)}r=t.merge({context:{},
camera:{fov:45,near:0.1,far:500},program:{from:"defaults",vs:"Default",fs:"Default"},scene:{},textures:{src:[]},events:{},onLoad:t.empty,onError:t.empty},r||{});var q=r.context,g=r.camera,d=r.events,h=r.textures,c=t.splat(r.program),i=r.scene;l=PhiloGL.WebGL.getContext(w,q);if(!l){r.onError();return null}var n={defaults:"fromDefaultShaders",ids:"fromShaderIds",sources:"fromShaderSources",uris:"fromShaderURIs"},p=c.length,u=function(){var a=p,b={},f=false;return{onSuccess:function(j,k){b[k.id||p-a]=
j;a--;if(a==0&&!f)s(l,p==1?j:b,function(m){r.onLoad(m)})},onError:function(){a--;r.onError(r.id);f=true}}}();c.forEach(function(a){var b=a.from,f;for(f in n)if(b==f){program=PhiloGL.Program[n[f]](t.extend(u,a));break}if(program)u.onSuccess(program,a)})}})();PhiloGL.unpack=function(){["Vec3","Mat4","Quat","Camera","Program","WebGL","O3D","Scene","Shaders","IO","Events","WorkerGroup","Fx"].forEach(function(w){window[w]=PhiloGL[w]})};PhiloGL.version="1.1.1";var l;t.empty=function(){};t.time=Date.now||
function(){return+new Date};t.uid=function(){var w=t.time();return function(){return w++}}();t.extend=function(w,r){for(var s in r)w[s]=r[s];return w};t.type=function(){var w=Object.prototype.toString;return function(r){var s;s=w.call(r);s=s.substr(8,s.length-9).toLowerCase();if(s!="object")return s;if(r.$$family)return r.$$family;return r&&r.nodeName&&r.nodeType==1?"element":s}}();(function(){function w(r){var s=t.type(r);if(s=="object"){s={};for(var q in r)s[q]=w(r[q]);return s}else if(s=="array"){s=
[];q=0;for(var g=r.length;q<g;q++)s[q]=w(r[q]);return s}else return r}t.merge=function(){for(var r={},s=0,q=arguments.length;s<q;s++){var g=arguments[s];if(t.type(g)=="object")for(var d in g){var h=g[d],c=r[d];r[d]=c&&t.type(h)=="object"&&t.type(c)=="object"?t.merge(c,h):w(h)}}return r}})();t.splat=function(){var w=Array.isArray;return function(r){return w(r)&&r||[r]}}();(function(){var w=Math.sqrt,r=Math.sin,s=Math.cos,q=Math.tan,g=Math.PI,d=Array.prototype.slice,h=function(a,b,f){this.x=a||0;this.y=
b||0;this.z=f||0},c={setVec3:function(a,b){a.x=b.x;a.y=b.y;a.z=b.z;return a},set:function(a,b,f,j){a.x=b;a.y=f;a.z=j;return a},add:function(a,b){return new h(a.x+b.x,a.y+b.y,a.z+b.z)},$add:function(a,b){a.x+=b.x;a.y+=b.y;a.z+=b.z;return a},add2:function(a,b,f){a.x=b.x+f.x;a.y=b.y+f.y;a.z=b.z+f.z;return a},sub:function(a,b){return new h(a.x-b.x,a.y-b.y,a.z-b.z)},$sub:function(a,b){a.x-=b.x;a.y-=b.y;a.z-=b.z;return a},sub2:function(a,b,f){a.x=b.x-f.x;a.y=b.y-f.y;a.z=b.z-f.z;return a},scale:function(a,
b){return new h(a.x*b,a.y*b,a.z*b)},$scale:function(a,b){a.x*=b;a.y*=b;a.z*=b;return a},neg:function(a){return new h(-a.x,-a.y,-a.z)},$neg:function(a){a.x=-a.x;a.y=-a.y;a.z=-a.z;return a},unit:function(a){var b=h.norm(a);if(b>0)return h.scale(a,1/b);return h.clone(a)},$unit:function(a){var b=h.norm(a);if(b>0)return h.$scale(a,1/b);return a},cross:function(a,b){var f=a.x,j=a.y,k=a.z,m=b.x,o=b.y,v=b.z;return new h(j*v-k*o,k*m-f*v,f*o-j*m)},$cross:function(a,b){var f=a.x,j=a.y,k=a.z,m=b.x,o=b.y,v=b.z;
a.x=j*v-k*o;a.y=k*m-f*v;a.z=f*o-j*m;return a},distTo:function(a,b){var f=a.x-b.x,j=a.y-b.y,k=a.z-b.z;return w(f*f,j*j,k*k)},distToSq:function(a,b){var f=a.x-b.x,j=a.y-b.y,k=a.z-b.z;return f*f+j*j+k*k},norm:function(a){var b=a.x,f=a.y;a=a.z;return w(b*b+f*f+a*a)},normSq:function(a){var b=a.x,f=a.y;a=a.z;return b*b+f*f+a*a},dot:function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z},clone:function(a){return new h(a.x,a.y,a.z)}},i=h.prototype={},n;for(n in c){h[n]=c[n];i[n]=function(a){return function(){var b=
d.call(arguments);b.unshift(this);return h[a].apply(h,b)}}(n)}var p=function(a,b,f,j,k,m,o,v,x,y,z,H,E,F,B,D){typeof a=="number"?this.set(a,b,f,j,k,m,o,v,x,y,z,H,E,F,B,D):this.id()};c={id:function(a){a.n11=a.n22=a.n33=a.n44=1;a.n12=a.n13=a.n14=0;a.n21=a.n23=a.n24=0;a.n31=a.n32=a.n34=0;a.n41=a.n42=a.n43=0;return a},set:function(a,b,f,j,k,m,o,v,x,y,z,H,E,F,B,D,G){a.n11=b;a.n12=f;a.n13=j;a.n14=k;a.n21=m;a.n22=o;a.n23=v;a.n24=x;a.n31=y;a.n32=z;a.n33=H;a.n34=E;a.n41=F;a.n42=B;a.n43=D;a.n44=G;return a},
mulVec3:function(a,b){var f=b.x,j=b.y,k=b.z;return new h(a.n11*f+a.n12*j+a.n13*k+a.n14,a.n21*f+a.n22*j+a.n23*k+a.n24,a.n31*f+a.n32*j+a.n33*k+a.n34)},$mulVec3:function(a,b){var f=b.x,j=b.y,k=b.z;b.x=a.n11*f+a.n12*j+a.n13*k+a.n14;b.y=a.n21*f+a.n22*j+a.n23*k+a.n24;b.z=a.n31*f+a.n32*j+a.n33*k+a.n34;return b},mulMat42:function(a,b,f){var j=b.n11,k=b.n12,m=b.n13,o=b.n14,v=b.n21,x=b.n22,y=b.n23,z=b.n24,H=b.n31,E=b.n32,F=b.n33,B=b.n34,D=b.n41,G=b.n42,C=b.n43;b=b.n44;var I=f.n11,J=f.n12,K=f.n13,L=f.n14,M=
f.n21,N=f.n22,O=f.n23,P=f.n24,Q=f.n31,R=f.n32,S=f.n33,A=f.n34,U=f.n41,V=f.n42,W=f.n43;f=f.n44;a.n11=j*I+k*M+m*Q+o*U;a.n12=j*J+k*N+m*R+o*V;a.n13=j*K+k*O+m*S+o*W;a.n14=j*L+k*P+m*A+o*f;a.n21=v*I+x*M+y*Q+z*U;a.n22=v*J+x*N+y*R+z*V;a.n23=v*K+x*O+y*S+z*W;a.n24=v*L+x*P+y*A+z*f;a.n31=H*I+E*M+F*Q+B*U;a.n32=H*J+E*N+F*R+B*V;a.n33=H*K+E*O+F*S+B*W;a.n34=H*L+E*P+F*A+B*f;a.n41=D*I+G*M+C*Q+b*U;a.n42=D*J+G*N+C*R+b*V;a.n43=D*K+G*O+C*S+b*W;a.n44=D*L+G*P+C*A+b*f;return a},mulMat4:function(a,b){var f=a.n11,j=a.n12,k=a.n13,
m=a.n14,o=a.n21,v=a.n22,x=a.n23,y=a.n24,z=a.n31,H=a.n32,E=a.n33,F=a.n34,B=a.n41,D=a.n42,G=a.n43,C=a.n44,I=b.n11,J=b.n12,K=b.n13,L=b.n14,M=b.n21,N=b.n22,O=b.n23,P=b.n24,Q=b.n31,R=b.n32,S=b.n33,A=b.n34,U=b.n41,V=b.n42,W=b.n43,X=b.n44,T=new p;T.n11=f*I+j*M+k*Q+m*U;T.n12=f*J+j*N+k*R+m*V;T.n13=f*K+j*O+k*S+m*W;T.n14=f*L+j*P+k*A+m*X;T.n21=o*I+v*M+x*Q+y*U;T.n22=o*J+v*N+x*R+y*V;T.n23=o*K+v*O+x*S+y*W;T.n24=o*L+v*P+x*A+y*X;T.n31=z*I+H*M+E*Q+F*U;T.n32=z*J+H*N+E*R+F*V;T.n33=z*K+H*O+E*S+F*W;T.n34=z*L+H*P+E*A+F*
X;T.n41=B*I+D*M+G*Q+C*U;T.n42=B*J+D*N+G*R+C*V;T.n43=B*K+D*O+G*S+C*W;T.n44=B*L+D*P+G*A+C*X;return T},$mulMat4:function(a,b){var f=a.n11,j=a.n12,k=a.n13,m=a.n14,o=a.n21,v=a.n22,x=a.n23,y=a.n24,z=a.n31,H=a.n32,E=a.n33,F=a.n34,B=a.n41,D=a.n42,G=a.n43,C=a.n44,I=b.n11,J=b.n12,K=b.n13,L=b.n14,M=b.n21,N=b.n22,O=b.n23,P=b.n24,Q=b.n31,R=b.n32,S=b.n33,A=b.n34,U=b.n41,V=b.n42,W=b.n43,X=b.n44;a.n11=f*I+j*M+k*Q+m*U;a.n12=f*J+j*N+k*R+m*V;a.n13=f*K+j*O+k*S+m*W;a.n14=f*L+j*P+k*A+m*X;a.n21=o*I+v*M+x*Q+y*U;a.n22=o*
J+v*N+x*R+y*V;a.n23=o*K+v*O+x*S+y*W;a.n24=o*L+v*P+x*A+y*X;a.n31=z*I+H*M+E*Q+F*U;a.n32=z*J+H*N+E*R+F*V;a.n33=z*K+H*O+E*S+F*W;a.n34=z*L+H*P+E*A+F*X;a.n41=B*I+D*M+G*Q+C*U;a.n42=B*J+D*N+G*R+C*V;a.n43=B*K+D*O+G*S+C*W;a.n44=B*L+D*P+G*A+C*X;return a},add:function(a,b){var f=new p;f.n11=a.n11+b.n11;f.n12=a.n12+b.n12;f.n13=a.n13+b.n13;f.n14=a.n14+b.n14;f.n21=a.n21+b.n21;f.n22=a.n22+b.n22;f.n23=a.n23+b.n23;f.n24=a.n24+b.n24;f.n31=a.n31+b.n31;f.n32=a.n32+b.n32;f.n33=a.n33+b.n33;f.n34=a.n34+b.n34;f.n41=a.n41+
b.n41;f.n42=a.n42+b.n42;f.n43=a.n43+b.n43;f.n44=a.n44+b.n44;return f},$add:function(a,b){a.n11+=b.n11;a.n12+=b.n12;a.n13+=b.n13;a.n14+=b.n14;a.n21+=b.n21;a.n22+=b.n22;a.n23+=b.n23;a.n24+=b.n24;a.n31+=b.n31;a.n32+=b.n32;a.n33+=b.n33;a.n34+=b.n34;a.n41+=b.n41;a.n42+=b.n42;a.n43+=b.n43;a.n44+=b.n44;return a},transpose:function(a){return new p(a.n11,a.n21,a.n31,a.n41,a.n12,a.n22,a.n32,a.n42,a.n13,a.n23,a.n33,a.n43,a.n14,a.n24,a.n34,a.n44)},$transpose:function(a){return p.set(a,a.n11,a.n21,a.n31,a.n41,
a.n12,a.n22,a.n32,a.n42,a.n13,a.n23,a.n33,a.n43,a.n14,a.n24,a.n34,a.n44)},rotateAxis:function(a,b,f){var j=r(b);b=s(b);var k=1-b,m=f.x,o=f.y;f=f.z;j=new p(m*m*k+b,m*o*k-f*j,m*f*k+o*j,0,o*m*k+f*j,o*o*k+b,o*f*k-m*j,0,m*f*k-o*j,o*f*k+m*j,f*f*k+b,0,0,0,0,1);return p.mulMat4(a,j)},$rotateAxis:function(a,b,f){var j=r(b);b=s(b);var k=1-b,m=f.x,o=f.y;f=f.z;j=new p(m*m*k+b,m*o*k-f*j,m*f*k+o*j,0,o*m*k+f*j,o*o*k+b,o*f*k-m*j,0,m*f*k-o*j,o*f*k+m*j,f*f*k+b,0,0,0,0,1);return p.$mulMat4(a,j)},rotateXYZ:function(a,
b,f,j){b=new p(s(f)*s(j),-s(b)*r(j)+r(b)*r(f)*s(j),r(b)*r(j)+s(b)*r(f)*s(j),0,s(f)*r(j),s(b)*s(j)+r(b)*r(f)*r(j),-r(b)*s(j)+s(b)*r(f)*r(j),0,-r(f),r(b)*s(f),s(b)*s(f),0,0,0,0,1);return p.mulMat4(a,b)},$rotateXYZ:function(a,b,f,j){b=new p(s(f)*s(j),-s(b)*r(j)+r(b)*r(f)*s(j),r(b)*r(j)+s(b)*r(f)*s(j),0,s(f)*r(j),s(b)*s(j)+r(b)*r(f)*r(j),-r(b)*s(j)+s(b)*r(f)*r(j),0,-r(f),r(b)*s(f),s(b)*s(f),0,0,0,0,1);return p.$mulMat4(a,b)},translate:function(a,b,f,j){b=new p(1,0,0,b,0,1,0,f,0,0,1,j,0,0,0,1);return p.mulMat4(a,
b)},$translate:function(a,b,f,j){b=new p(1,0,0,b,0,1,0,f,0,0,1,j,0,0,0,1);return p.$mulMat4(a,b)},scale:function(a,b,f,j){b=new p(b,0,0,0,0,f,0,0,0,0,j,0,0,0,0,1);return p.mulMat4(a,b)},$scale:function(a,b,f,j){b=new p(b,0,0,0,0,f,0,0,0,0,j,0,0,0,0,1);return p.$mulMat4(a,b)},invert:function(a){var b=new p,f=a.n11,j=a.n12,k=a.n13,m=a.n14,o=a.n21,v=a.n22,x=a.n23,y=a.n24,z=a.n31,H=a.n32,E=a.n33,F=a.n34,B=a.n41,D=a.n42,G=a.n43;a=a.n44;var C=f*v-j*o,I=f*x-k*o,J=f*y-m*o,K=j*x-k*v,L=j*y-m*v,M=k*y-m*x,N=
z*D-H*B,O=z*G-E*B,P=z*a-F*B,Q=H*G-E*D,R=H*a-F*D,S=E*a-F*G,A=1/(C*S-I*R+J*Q+K*P-L*O+M*N);b.n11=(+v*S-x*R+y*Q)*A;b.n12=(-j*S+k*R-m*Q)*A;b.n13=(+D*M-G*L+a*K)*A;b.n14=(-H*M+E*L-F*K)*A;b.n21=(-o*S+x*P-y*O)*A;b.n22=(+f*S-k*P+m*O)*A;b.n23=(-B*M+G*J-a*I)*A;b.n24=(+z*M-E*J+F*I)*A;b.n31=(+o*R-v*P+y*N)*A;b.n32=(-f*R+j*P-m*N)*A;b.n33=(+B*L-D*J+a*C)*A;b.n34=(-z*L+H*J-F*C)*A;b.n41=(-o*Q+v*O-x*N)*A;b.n42=(+f*Q-j*O+k*N)*A;b.n43=(-B*K+D*I-G*C)*A;b.n44=(+z*K-H*I+E*C)*A;return b},$invert:function(a){var b=a.n11,f=a.n12,
j=a.n13,k=a.n14,m=a.n21,o=a.n22,v=a.n23,x=a.n24,y=a.n31,z=a.n32,H=a.n33,E=a.n34,F=a.n41,B=a.n42,D=a.n43,G=a.n44,C=b*o-f*m,I=b*v-j*m,J=b*x-k*m,K=f*v-j*o,L=f*x-k*o,M=j*x-k*v,N=y*B-z*F,O=y*D-H*F,P=y*G-E*F,Q=z*D-H*B,R=z*G-E*B,S=H*G-E*D,A=1/(C*S-I*R+J*Q+K*P-L*O+M*N);a.n11=(+o*S-v*R+x*Q)*A;a.n12=(-f*S+j*R-k*Q)*A;a.n13=(+B*M-D*L+G*K)*A;a.n14=(-z*M+H*L-E*K)*A;a.n21=(-m*S+v*P-x*O)*A;a.n22=(+b*S-j*P+k*O)*A;a.n23=(-F*M+D*J-G*I)*A;a.n24=(+y*M-H*J+E*I)*A;a.n31=(+m*R-o*P+x*N)*A;a.n32=(-b*R+f*P-k*N)*A;a.n33=(+F*
L-B*J+G*C)*A;a.n34=(-y*L+z*J-E*C)*A;a.n41=(-m*Q+o*O-v*N)*A;a.n42=(+b*Q-f*O+j*N)*A;a.n43=(-F*K+B*I-D*C)*A;a.n44=(+y*K-z*I+H*C)*A;return a},lookAt:function(a,b,f,j){f=h.sub(b,f);f.$unit();j=h.cross(j,f);j.$unit();var k=h.cross(f,j);k.$unit();return p.set(a,j.x,j.y,j.z,-j.dot(b),k.x,k.y,k.z,-k.dot(b),f.x,f.y,f.z,-f.dot(b),0,0,0,1)},frustum:function(a,b,f,j,k,m,o){return p.set(a,2*m/(f-b),0,(f+b)/(f-b),0,0,2*m/(k-j),(k+j)/(k-j),0,0,0,-(o+m)/(o-m),-2*o*m/(o-m),0,0,-1,0)},perspective:function(a,b,f,j,k){b=
j*q(b*g/360);var m=-b;return p.frustum(a,m*f,b*f,m,b,j,k)},ortho:function(a,b,f,j,k,m,o){var v=f-b,x=k-j,y=o-m;return p.set(a,2/v,0,0,-((f+b)/v),0,2/x,0,-((k+j)/x),0,0,-2/y,-((o+m)/y),0,0,0,1)},toFloat32Array:function(a){return new Float32Array([a.n11,a.n21,a.n31,a.n41,a.n12,a.n22,a.n32,a.n42,a.n13,a.n23,a.n33,a.n43,a.n14,a.n24,a.n34,a.n44])}};i=p.prototype={};for(n in c){p[n]=c[n];i[n]=function(a){return function(){var b=d.call(arguments);b.unshift(this);return p[a].apply(p,b)}}(n)}var u=function(a,
b,f,j){this.x=a||0;this.y=b||0;this.z=f||0;this.w=j||0};c={setQuat:function(a,b){a.x=b.x;a.y=b.y;a.z=b.z;a.w=b.w;return a},set:function(a,b,f,j,k){a.x=b||0;a.y=f||0;a.z=j||0;a.w=k||0;return a},clone:function(a){return new u(a.x,a.y,a.z,a.w)},neg:function(a){return new u(-a.x,-a.y,-a.z,-a.w)},$neg:function(a){a.x=-a.x;a.y=-a.y;a.z=-a.z;a.w=-a.w;return a},add:function(a,b){return new u(a.x+b.x,a.y+b.y,a.z+b.z,a.w+b.w)},$add:function(a,b){a.x+=b.x;a.y+=b.y;a.z+=b.z;a.w+=b.w;return a},sub:function(a,
b){return new u(a.x-b.x,a.y-b.y,a.z-b.z,a.w-b.w)},$sub:function(a,b){a.x-=b.x;a.y-=b.y;a.z-=b.z;a.w-=b.w;return a},scale:function(a,b){return new u(a.x*b,a.y*b,a.z*b,a.w*b)},$scale:function(a,b){a.x*=b;a.y*=b;a.z*=b;a.w*=b;return a},mulQuat:function(a,b){var f=a.x,j=a.y,k=a.z,m=a.w,o=b.x,v=b.y,x=b.z,y=b.w;return new u(m*o+f*y+j*x-k*v,m*v+j*y+k*o-f*x,m*x+k*y+f*v-j*o,m*y-f*o-j*v-k*x)},$mulQuat:function(a,b){var f=a.x,j=a.y,k=a.z,m=a.w,o=b.x,v=b.y,x=b.z,y=b.w;a.a=m*o+f*y+j*x-k*v;a.b=m*v+j*y+k*o-f*x;
a.c=m*x+k*y+f*v-j*o;a.d=m*y-f*o-j*v-k*x;return a},divQuat:function(a,b){var f=a.x,j=a.y,k=a.z,m=a.w,o=b.x,v=b.y,x=b.z,y=b.w,z=1/(y*y+o*o+v*v+x*x);return new u((f*y-m*o-j*x+k*v)*z,(f*x-m*v+j*y-k*o)*z,(j*o+k*y-m*x-f*v)*z,(m*y+f*o+j*v+k*x)*z)},$divQuat:function(a,b){var f=a.x,j=a.y,k=a.z,m=a.w,o=b.x,v=b.y,x=b.z,y=b.w,z=1/(y*y+o*o+v*v+x*x);a.a=(f*y-m*o-j*x+k*v)*z;a.b=(f*x-m*v+j*y-k*o)*z;a.c=(j*o+k*y-m*x-f*v)*z;a.d=(m*y+f*o+j*v+k*x)*z;return a},invert:function(a){var b=a.x,f=a.y,j=a.z;a=a.w;var k=1/(b*
b+f*f+j*j+a*a);return new u(-b*k,-f*k,-j*k,a*k)},$invert:function(a){var b=a.x,f=a.y,j=a.z,k=a.w,m=1/(b*b+f*f+j*j+k*k);a.a=-b*m;a.b=-f*m;a.c=-j*m;a.d=k*m;return a},norm:function(a){var b=a.x,f=a.y,j=a.z;a=a.w;return w(b*b+f*f+j*j+a*a)},normSq:function(a){var b=a.x,f=a.y,j=a.z;a=a.w;return b*b+f*f+j*j+a*a},unit:function(a){return u.scale(a,1/u.norm(a))},$unit:function(a){return u.$scale(a,1/u.norm(a))},conjugate:function(a){return new u(-a.x,-a.y,-a.z,a.w)},$conjugate:function(a){a.x=-a.x;a.y=-a.y;
a.z=-a.z;return a}};i=u.prototype={};for(n in c){u[n]=c[n];i[n]=function(a){return function(){var b=d.call(arguments);b.unshift(this);return u[a].apply(u,b)}}(n)}h.fromQuat=function(a){return new h(a.x,a.y,a.z)};u.fromVec3=function(a,b){return new u(a.x,a.y,a.z,b||0)};u.fromMat4=function(a){var b,f,j;if(a.n11>a.n22&&a.n11>a.n33){b=0;f=1;j=2}else if(a.n22>a.n11&&a.n22>a.n33){b=1;f=2;j=0}else{b=2;f=0;j=1}var k=w(1+a["n"+b+""+b]-a["n"+f+""+f]-a["n"+j+""+j]),m=new u,o=["x","y","z"];m[o[b]]=0.5*k;m[o[f]]=
0.5*(a["n"+f+""+b]+a["n"+b+""+f])/k;m[o[j]]=0.5*(a["n"+b+""+j]+a["n"+j+""+b])/k;m.w=0.5*(a["n"+f+""+j]-a["n"+j+""+f])/k;return m};u.fromXRotation=function(a){return new u(r(a/2),0,0,s(a/2))};u.fromYRotation=function(a){return new u(0,r(a/2),0,s(a/2))};u.fromZRotation=function(a){return new u(0,0,r(a/2),s(a/2))};u.fromAxisRotation=function(a,b){var f=a.x,j=a.y,k=a.z,m=1/w(f*f+j*j+k*k),o=r(b/2),v=s(b/2);return new u(o*f*m,o*j*m,o*k*m,v)};p.fromQuat=function(a){var b=a.w,f=a.x,j=a.y;a=a.z;return new p(b*
b+f*f-j*j-a*a,2*f*j-2*b*a,2*f*a+2*b*j,0,2*f*j+2*b*a,b*b-f*f+j*j-a*a,2*j*a-2*b*f,0,2*f*a-2*b*j,2*j*a+2*b*f,b*b-f*f-j*j+a*a,0,0,0,0,1)};PhiloGL.Vec3=h;PhiloGL.Mat4=p;PhiloGL.Quat=u})();(function(){function w(d){return d!==true?d:false}var r=function(d){var h=function(c){for(var i={x:0,y:0};c&&!/^(?:body|html)$/i.test(c.tagName);){i.x+=c.offsetLeft;i.y+=c.offsetTop;c=c.offsetParent}return i}(d);d=function(c){for(var i={x:0,y:0};c&&!/^(?:body|html)$/i.test(c.tagName);){i.x+=c.scrollLeft;i.y+=c.scrollTop;
c=c.parentNode}return i}(d);return{x:h.x-d.x,y:h.y-d.y}},s={get:function(d,h){return d||(h||window).event},getWheel:function(d){return d.wheelDelta?d.wheelDelta/120:-(d.detail||0)/3},getKey:function(d){var h=d.which||d.keyCode,c;a:{c=g.Keys;for(var i in c)if(c[i]==h){c=i;break a}c=void 0}i=h-111;if(i>0&&i<13)c="f"+i;c=c||String.fromCharCode(h).toLowerCase();return{code:h,key:c,shift:d.shiftKey,control:d.ctrlKey,alt:d.altKey,meta:d.metaKey}},isRightClick:function(d){return d.which==3||d.button==2},
getPos:function(d,h){h=h||window;d=d||h.event;var c=h.document;c=c.documentElement||c.body;if(d.touches&&d.touches.length)d=d.touches[0];return{x:d.pageX||d.clientX+c.scrollLeft,y:d.pageY||d.clientY+c.scrollTop}},stop:function(d){d.stopPropagation&&d.stopPropagation();d.cancelBubble=true;if(d.preventDefault)d.preventDefault();else d.returnValue=false}},q=function(d,h){var c=d.canvas;this.scene=d.scene;this.domElem=c;this.pos=r(c);this.opt=this.callbacks=h;this.size={width:c.width||c.offsetWidth,height:c.height||
c.offsetHeight};this.attachEvents()};q.prototype={hovered:false,pressed:false,touched:false,touchMoved:false,moved:false,attachEvents:function(){var d=this.domElem,h=this;if(this.opt.disableContextMenu)d.oncontextmenu=function(){return false};["mouseup","mousedown","mousemove","mouseover","mouseout","touchstart","touchmove","touchend"].forEach(function(i){d.addEventListener(i,function(n,p){h[i](h.eventInfo(i,n,p))},false)});["keydown","keyup"].forEach(function(i){document.addEventListener(i,function(n,
p){h[i](h.eventInfo(i,n,p))},false)});var c="";c=!document.getBoxObjectFor&&window.mozInnerScreenX==null?"mousewheel":"DOMMouseScroll";d.addEventListener(c,function(i,n){h.mousewheel(h.eventInfo("mousewheel",i,n))},false)},eventInfo:function(d,h,c){var i=this.domElem,n=this.scene,p=this.opt,u=this.getSize(),a=p.relative,b=p.centerOrigin,f=p.cachePosition&&this.pos||r(i),j=s.get(h,c),k=s.getPos(h,c);h={};c=k.x;i=k.y;if(a){c-=f.x;i-=f.y;if(b){c-=u.width/2;i-=u.height/2;i*=-1}}switch(d){case "mousewheel":h.wheel=
s.getWheel(j);break;case "keydown":t.extend(h,s.getKey(j));break;case "mouseup":h.isRightClick=s.isRightClick(j)}var m;t.extend(h,{x:c,y:i,cache:false,stop:function(){s.stop(j)},getTarget:function(){if(m)return m;return m=!p.picking||n.pick(k.x-f.x,k.y-f.y)||true}});h.event=j;return h},getSize:function(){if(this.cacheSize)return this.size;var d=this.domElem;return{width:d.width||d.offsetWidth,height:d.height||d.offsetHeight}},mouseup:function(d){if(!this.moved)if(d.isRightClick)this.callbacks.onRightClick(d,
this.hovered);else this.callbacks.onClick(d,w(this.pressed));if(this.pressed){if(this.moved)this.callbacks.onDragEnd(d,w(this.pressed));else this.callbacks.onDragCancel(d,w(this.pressed));this.pressed=this.moved=false}},mouseout:function(d){for(var h=d.relatedTarget,c=this.domElem;h&&h.parentNode;){if(c==h.parentNode)return;h=h.parentNode}if(this.hovered){this.callbacks.onMouseLeave(d,this.hovered);this.hovered=false}},mouseover:function(){},mousemove:function(d){if(this.pressed){this.moved=true;
this.callbacks.onDragMove(d,w(this.pressed))}else if(this.hovered){var h=w(d.getTarget());if(this.hovered!=h){this.callbacks.onMouseLeave(d,this.hovered);if(this.hovered=h)this.callbacks.onMouseEnter(d,this.hovered)}else this.callbacks.onMouseMove(d,this.hovered)}else if(this.hovered=w(d.getTarget()))this.callbacks.onMouseEnter(d,this.hovered)},mousewheel:function(d){this.callbacks.onMouseWheel(d)},mousedown:function(d){this.pressed=d.getTarget();this.callbacks.onDragStart(d,w(this.pressed))},touchstart:function(d){this.touched=
d.getTarget();this.callbacks.onTouchStart(d,w(this.touched))},touchmove:function(d){if(this.touched){this.touchMoved=true;this.callbacks.onTouchMove(d,w(this.touched))}},touchend:function(d){if(this.touched){if(this.touchMoved)this.callbacks.onTouchEnd(d,w(this.touched));else this.callbacks.onTouchCancel(d,w(this.touched));this.touched=this.touchMoved=false}},keydown:function(d){this.callbacks.onKeyDown(d)},keyup:function(d){this.callbacks.onKeyUp(d)}};var g={};g.create=function(d,h){h=t.merge({cachePosition:true,
cacheSize:true,relative:true,centerOrigin:true,disableContextMenu:true,bind:false,picking:false,onClick:t.empty,onRightClick:t.empty,onDragStart:t.empty,onDragMove:t.empty,onDragEnd:t.empty,onDragCancel:t.empty,onTouchStart:t.empty,onTouchMove:t.empty,onTouchEnd:t.empty,onTouchCancel:t.empty,onMouseMove:t.empty,onMouseEnter:t.empty,onMouseLeave:t.empty,onMouseWheel:t.empty,onKeyDown:t.empty,onKeyUp:t.empty},h||{});var c=h.bind;if(c)for(var i in h)i.match(/^on[a-zA-Z0-9]+$/)&&function(n,p){h[n]=function(){return p.apply(c,
Array.prototype.slice.call(arguments))}}(i,h[i]);new q(d,h)};g.Keys={enter:13,up:38,down:40,left:37,right:39,esc:27,space:32,backspace:8,tab:9,"delete":46};PhiloGL.Events=g})();(function(){function w(){return arguments.length==2?{vs:arguments[0],fs:arguments[1]}:arguments[0]||{}}var r=function(g,d,h){var c=g.createShader(h);if(c==null)throw"Error creating the shader with shader type: "+h;g.shaderSource(c,d);g.compileShader(c);if(!g.getShaderParameter(c,g.COMPILE_STATUS)){d=g.getShaderInfoLog(c);g.deleteShader(c);
throw"Error while compiling the shader "+d;}return c},s=function(g,d,h){var c=l.getUniformLocation(g,d.name);g=d.type;if(d.size>1&&h)switch(g){case l.FLOAT:return function(i){l.uniform1fv(c,new Float32Array(i))};case l.INT:case l.BOOL:return function(i){l.uniform1iv(c,new Uint16Array(i))}}switch(g){case l.FLOAT:return function(i){l.uniform1f(c,i)};case l.FLOAT_VEC2:return function(i){l.uniform2fv(c,new Float32Array(i))};case l.FLOAT_VEC3:return function(i){l.uniform3fv(c,new Float32Array(i))};case l.FLOAT_VEC4:return function(i){l.uniform4fv(c,
new Float32Array(i))};case l.INT:case l.BOOL:case l.SAMPLER_2D:case l.SAMPLER_CUBE:return function(i){l.uniform1i(c,i)};case l.INT_VEC2:case l.BOOL_VEC2:return function(i){l.uniform2iv(c,new Uint16Array(i))};case l.INT_VEC3:case l.BOOL_VEC3:return function(i){l.uniform3iv(c,new Uint16Array(i))};case l.INT_VEC4:case l.BOOL_VEC4:return function(i){l.uniform4iv(c,new Uint16Array(i))};case l.FLOAT_MAT2:return function(i){l.uniformMatrix2fv(c,false,i.toFloat32Array())};case l.FLOAT_MAT3:return function(i){l.uniformMatrix3fv(c,
false,i.toFloat32Array())};case l.FLOAT_MAT4:return function(i){l.uniformMatrix4fv(c,false,i.toFloat32Array())}}throw"Unknown type: "+g;},q=function(g,d){var h=l,c=h.createProgram();h.attachShader(c,r(h,g,h.VERTEX_SHADER));h.attachShader(c,r(h,d,h.FRAGMENT_SHADER));h.linkProgram(c);if(!h.getProgramParameter(c,h.LINK_STATUS))throw"Error linking the shader: "+h.getProgramInfoLog(c);if(!c)return false;h={};for(var i={},n=l.getProgramParameter(c,l.ACTIVE_ATTRIBUTES),p=0;p<n;p++){var u=l.getActiveAttrib(c,
p),a=u.name;u=l.getAttribLocation(c,u.name);h[a]=u}n=l.getProgramParameter(c,l.ACTIVE_UNIFORMS);for(p=0;p<n;p++){u=l.getActiveUniform(c,p);a=u.name;a=a[a.length-1]=="]"?a.substr(0,a.length-3):a;i[a]=s(c,u,u.name!=a)}this.program=c;this.attributes=h;this.uniforms=i;this.buffers={};this.bufferMemo={};this.frameBuffers={};this.frameBufferMemo={};this.renderBuffers={};this.renderBufferMemo={};this.textures={};this.textureMemo={}};q.prototype={$$family:"program",setState:function(g){t.extend(g.buffers,
this.buffers);t.extend(g.bufferMemo,this.bufferMemo);t.extend(g.renderBuffers,this.renderBuffers);t.extend(g.renderBufferMemo,this.renderBufferMemo);t.extend(g.frameBuffers,this.frameBuffers);t.extend(g.frameBufferMemo,this.frameBufferMemo);t.extend(g.textures,this.textures);t.extend(g.textureMemo,this.textureMemo);return this},setUniform:function(g,d){if(this.uniforms[g])this.uniforms[g](d);return this},setUniforms:function(g){for(var d in g)this.setUniform(d,g[d]);return this},setBuffer:function(g,
d){if(d===false||d===null){(d=this.bufferMemo[g])&&l.bindBuffer(d.bufferType,null);var h=d&&d.attribute||g,c=this.attributes[h];c!==undefined&&l.disableVertexAttribArray(c)}else{d=t.merge({bufferType:l.ARRAY_BUFFER,size:1,dataType:l.FLOAT,stride:0,offset:0,drawType:l.STATIC_DRAW},this.bufferMemo[g]||{},d||{});h=d.attribute||g;var i=d.bufferType,n=g in this.buffers,p=n?this.buffers[g]:l.createBuffer(),u="value"in d,a=d.value,b=d.size,f=d.dataType,j=d.stride,k=d.offset,m=d.drawType;c=this.attributes[h];
var o=c!==undefined;n||(this.buffers[g]=p);o&&l.enableVertexAttribArray(c);l.bindBuffer(i,p);u&&l.bufferData(i,a,m);o&&l.vertexAttribPointer(c,b,f,false,j,k);delete d.value;this.bufferMemo[g]=d;if(o)this.bufferMemo[h]=d;return this}},setBuffers:function(g){for(var d in g)this.setBuffer(d,g[d]);return this},setFrameBuffer:function(g,d){if(typeof d!="object")l.bindFramebuffer(l.FRAMEBUFFER,d?this.frameBuffers[g]:null);else{d=t.merge({width:0,height:0,bindToTexture:false,textureOptions:{attachment:l.COLOR_ATTACHMENT0},
bindToRenderBuffer:false,renderBufferOptions:{attachment:l.DEPTH_ATTACHMENT}},this.frameBufferMemo[g]||{},d||{});var h=d.bindToTexture,c=d.bindToRenderBuffer,i=g in this.frameBuffers,n=i?this.frameBuffers[g]:l.createFramebuffer(l.FRAMEBUFFER);l.bindFramebuffer(l.FRAMEBUFFER,n);i||(this.frameBuffers[g]=n);if(h){h=t.merge({data:{width:d.width,height:d.height}},t.type(h)=="object"?h:{});i=g+"-texture";n=d.textureOptions;this.setTexture(i,h);l.framebufferTexture2D(l.FRAMEBUFFER,n.attachment,this.textureMemo[i].textureType,
this.textures[i],0)}if(c){c=t.merge({width:d.width,height:d.height},t.type(c)=="object"?c:{});h=g+"-renderbuffer";i=d.renderBufferOptions;this.setRenderBuffer(h,c);l.framebufferRenderbuffer(l.FRAMEBUFFER,i.attachment,l.RENDERBUFFER,this.renderBuffers[h])}l.bindTexture(l.TEXTURE_2D,null);l.bindRenderbuffer(l.RENDERBUFFER,null);l.bindFramebuffer(l.FRAMEBUFFER,null);this.frameBufferMemo[g]=d;return this}},setFrameBuffers:function(g){for(var d in g)this.setFrameBuffer(d,g[d]);return this},setRenderBuffer:function(g,
d){if(typeof d!="object")l.bindRenderbuffer(l.RENDERBUFFER,d?this.renderBufferMemo[g]:null);else{d=t.merge({storageType:l.DEPTH_COMPONENT16,width:0,height:0},this.renderBufferMemo[g]||{},d||{});var h=g in this.renderBuffers,c=h?this.renderBuffers[g]:l.createRenderbuffer(l.RENDERBUFFER);h||(this.renderBuffers[g]=c);l.bindRenderbuffer(l.RENDERBUFFER,c);l.renderbufferStorage(l.RENDERBUFFER,d.storageType,d.width,d.height);this.renderBufferMemo[g]=d;return this}},setRenderBuffers:function(g){for(var d in g)this.setRenderBuffer(d,
g[d]);return this},setTexture:function(g,d){if(!d||typeof d!="object"){l.activeTexture(d||l.TEXTURE0);l.bindTexture(this.textureMemo[g].textureType||l.TEXTURE_2D,this.textures[g])}else{d=t.merge({textureType:l.TEXTURE_2D,pixelStore:[{name:l.UNPACK_FLIP_Y_WEBGL,value:true}],parameters:[{name:l.TEXTURE_MAG_FILTER,value:l.NEAREST},{name:l.TEXTURE_MIN_FILTER,value:l.NEAREST}],data:{format:l.RGBA,value:false,width:0,height:0,border:0}},this.textureMemo[g]||{},d||{});var h="textureType"in d?d.textureType:
l.TEXTURE_2D,c=g in this.textures,i=c?this.textures[g]:l.createTexture(),n=d.pixelStore,p=d.parameters,u=d.data,a=!!d.data.value;c||(this.textures[g]=i);l.bindTexture(h,i);c||n.forEach(function(b){b.name=typeof b.name=="string"?l[b.name]:b.name;l.pixelStorei(b.name,b.value)});if(a)l.texImage2D(h,0,u.format,u.format,l.UNSIGNED_BYTE,u.value);else if(u.width||u.height)l.texImage2D(h,0,u.format,u.width,u.height,u.border,u.format,l.UNSIGNED_BYTE,null);c||p.forEach(function(b){b.name=l.get(b.name);b.value=
l.get(b.value);l.texParameteri(h,b.name,b.value);b.generateMipmap&&l.generateMipmap(h)});delete d.data;this.textureMemo[g]=d;return this}},setTextures:function(g){for(var d in g)this.setTexture(d,g[d]);return this},use:function(){l.useProgram(this.program);return this}};q.fromShaderIds=function(){var g=w.apply({},arguments),d=t(g.vs);g=t(g.fs);return new q(d.innerHTML,g.innerHTML)};q.fromShaderSources=function(g){g=w.apply({},arguments);return new q(g.vs,g.fs)};q.fromDefaultShaders=function(){var g=
w.apply({},arguments),d=PhiloGL.Shaders;return PhiloGL.Program.fromShaderSources(d.Vertex[g.vs||"Default"],d.Fragment[g.fs||"Default"])};q.fromShaderURIs=function(g){g=t.merge({path:"",vs:"",fs:"",noCache:false,onSuccess:t.empty,onError:t.empty},g||{});var d=g.path+g.fs,h=PhiloGL.IO.XHR;(new h({url:g.path+g.vs,noCache:g.noCache,onError:function(c){g.onError(c)},onSuccess:function(c){(new h({url:d,noCache:g.noCache,onError:function(i){g.onError(i)},onSuccess:function(i){g.onSuccess(q.fromShaderSources(c,
i),g)}})).send()}})).send()};PhiloGL.Program=q})();(function(){var w={},r=function(g){this.opt=g=t.merge({url:"http://sencha.com/",method:"GET",async:true,noCache:false,sendAsBinary:false,onProgress:t.empty,onSuccess:t.empty,onError:t.empty,onAbort:t.empty,onComplete:t.empty},g||{});this.initXHR()};r.State={};["UNINITIALIZED","LOADING","LOADED","INTERACTIVE","COMPLETED"].forEach(function(g,d){r.State[g]=d});r.prototype={initXHR:function(){var g=this.req=new XMLHttpRequest,d=this;["Progress","Error",
"Abort","Load"].forEach(function(h){g.addEventListener(h.toLowerCase(),function(c){d["handle"+h](c)},false)})},send:function(g){var d=this.req,h=this.opt,c=h.async;if(h.noCache)h.url+=(h.url.indexOf("?")>=0?"&":"?")+t.uid();d.open(h.method,h.url,c);if(c)d.onreadystatechange=function(){if(d.readyState==r.State.COMPLETED)if(d.status==200)h.onSuccess(d.responseText);else h.onError(d.status)};h.sendAsBinary?d.sendAsBinary(g||h.body||null):d.send(g||h.body||null);if(!c)if(d.status==200)h.onSuccess(d.responseText);
else h.onError(d.status)},setRequestHeader:function(g,d){this.req.setRequestHeader(g,d);return this},handleProgress:function(g){if(g.lengthComputable)this.opt.onProgress(g,Math.round(g.loaded/g.total*100));else this.opt.onProgress(g,-1)},handleError:function(g){this.opt.onError(g)},handleAbort:function(){this.opt.onAbort(e)},handleLoad:function(g){this.opt.onComplete(g)}};var s=function(g){g=t.merge({url:"http://sencha.com/",data:{},noCache:false,onComplete:t.empty,callbackKey:"callback"},g||{});
var d=s.counter++,h=[],c;for(c in g.data)h.push(c+"="+g.data[c]);h=h.join("&");if(g.noCache)h+=(h.indexOf("?")>=0?"&":"?")+t.uid();h=g.url+(g.url.indexOf("?")>-1?"&":"?")+g.callbackKey+"=PhiloGL.IO.JSONP.requests.request_"+d+(h.length>0?"&"+h:"");var i=document.createElement("script");i.type="text/javascript";i.src=h;s.requests["request_"+d]=function(n){g.onComplete(n);i.parentNode&&i.parentNode.removeChild(i);i.clearAttributes&&i.clearAttributes()};document.getElementsByTagName("head")[0].appendChild(i)};
s.counter=0;s.requests={};var q=function(g){g=t.merge({src:[],noCache:false,onProgress:t.empty,onComplete:t.empty},g||{});var d=0,h=g.src.length,c=function(){g.onProgress(Math.round(++d/h*100));if(d==h)g.onComplete(u)},i=function(){if(++d==h)g.onComplete(u)},n=g.noCache,p=t.uid(),u=g.src.map(function(a,b){var f=new Image;f.index=b;f.onload=c;f.onerror=i;f.src=a+(n?(a.indexOf("?")>=0?"&":"?")+p:"");return f});return u};w.XHR=r;w.JSONP=s;w.Images=q;w.Textures=function(g,d){d=t.merge({src:[],noCache:false,
onComplete:t.empty},d||{});q({src:d.src,noCache:d.noCache,onComplete:function(h){var c={};h.forEach(function(n,p){c[d.src[p]]=t.merge({data:{value:n}},d)});if(t.type(g)=="object")for(var i in g)g[i].setTextures(c);else g.setTextures(c);d.onComplete()}})};PhiloGL.IO=w})();(function(){var w=PhiloGL.Vec3,r=PhiloGL.Mat4,s=function(q,g,d,h,c){c=c||{};var i=c.position,n=c.target;c=c.up;this.near=d;this.far=h;this.position=i&&new w(i.x,i.y,i.z)||new w;this.target=n&&new w(n.x,n.y,n.z)||new w;this.up=c&&
new w(c.x,c.y,c.z)||new w(0,1,0);this.projection=(new r).perspective(q,g,d,h);this.modelView=new r};s.prototype={update:function(){this.modelView.lookAt(this.position,this.target,this.up)}};PhiloGL.Camera=s})();(function(){(function(){try{var w=document.createElement("canvas");PhiloGL.hasWebGL=function(){return!!(window.WebGLRenderingContext&&(w.getContext("webgl")||w.getContext("experimental-webgl")))}}catch(r){PhiloGL.hasWebGL=function(){return false}}})();PhiloGL.WebGL={getContext:function(w,r){w=
typeof w=="string"?t(w):w;var s;(s=w.getContext("experimental-webgl",r))||(s=w.getContext("webgl",r));if(s&&r&&r.debug){l={};for(var q in s){var g=s[q];l[q]=typeof g=="function"?function(d,h){return function(){console.log(d,Array.prototype.join.call(arguments),Array.prototype.slice.call(arguments));try{var c=h.apply(s,arguments)}catch(i){throw d+" "+i;}for(var n=[],p;(p=s.getError())!==s.NO_ERROR;)n.push(p);if(n.length)throw n.join();return c}}(q,g):g}}else l=s;if(l)l.get=function(d){return typeof d==
"string"?l[d]:d};return l}}})();(function(){var w=PhiloGL.Vec3,r=PhiloGL.Mat4,s=Math.cos,q=Math.sin,g=Math.PI,d=function(c){if(c&&c.length&&t.type(c[0])=="array")return[].concat.apply([],c);return c},h={};h.Model=function(c){this.$$family="model";this.pickable=!!c.pickable;this.vertices=d(c.vertices);this.faces=d(c.faces);this.normals=d(c.normals);this.textures=c.textures&&t.splat(c.textures);this.centroids=d(c.centroids);this.colors=d(c.colors);this.indices=d(c.indices);this.shininess=c.shininess||
0;this.uniforms=c.uniforms||{};this.render=c.render;this.drawType=c.drawType;this.display="display"in c?c.display:true;if(c.texCoords)this.texCoords=t.type(c.texCoords)=="object"?c.texCoords:d(c.texCoords);this.onBeforeRender=c.onBeforeRender||t.empty;this.onAfterRender=c.onAfterRender||t.empty;if(c.program)this.program=c.program;this.position=new w;this.rotation=new w;this.scale=new w(1,1,1);this.matrix=new r;this.normalizeColors();c.computeCentroids&&this.computeCentroids();c.computeNormals&&this.computeNormals()};
h.Model.prototype={update:function(){var c=this.matrix,i=this.position,n=this.rotation,p=this.scale;c.id();c.$translate(i.x,i.y,i.z);c.$rotateXYZ(n.x,n.y,n.z);c.$scale(p.x,p.y,p.z)},toFloat32Array:function(c){return new Float32Array(this[c])},toUint16Array:function(c){return new Uint16Array(this[c])},normalizeColors:function(){if(this.vertices){var c=this.vertices.length*4/3;if(this.colors&&this.colors.length<c){c/=this.colors.length;for(var i=this.colors,n=i.slice();--c;)i.push.apply(i,n)}}},computeCentroids:function(){var c=
this.vertices,i=[];this.faces.forEach(function(n){var p=[0,0,0],u=0;n.forEach(function(a){a=c[a];p[0]+=a[0];p[1]+=a[1];p[2]+=a[2];u++});p[0]/=u;p[1]/=u;p[2]/=u;i.push(p)});this.centroids=i},computeNormals:function(){var c=this.vertices,i=[];this.faces.forEach(function(n){var p=c[n[0]],u=c[n[1]];n=c[n[2]];p={x:p[0]-u[0],y:p[1]-u[1],z:p[2]-u[2]};w.$cross(p,{x:n[0]-u[0],y:n[1]-u[1],z:n[1]-u[2]});w.norm(p)>1.0E-6&&w.unit(p);i.push([p.x,p.y,p.z])});this.normals=i}};t.extend(h.Model.prototype,{setUniforms:function(c){c.setUniforms(this.uniforms)},
setShininess:function(c){c.setUniform("shininess",this.shininess||0)},setVertices:function(c,i){if(this.vertices)i||this.dynamic?c.setBuffer("vertices-"+this.id,{attribute:"position",value:this.toFloat32Array("vertices"),size:3}):c.setBuffer("vertices-"+this.id)},unsetVertices:function(c){c.setBuffer("vertices-"+this.id,false)},setNormals:function(c,i){if(this.normals)i||this.dynamic?c.setBuffer("normals-"+this.id,{attribute:"normal",value:this.toFloat32Array("normals"),size:3}):c.setBuffer("normals-"+
this.id)},unsetNormals:function(c){c.setBuffer("normals-"+this.id,false)},setIndices:function(c,i){if(this.indices)i||this.dynamic?c.setBuffer("indices-"+this.id,{bufferType:l.ELEMENT_ARRAY_BUFFER,drawType:l.STATIC_DRAW,value:this.toUint16Array("indices"),size:1}):c.setBuffer("indices-"+this.id)},unsetIndices:function(c){c.setBuffer("indices-"+this.id,false)},setColors:function(c,i){if(this.colors)i||this.dynamic?c.setBuffer("colors-"+this.id,{attribute:"color",value:this.toFloat32Array("colors"),
size:4}):c.setBuffer("colors-"+this.id)},unsetColors:function(c){c.setBuffer("colors-"+this.id,false)},setTexCoords:function(c,i){if(this.texCoords){var n=this.id;if(i||this.dynamic)t.type(this.texCoords)=="object"?this.textures.forEach(function(p,u){c.setBuffer("texCoords-"+u+"-"+n,{attribute:"texCoord"+(u+1),value:new Float32Array(this.texCoords[p]),size:2})}):c.setBuffer("texCoords-"+n,{attribute:"texCoord1",value:this.toFloat32Array("texCoords"),size:2});else t.type(this.texCoords)=="object"?
this.textures.forEach(function(p,u){c.setBuffer("texCoords-"+u+"-"+n)}):c.setBuffer("texCoords-"+n)}},unsetTexCoords:function(c){c.setBuffer("texCoords-"+this.id,false)},setTextures:function(c){this.textures=this.textures?t.splat(this.textures):[];for(var i=0,n=this.textures,p=n.length,u=PhiloGL.Scene.MAX_TEXTURES;i<u;i++)if(i<p){c.setUniform("hasTexture"+(i+1),true);c.setUniform("sampler"+(i+1),i);c.setTexture(n[i],l["TEXTURE"+i])}else c.setUniform("hasTexture"+(i+1),false)}});h.Cube=function(c){h.Model.call(this,
t.extend({vertices:[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1],texCoords:[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1],normals:[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0],indices:[0,1,2,0,2,3,4,5,6,
4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]},c||{}))};h.Cube.prototype=Object.create(h.Model.prototype);h.Sphere=function(c){var i=c.nlat||10,n=c.nlong||10,p=c.radius||1,u=g-0,a=2*g-0,b=[],f=[],j=[],k=[];c.onAddVertex=c.onAddVertex||t.empty;if(typeof p=="number"){var m=p;p=function(){return m}}for(var o=0;o<n;o++)for(var v=0;v<i;v++){var x=v/i,y=o/n,z=a*x,H=u*y,E=q(z),F=s(z),B=q(H),D=s(H);F*=B;E*=B;B=p(F,D,E,x,y);var G=B*F,C=B*D,I=B*E;b.push(G,C,I);f.push(F,D,E);j.push(x,
y);c.onAddVertex({rho:B,theta:z,phi:H,lat:v,lon:o,x:G,y:C,z:I,nx:F,ny:D,nz:E,u:x,v:y})}debugger;for(v=0;v<i-1;v++)for(o=0;o<n;o++){k.push(o*i+v,o*i+v+1,(o+1)%n*i+v);k.push((o+1)%n*i+v,o*i+v+1,(o+1)%n*i+v+1)}h.Model.call(this,t.extend({vertices:b,indices:k,normals:f,texCoords:j},c||{}))};h.Sphere.prototype=Object.create(h.Model.prototype);h.TruncatedCone=function(c){var i=c.bottomRadius||0,n=c.topRadius||0,p=c.height||1,u=c.nradial||10,a=c.nvertical||10,b=!!c.topCap,f=!!c.bottomCap,j=(b?2:0)+(f?2:
0),k=[],m=[],o=[],v=[],x=u+1,y=Math.atan2(i-n,p),z=Math,H=z.sin,E=z.cos;z=z.PI;var F=E(y);y=H(y);f=a+(f?2:0);for(b=b?-2:0;b<=f;b++){var B=b/a,D=p*B,G;if(b<0){D=0;B=1;G=i}else if(b>a){D=p;B=1;G=n}else G=i+(n-i)*(b/a);if(b==-2||b==a+2)B=G=0;D-=p/2;for(var C=0;C<x;C++){var I=H(C*z*2/u),J=E(C*z*2/u);k.push(I*G,D,J*G);m.push(b<0||b>a?0:I*F,b<0?-1:b>a?1:y,b<0||b>a?0:J*F);o.push(C/u,B)}}for(b=0;b<a+j;b++)for(C=0;C<u;C++)v.push(x*(b+0)+0+C,x*(b+0)+1+C,x*(b+1)+1+C,x*(b+0)+0+C,x*(b+1)+1+C,x*(b+1)+0+C);h.Model.call(this,
t.extend({vertices:k,normals:m,texCoords:o,indices:v},c||{}))};h.TruncatedCone.prototype=Object.create(h.Model.prototype);h.Cone=function(c){c.topRadius=0;c.topCap=!!c.cap;c.bottomCap=!!c.cap;c.bottomRadius=c.radius||3;h.TruncatedCone.call(this,c)};h.Cone.prototype=Object.create(h.TruncatedCone.prototype);h.Cylinder=function(c){c.bottomRadius=c.radius;c.topRadius=c.radius;h.TruncatedCone.call(this,c)};h.Cylinder.prototype=Object.create(h.TruncatedCone.prototype);h.PlaneXZ=function(c){for(var i=c.width,
n=c.height||0,p=c.nwidth||1,u=c.depth,a=c.ndepth||1,b=[],f=[],j=[],k=0;k<=a;k++)for(var m=0;m<=p;m++){var o=m/p,v=k/a;b.push(i*o-i*0.5,n,u*v-u*0.5);f.push(0,1,0);j.push(o,v)}i=p+1;n=[];for(k=0;k<a;k++)for(m=0;m<p;m++){n.push((k+0)*i+m,(k+1)*i+m,(k+0)*i+m+1);n.push((k+1)*i+m,(k+1)*i+m+1,(k+0)*i+m+1)}h.Model.call(this,t.extend({vertices:b,normals:f,texCoords:j,indices:n},c))};h.PlaneXZ.prototype=Object.create(h.Model.prototype);PhiloGL.O3D=h})();(function(){var w={Vertex:{},Fragment:{}},r=w.Fragment;
w.Vertex.Default="#define LIGHT_MAX 50\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color;\nattribute vec2 texCoord1;\nuniform mat4 modelViewMatrix;\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 normalMatrix;\nuniform bool enableLights;\nuniform vec3 ambientColor;\nuniform vec3 directionalColor;\nuniform vec3 lightingDirection;\nuniform vec3 pointLocation[LIGHT_MAX];\nuniform vec3 pointColor[LIGHT_MAX];\nuniform int numberPoints;\nvarying vec4 vColor;\nvarying vec2 vTexCoord;\nvarying vec3 lightWeighting;\nvoid main(void) {\nvec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\nif(!enableLights) {\nlightWeighting = vec3(1.0, 1.0, 1.0);\n} else {\nvec3 plightDirection;\nvec3 pointWeight = vec3(0.0, 0.0, 0.0);\nvec4 transformedNormal = normalMatrix * vec4(normal, 1.0);\nfloat directionalLightWeighting = max(dot(transformedNormal.xyz, lightingDirection), 0.0);\nfor (int i = 0; i < LIGHT_MAX; i++) {\nif (i < numberPoints) {\nplightDirection = normalize((viewMatrix * vec4(pointLocation[i], 1.0)).xyz - mvPosition.xyz);\npointWeight += max(dot(transformedNormal.xyz, plightDirection), 0.0) * pointColor[i];\n} else {\nbreak;\n}\n}\nlightWeighting = ambientColor + (directionalColor * directionalLightWeighting) + pointWeight;\n}\nvColor = color;\nvTexCoord = texCoord1;\ngl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}";
r.Default="#ifdef GL_ES\nprecision highp float;\n#endif\nvarying vec4 vColor;\nvarying vec2 vTexCoord;\nvarying vec3 lightWeighting;\nuniform bool hasTexture1;\nuniform sampler2D sampler1;\nuniform bool enablePicking;\nuniform vec3 pickColor;\nuniform bool hasFog;\nuniform vec3 fogColor;\nuniform float fogNear;\nuniform float fogFar;\nvoid main(){\nif(!hasTexture1) {\ngl_FragColor = vec4(vColor.rgb * lightWeighting, vColor.a);\n} else {\ngl_FragColor = vec4(texture2D(sampler1, vec2(vTexCoord.s, vTexCoord.t)).rgb * lightWeighting, 1.0);\n}\nif(enablePicking) {\ngl_FragColor = vec4(pickColor, 1.0);\n}\nif (hasFog) {\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\nfloat fogFactor = smoothstep(fogNear, fogFar, depth);\ngl_FragColor = mix(gl_FragColor, vec4(fogColor, gl_FragColor.w), fogFactor);\n}\n}";
PhiloGL.Shaders=w})();(function(){var w=PhiloGL.Vec3,r=PhiloGL.Mat4,s=function(q,g,d){d=t.merge({lights:{enable:false,ambient:{r:0.2,g:0.2,b:0.2},directional:{direction:{x:1,y:1,z:1},color:{r:0,g:0,b:0}}},effects:{fog:false}},d||{});if(t.type(q)!="object")this.program=q;else this.programMap=q;this.camera=g;this.models=[];this.config=d;this.setupPicking()};s.prototype={add:function(){for(var q=0,g=this.models,d=arguments.length;q<d;q++){var h=arguments[q];h.id=h.id||s.id++;g.push(h);this.defineBuffers(h)}},
getProgram:function(q){if(!this.programMap)return this.program;if(q&&q.program){q=this.programMap[q.program];if(q!=this.program){this.program=q;q.use()}}return this.program},defineBuffers:function(q){var g=this.getProgram(q);q.setVertices(g,true);q.setColors(g,true);q.setNormals(g,true);q.setTexCoords(g,true);q.setIndices(g,true)},beforeRender:function(q){this.setupLighting(q);this.setupEffects(q);var g=this.camera;q.setUniform("projectionMatrix",g.projection);q.setUniform("viewMatrix",g.modelView)},
setupLighting:function(q){var g=this.config.lights,d=g.ambient,h=g.directional,c=h.color,i=h.direction,n=g.enable;g=g.points&&t.splat(g.points)||[];h=g.length;var p=[],u=[],a=[],b=[];i=w.unit(i).$scale(-1);q.setUniform("enableLights",n);if(n){q.setUniform("ambientColor",[d.r,d.g,d.b]);q.setUniform("directionalColor",[c.r,c.g,c.b]);q.setUniform("lightingDirection",[i.x,i.y,i.z]);q.setUniform("numberPoints",h);for(d=0;d<h;d++){n=g[d];c=n.position;i=n.color||n.diffuse;n=n.specular;p.push(c.x,c.y,c.z);
u.push(i.r,i.g,i.b);a.push(+!!n);n?b.push(n.r,n.g,n.b):b.push(0,0,0)}q.setUniforms({pointLocation:p,pointColor:u});q.setUniforms({enableSpecular:a,pointSpecularColor:b})}},setupEffects:function(q){var g=this.config.effects.fog,d=g.color||{r:0.5,g:0.5,b:0.5};g?q.setUniforms({hasFog:true,fogNear:g.near,fogFar:g.far,fogColor:[d.r,d.g,d.b]}):q.setUniform("hasFog",false)},render:function(q,g){var d=!g&&!!this.programMap,h=this.camera,c=t.merge({onBeforeRender:t.empty,onAfterRender:t.empty},q||{});!d&&
this.beforeRender(g||this.program);this.models.forEach(function(i,n){if(i.display){var p=g||this.getProgram(i);d&&this.beforeRender(p);i.onBeforeRender(p,h);c.onBeforeRender(i,n);this.renderObject(i,p);c.onAfterRender(i,n);i.onAfterRender(p,h)}},this)},renderToTexture:function(q,g){g=g||{};var d=g.textureProgram||this.program,h=d.textures[q+"-texture"];d=d.textureMemo[q+"-texture"];this.render(g,g.renderProgram);l.bindTexture(d.textureType,h);l.generateMipmap(d.textureType);l.bindTexture(d.textureType,
null)},renderObject:function(q,g){var d=this.camera,h=new r;q.setUniforms(g);q.setShininess(g);q.setVertices(g);q.setColors(g);q.setNormals(g);q.setTextures(g);q.setTexCoords(g);q.setIndices(g);h.mulMat42(d.modelView,q.matrix);g.setUniform("modelViewMatrix",h);g.setUniform("normalMatrix",h.invert().$transpose());if(q.render)q.render(l,g,d);else q.indices?l.drawElements(q.drawType!==undefined?l.get(q.drawType):l.TRIANGLES,q.indices.length,l.UNSIGNED_SHORT,0):l.drawArrays(l.get(q.drawType||"TRIANGLES"),
0,q.vertices.length/3);q.unsetVertices(g);q.unsetColors(g);q.unsetNormals(g);q.unsetTexCoords(g);q.unsetIndices(g)},setupPicking:function(){var q=PhiloGL.Program.fromDefaultShaders();q.setFrameBuffer("$picking",{width:1,height:1,bindToTexture:{parameters:[{name:"TEXTURE_MAG_FILTER",value:"LINEAR"},{name:"TEXTURE_MIN_FILTER",value:"LINEAR",generateMipmap:false}]},bindToRenderBuffer:true});q.setFrameBuffer("$picking",false);this.pickingProgram=q},pick:function(q,g){var d={},h=this.program,c=this.pickingProgram,
i=this.config,n=i.lights.enable,p=i.effects.fog,u=l.canvas.width,a=l.canvas.height,b=[];t.time();var f=new Uint8Array(4),j=0,k;i.lights.enable=false;i.effects.fog=false;c.use();c.setUniform("enablePicking",true);c.setFrameBuffer("$picking",true);l.disable(l.BLEND);l.viewport(-q,g-a,u,a);l.clear(l.COLOR_BUFFER_BIT|l.DEPTH_BUFFER_BIT);l.readPixels(0,0,1,1,l.RGBA,l.UNSIGNED_BYTE,f);k=f[0]+f[1]*256+f[2]*65536;this.renderToTexture("$picking",{renderProgram:c,textureProgram:c,onBeforeRender:function(m,
o){if(o==k)j=1;var v=o+j;b[0]=v%256;b[1]=(v/256>>0)%256;b[2]=(v/65536>>0)%256;h.setUniform("pickColor",[b[0]/255,b[1]/255,b[2]/255]);d[String(b)]=m}});l.readPixels(0,0,1,1,l.RGBA,l.UNSIGNED_BYTE,f);u=d[String([f[0],f[1],f[2]])];c.setFrameBuffer("$picking",false);c.setUniform("enablePicking",false);i.lights.enable=n;i.effects.fog=p;h&&h.use();return u&&u.pickable&&u}};s.id=t.time();s.MAX_TEXTURES=3;s.MAX_POINT_LIGHTS=50;PhiloGL.Scene=s})();(function(){function w(r,s){for(var q=this.workers=[];s--;)q.push(new Worker(r))}
w.prototype={map:function(r){var s=this.workers,q=this.configs=[],g=0;for(s=s.length;g<s;g++)q.push(r&&r(g));return this},reduce:function(r){for(var s=r.reduceFn,q=this.workers,g=this.configs,d=q.length,h=r.initialValue,c=function(u){d--;h=h===undefined?u.data:s(h,u.data);if(d==0)r.onComplete(h)},i=0,n=d;i<n;i++){var p=q[i];p.onmessage=c;p.postMessage(g[i])}return this}};PhiloGL.WorkerGroup=w})();(function(){var w=function(g){this.opt=t.merge({duration:1E3,transition:function(d){return d},onCompute:t.empty,
onComplete:t.empty},g||{})};w.prototype={timer:null,time:null,start:function(g){this.opt=t.merge(this.opt,g||{});this.time=t.time();this.animating=true},step:function(){if(this.animating){var g=t.time(),d=this.time,h=this.opt;if(g<d+h.duration){g=h.transition((g-d)/h.duration);h.onCompute.call(this,g)}else{this.animating=false;h.onCompute.call(this,1);h.onComplete.call(this)}}}};w.compute=function(g,d,h){return g+(d-g)*h};w.Transition={linear:function(g){return g}};var r=w.Transition;(function(){var g=
function(c,i){i=t.splat(i);return t.extend(c,{easeIn:function(n){return c(n,i)},easeOut:function(n){return 1-c(1-n,i)},easeInOut:function(n){return n<=0.5?c(2*n,i)/2:(2-c(2*(1-n),i))/2}})},d={Pow:function(c,i){return Math.pow(c,i[0]||6)},Expo:function(c){return Math.pow(2,8*(c-1))},Circ:function(c){return 1-Math.sin(Math.acos(c))},Sine:function(c){return 1-Math.sin((1-c)*Math.PI/2)},Back:function(c,i){i=i[0]||1.618;return Math.pow(c,2)*((i+1)*c-i)},Bounce:function(c){for(var i,n=0,p=1;;n+=p,p/=2)if(c>=
(7-4*n)/11){i=p*p-Math.pow((11-6*n-11*c)/4,2);break}return i},Elastic:function(c,i){return Math.pow(2,10*--c)*Math.cos(20*c*Math.PI*(i[0]||1)/3)}},h;for(h in d)r[h]=g(d[h]);["Quad","Cubic","Quart","Quint"].forEach(function(c,i){r[c]=g(function(n){return Math.pow(n,[i+2])})})})();var s=self||window;if(s){var q=false;["webkitAnimationTime","mozAnimationTime","animationTime","webkitAnimationStartTime","mozAnimationStartTime","animationStartTime"].forEach(function(g){if(g in s){w.animationTime=function(){return s[g]};
q=true}});if(!q)w.animationTime=t.time;q=false;["webkitRequestAnimationFrame","mozRequestAnimationFrame","requestAnimationFrame"].forEach(function(g){if(g in s){w.requestAnimationFrame=function(d){s[g](function(){d()})};q=true}});if(!q)w.requestAnimationFrame=function(g){setTimeout(function(){g()},1E3/60)}}PhiloGL.Fx=w})()})();
