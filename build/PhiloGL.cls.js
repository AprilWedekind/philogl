/*

 Copyright (c) 2011 Sencha Labs - Author: Nicolas Garcia Belmonte (http://philogb.github.com/)

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.

*/
(function(){function t(z){return document.getElementById(z)}this.PhiloGL=null;(function(){PhiloGL=function(z,w){function i(u,x,s){var v=u.canvas,a=new PhiloGL.Camera(d.fov,v.width/v.height,d.near,d.far,d);a.update();var b=new PhiloGL.Scene(x,a,c);N=new PhiloGL.WebGL.Application({gl:u,canvas:v,program:x,scene:b,camera:a});x.$$family=="program"&&x.use();f&&PhiloGL.Events.create(N,t.extend(f,{bind:N}));if(l.src.length)new PhiloGL.IO.Textures(t.extend(l,{onComplete:function(){s(N)}}));else s(N)}w=t.merge({context:{},
camera:{fov:45,near:0.1,far:500},program:{from:"defaults",vs:"Default",fs:"Default"},scene:{},textures:{src:[]},events:{},onLoad:t.empty,onError:t.empty},w||{});var k=w.context,d=w.camera,f=w.events,l=w.textures,g=t.splat(w.program),c=w.scene;o=PhiloGL.WebGL.getContext(z,k);if(!o){w.onError("The WebGL context couldn't been initialized");return null}var n={defaults:"fromDefaultShaders",ids:"fromShaderIds",sources:"fromShaderSources",uris:"fromShaderURIs"},j=g.length,p=function(){var u=j,x={},s=false;
return{onSuccess:function(v,a){x[a.id||j-u]=v;u--;if(u==0&&!s)i(o,j==1?v:x,function(b){w.onLoad(b)})},onError:function(){u--;w.onError(w.id);s=true}}}();g.forEach(function(u){var x=u.from,s;for(s in n)if(x==s){program=PhiloGL.Program[n[s]](t.extend(p,u));break}if(program)p.onSuccess(program,u)})}})();PhiloGL.unpack=function(z){z=z||aa;["Vec3","Mat4","Quat","Camera","Program","WebGL","O3D","Scene","Shaders","IO","Events","WorkerGroup","Fx","Media"].forEach(function(w){z[w]=PhiloGL[w]})};PhiloGL.version=
"1.3.0";var o,N,aa=this;t.empty=function(){};t.time=Date.now||function(){return+new Date};t.uid=function(){var z=t.time();return function(){return z++}}();t.extend=function(z,w){for(var i in w)z[i]=w[i];return z};t.type=function(){var z=Object.prototype.toString;return function(w){var i;i=z.call(w);i=i.substr(8,i.length-9).toLowerCase();if(i!="object")return i;if(w.$$family)return w.$$family;return w&&w.nodeName&&w.nodeType==1?"element":i}}();(function(){function z(w){var i=t.type(w);if(i=="object"){i=
{};for(var k in w)i[k]=z(w[k]);return i}else if(i=="array"){i=[];k=0;for(var d=w.length;k<d;k++)i[k]=z(w[k]);return i}else return w}t.merge=function(){for(var w={},i=0,k=arguments.length;i<k;i++){var d=arguments[i];if(t.type(d)=="object")for(var f in d){var l=d[f],g=w[f];w[f]=g&&t.type(l)=="object"&&t.type(g)=="object"?t.merge(g,l):z(l)}}return w}})();t.splat=function(){var z=Array.isArray;return function(w){return z(w)&&w||[w]}}();(function(){function z(i){for(var k in i)this[k]=i[k];this.buffers=
{};this.bufferMemo={};this.frameBuffers={};this.frameBufferMemo={};this.renderBuffers={};this.renderBufferMemo={};this.textures={};this.textureMemo={}}var w={getContext:function(i,k){i=typeof i=="string"?t(i):i;var d;(d=i.getContext("experimental-webgl",k))||(d=i.getContext("webgl",k));if(d&&k&&k.debug){o={};for(var f in d){var l=d[f];o[f]=typeof l=="function"?function(g,c){return function(){console.log(g,Array.prototype.join.call(arguments),Array.prototype.slice.call(arguments));try{var n=c.apply(d,
arguments)}catch(j){throw g+" "+j;}for(var p=[],u;(u=d.getError())!==d.NO_ERROR;)p.push(u);if(p.length)throw p.join();return n}}(f,l):l}}else o=d;if(o)o.get=function(g){return typeof g=="string"?o[g]:g};return o}};z.prototype={$$family:"application",setBuffer:function(i,k,d){if(d===false||d===null){(d=this.bufferMemo[k])&&o.bindBuffer(d.bufferType,null);var f=d&&d.attribute||k,l=i.attributes[f];if(l!==undefined&&i.attributeEnabled[f]){i.attributeEnabled[f]=false;o.disableVertexAttribArray(l)}}else{d=
t.merge({bufferType:o.ARRAY_BUFFER,size:1,dataType:o.FLOAT,stride:0,offset:0,drawType:o.STATIC_DRAW},this.bufferMemo[k]||{},d||{});f=d.attribute||k;var g=d.bufferType,c=k in this.buffers,n=c?this.buffers[k]:o.createBuffer(),j="value"in d,p=d.value,u=d.size,x=d.dataType,s=d.stride,v=d.offset,a=d.drawType;l=i.attributes[f];var b=l!==undefined;c||(this.buffers[k]=n);if(b&&!i.attributeEnabled[f]){i.attributeEnabled[f]=true;o.enableVertexAttribArray(l)}o.bindBuffer(g,n);j&&o.bufferData(g,p,a);b&&o.vertexAttribPointer(l,
u,x,false,s,v);delete d.value;this.bufferMemo[k]=d;if(b)this.bufferMemo[f]=d;return this}},setBuffers:function(i,k){for(var d in k)this.setBuffer(i,d,k[d]);return this},setFrameBuffer:function(i,k){if(typeof k!="object")o.bindFramebuffer(o.FRAMEBUFFER,k?this.frameBuffers[i]:null);else{k=t.merge({width:0,height:0,bindToTexture:false,textureOptions:{attachment:o.COLOR_ATTACHMENT0},bindToRenderBuffer:false,renderBufferOptions:{attachment:o.DEPTH_ATTACHMENT}},this.frameBufferMemo[i]||{},k||{});var d=
k.bindToTexture,f=k.bindToRenderBuffer,l=i in this.frameBuffers,g=l?this.frameBuffers[i]:o.createFramebuffer(o.FRAMEBUFFER);o.bindFramebuffer(o.FRAMEBUFFER,g);l||(this.frameBuffers[i]=g);if(d){d=t.merge({data:{width:k.width,height:k.height}},t.type(d)=="object"?d:{});l=i+"-texture";g=k.textureOptions;this.setTexture(l,d);o.framebufferTexture2D(o.FRAMEBUFFER,g.attachment,this.textureMemo[l].textureType,this.textures[l],0)}if(f){f=t.merge({width:k.width,height:k.height},t.type(f)=="object"?f:{});d=
i+"-renderbuffer";l=k.renderBufferOptions;this.setRenderBuffer(d,f);o.framebufferRenderbuffer(o.FRAMEBUFFER,l.attachment,o.RENDERBUFFER,this.renderBuffers[d])}o.bindTexture(o.TEXTURE_2D,null);o.bindRenderbuffer(o.RENDERBUFFER,null);o.bindFramebuffer(o.FRAMEBUFFER,null);this.frameBufferMemo[i]=k;return this}},setFrameBuffers:function(i){for(var k in i)this.setFrameBuffer(k,i[k]);return this},setRenderBuffer:function(i,k){if(typeof k!="object")o.bindRenderbuffer(o.RENDERBUFFER,k?this.renderBufferMemo[i]:
null);else{k=t.merge({storageType:o.DEPTH_COMPONENT16,width:0,height:0},this.renderBufferMemo[i]||{},k||{});var d=i in this.renderBuffers,f=d?this.renderBuffers[i]:o.createRenderbuffer(o.RENDERBUFFER);d||(this.renderBuffers[i]=f);o.bindRenderbuffer(o.RENDERBUFFER,f);o.renderbufferStorage(o.RENDERBUFFER,k.storageType,k.width,k.height);this.renderBufferMemo[i]=k;return this}},setRenderBuffers:function(i){for(var k in i)this.setRenderBuffer(k,i[k]);return this},setTexture:function(i,k){if(!k||typeof k!=
"object"){o.activeTexture(k||o.TEXTURE0);o.bindTexture(this.textureMemo[i].textureType||o.TEXTURE_2D,this.textures[i])}else{k=t.merge({textureType:o.TEXTURE_2D,pixelStore:[{name:o.UNPACK_FLIP_Y_WEBGL,value:true}],parameters:[{name:o.TEXTURE_MAG_FILTER,value:o.NEAREST},{name:o.TEXTURE_MIN_FILTER,value:o.NEAREST}],data:{format:o.RGBA,value:false,width:0,height:0,border:0}},this.textureMemo[i]||{},k||{});var d="textureType"in k?o.get(k.textureType):o.TEXTURE_2D,f="textureTarget"in k?o.get(k.textureTarget):
d,l=d==o.TEXTURE_CUBE_MAP,g=i in this.textures,c=g?this.textures[i]:o.createTexture(),n=k.pixelStore,j=k.parameters,p=k.data,u=p.value,x=p.format,s=!!p.value;g||(this.textures[i]=c);o.bindTexture(d,c);g||n.forEach(function(v){v.name=typeof v.name=="string"?o[v.name]:v.name;o.pixelStorei(v.name,v.value)});if(s)if(l)for(c=0;c<6;++c)o.texImage2D(f[c],0,x,x,o.UNSIGNED_BYTE,u[c]);else o.texImage2D(f,0,x,x,o.UNSIGNED_BYTE,u);else if(p.width||p.height)o.texImage2D(f,0,x,p.width,p.height,p.border,x,o.UNSIGNED_BYTE,
null);g||j.forEach(function(v){v.name=o.get(v.name);v.value=o.get(v.value);o.texParameteri(d,v.name,v.value);v.generateMipmap&&o.generateMipmap(d)});k.isCube=l;delete k.data;this.textureMemo[i]=k;return this}},setTextures:function(i){for(var k in i)this.setTexture(k,i[k]);return this},use:function(i){o.useProgram(i.program);this.usedProgram=i;return this}};w.Application=z;(function(){try{var i=document.createElement("canvas");PhiloGL.hasWebGL=function(){return!!(window.WebGLRenderingContext&&(i.getContext("webgl")||
i.getContext("experimental-webgl")))}}catch(k){PhiloGL.hasWebGL=function(){return false}}})();PhiloGL.WebGL=w})();(function(){function z(a){return{get:function(){return this[a]},set:function(b){this[a]=b},configurable:false,enumerable:false}}var w=Math.sqrt,i=Math.sin,k=Math.cos,d=Math.tan,f=Math.PI,l=Array.prototype.slice,g=this.Float32Array,c=function(){if(!g||!g.call)return Array;try{g.call({},10)}catch(a){return Array}return g}(),n=c!=Array,j=function(a,b,h){if(n){g.call(this,3);this[0]=a||0;
this[1]=b||0;this[2]=h||0}else this.push(a||0,b||0,h||0);this.typedContainer=new g(3)};j.create=function(){return new g(3)};j.prototype=Object.create(c.prototype,{$$family:{value:"Vec3"},x:z(0),y:z(1),z:z(2)});var p={setVec3:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];return a},set:function(a,b,h,m){a[0]=b;a[1]=h;a[2]=m;return a},add:function(a,b){return new j(a[0]+b[0],a[1]+b[1],a[2]+b[2])},$add:function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];return a},add2:function(a,b,h){a[0]=b[0]+h[0];a[1]=b[1]+
h[1];a[2]=b[2]+h[2];return a},sub:function(a,b){return new j(a[0]-b[0],a[1]-b[1],a[2]-b[2])},$sub:function(a,b){a[0]-=b[0];a[1]-=b[1];a[2]-=b[2];return a},sub2:function(a,b,h){a[0]=b[0]-h[0];a[1]=b[1]-h[1];a[2]=b[2]-h[2];return a},scale:function(a,b){return new j(a[0]*b,a[1]*b,a[2]*b)},$scale:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;return a},neg:function(a){return new j(-a[0],-a[1],-a[2])},$neg:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];return a},unit:function(a){var b=j.norm(a);if(b>0)return j.scale(a,
1/b);return j.clone(a)},$unit:function(a){var b=j.norm(a);if(b>0)return j.$scale(a,1/b);return a},cross:function(a,b){var h=a[0],m=a[1],q=a[2],r=b[0],y=b[1],A=b[2];return new j(m*A-q*y,q*r-h*A,h*y-m*r)},$cross:function(a,b){var h=a[0],m=a[1],q=a[2],r=b[0],y=b[1],A=b[2];a[0]=m*A-q*y;a[1]=q*r-h*A;a[2]=h*y-m*r;return a},distTo:function(a,b){var h=a[0]-b[0],m=a[1]-b[1],q=a[2]-b[2];return w(h*h+m*m+q*q)},distToSq:function(a,b){var h=a[0]-b[0],m=a[1]-b[1],q=a[2]-b[2];return h*h+m*m+q*q},norm:function(a){var b=
a[0],h=a[1];a=a[2];return w(b*b+h*h+a*a)},normSq:function(a){var b=a[0],h=a[1];a=a[2];return b*b+h*h+a*a},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},clone:function(a){return a.$$family?new j(a[0],a[1],a[2]):j.setVec3(new g(3),a)},toFloat32Array:function(a){var b=a.typedContainer;if(!b)return a;b[0]=a[0];b[1]=a[1];b[2]=a[2];return b}},u=j.prototype,x;for(x in p){j[x]=p[x];u[x]=function(a){return function(){var b=l.call(arguments);b.unshift(this);return j[a].apply(j,b)}}(x)}var s=function(a,
b,h,m,q,r,y,A,B,C,D,E,G,I,J,H){c.call(this,16);this.length=16;typeof a=="number"?this.set(a,b,h,m,q,r,y,A,B,C,D,E,G,I,J,H):this.id();this.typedContainer=new g(16)};s.create=function(){return new g(16)};s.prototype=Object.create(c.prototype,{$$family:{value:"Mat4"},n11:z(0),n12:z(4),n13:z(8),n14:z(12),n21:z(1),n22:z(5),n23:z(9),n24:z(13),n31:z(2),n32:z(6),n33:z(10),n34:z(14),n41:z(3),n42:z(7),n43:z(11),n44:z(15)});p={id:function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=
0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},clone:function(a){return a.$$family?new s(a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]):new g(a)},set:function(a,b,h,m,q,r,y,A,B,C,D,E,G,I,J,H,F){a[0]=b;a[4]=h;a[8]=m;a[12]=q;a[1]=r;a[5]=y;a[9]=A;a[13]=B;a[2]=C;a[6]=D;a[10]=E;a[14]=G;a[3]=I;a[7]=J;a[11]=H;a[15]=F;return a},mulVec3:function(a,b){var h=j.clone(b);return s.$mulVec3(a,h)},$mulVec3:function(a,b){var h=b[0],m=b[1],q=b[2];b[0]=a[0]*h+a[4]*
m+a[8]*q+a[12];b[1]=a[1]*h+a[5]*m+a[9]*q+a[13];b[2]=a[2]*h+a[6]*m+a[10]*q+a[14];return b},mulMat42:function(a,b,h){var m=b[0],q=b[1],r=b[2],y=b[3],A=b[4],B=b[5],C=b[6],D=b[7],E=b[8],G=b[9],I=b[10],J=b[11],H=b[12],F=b[13],M=b[14];b=b[15];var K=h[0],L=h[1],P=h[2],Q=h[3],R=h[4],U=h[5],V=h[6],W=h[7],S=h[8],T=h[9],X=h[10],O=h[11],Y=h[12],Z=h[13],$=h[14];h=h[15];a[0]=K*m+L*A+P*E+Q*H;a[1]=K*q+L*B+P*G+Q*F;a[2]=K*r+L*C+P*I+Q*M;a[3]=K*y+L*D+P*J+Q*b;a[4]=R*m+U*A+V*E+W*H;a[5]=R*q+U*B+V*G+W*F;a[6]=R*r+U*C+V*I+
W*M;a[7]=R*y+U*D+V*J+W*b;a[8]=S*m+T*A+X*E+O*H;a[9]=S*q+T*B+X*G+O*F;a[10]=S*r+T*C+X*I+O*M;a[11]=S*y+T*D+X*J+O*b;a[12]=Y*m+Z*A+$*E+h*H;a[13]=Y*q+Z*B+$*G+h*F;a[14]=Y*r+Z*C+$*I+h*M;a[15]=Y*y+Z*D+$*J+h*b;return a},mulMat4:function(a,b){var h=s.clone(a);return s.mulMat42(h,a,b)},$mulMat4:function(a,b){return s.mulMat42(a,a,b)},add:function(a,b){var h=s.clone(a);return s.$add(h,b)},$add:function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];a[3]+=b[3];a[4]+=b[4];a[5]+=b[5];a[6]+=b[6];a[7]+=b[7];a[8]+=b[8];a[9]+=
b[9];a[10]+=b[10];a[11]+=b[11];a[12]+=b[12];a[13]+=b[13];a[14]+=b[14];a[15]+=b[15];return a},transpose:function(a){a=s.clone(a);return s.$transpose(a)},$transpose:function(a){var b=a[8],h=a[12],m=a[1],q=a[9],r=a[13],y=a[2],A=a[6],B=a[14],C=a[3],D=a[7],E=a[11];a[1]=a[4];a[2]=b;a[3]=h;a[4]=m;a[6]=q;a[7]=r;a[8]=y;a[9]=A;a[11]=B;a[12]=C;a[13]=D;a[14]=E;return a},rotateAxis:function(a,b,h){a=s.clone(a);return s.$rotateAxis(a,b,h)},$rotateAxis:function(a,b,h){var m=i(b),q=k(b),r=1-q,y=h[0],A=h[1],B=h[2];
h=y*y*r+q;b=y*A*r+B*m;var C=y*B*r-A*m,D=A*y*r-B*m,E=A*A*r+q,G=A*B*r+y*m,I=y*B*r+A*m;m=A*B*r-y*m;q=B*B*r+q;r=a[0];y=a[1];A=a[2];B=a[3];var J=a[4],H=a[5],F=a[6],M=a[7],K=a[8],L=a[9],P=a[10],Q=a[11];a[0]=r*h+J*b+K*C;a[1]=y*h+H*b+L*C;a[2]=A*h+F*b+P*C;a[3]=B*h+M*b+Q*C;a[4]=r*D+J*E+K*G;a[5]=y*D+H*E+L*G;a[6]=A*D+F*E+P*G;a[7]=B*D+M*E+Q*G;a[8]=r*I+J*m+K*q;a[9]=y*I+H*m+L*q;a[10]=A*I+F*m+P*q;a[11]=B*I+M*m+Q*q;return a},rotateXYZ:function(a,b,h,m){a=s.clone(a);return s.$rotateXYZ(a,b,h,m)},$rotateXYZ:function(a,
b,h,m){var q=a[0],r=a[1],y=a[2],A=a[3],B=a[4],C=a[5],D=a[6],E=a[7],G=a[8],I=a[9],J=a[10],H=a[11],F=k(b),M=k(h),K=k(m);b=i(b);var L=i(h),P=i(m);m=M*K;h=-F*P+b*L*K;var Q=b*P+F*L*K,R=M*P,U=F*K+b*L*P;K=-b*K+F*L*P;L=-L;b*=M;F*=M;a[0]=q*m+B*R+G*L;a[1]=r*m+C*R+I*L;a[2]=y*m+D*R+J*L;a[3]=A*m+E*R+H*L;a[4]=q*h+B*U+G*b;a[5]=r*h+C*U+I*b;a[6]=y*h+D*U+J*b;a[7]=A*h+E*U+H*b;a[8]=q*Q+B*K+G*F;a[9]=r*Q+C*K+I*F;a[10]=y*Q+D*K+J*F;a[11]=A*Q+E*K+H*F;return a},translate:function(a,b,h,m){a=s.clone(a);return s.$translate(a,
b,h,m)},$translate:function(a,b,h,m){a[12]=a[0]*b+a[4]*h+a[8]*m+a[12];a[13]=a[1]*b+a[5]*h+a[9]*m+a[13];a[14]=a[2]*b+a[6]*h+a[10]*m+a[14];a[15]=a[3]*b+a[7]*h+a[11]*m+a[15];return a},scale:function(a,b,h,m){a=s.clone(a);return s.$scale(a,b,h,m)},$scale:function(a,b,h,m){a[0]*=b;a[1]*=b;a[2]*=b;a[3]*=b;a[4]*=h;a[5]*=h;a[6]*=h;a[7]*=h;a[8]*=m;a[9]*=m;a[10]*=m;a[11]*=m;return a},invert:function(a){a=s.clone(a);return s.$invert(a)},$invert:function(a){var b=a[0],h=a[1],m=a[2],q=a[3],r=a[4],y=a[5],A=a[6],
B=a[7],C=a[8],D=a[9],E=a[10],G=a[11],I=a[12],J=a[13],H=a[14],F=a[15],M=b*y-h*r,K=b*A-m*r,L=b*B-q*r,P=h*A-m*y,Q=h*B-q*y,R=m*B-q*A,U=C*J-D*I,V=C*H-E*I,W=C*F-G*I,S=D*H-E*J,T=D*F-G*J,X=E*F-G*H,O=1/(M*X-K*T+L*S+P*W-Q*V+R*U);a[0]=(+y*X-A*T+B*S)*O;a[1]=(-h*X+m*T-q*S)*O;a[2]=(+J*R-H*Q+F*P)*O;a[3]=(-D*R+E*Q-G*P)*O;a[4]=(-r*X+A*W-B*V)*O;a[5]=(+b*X-m*W+q*V)*O;a[6]=(-I*R+H*L-F*K)*O;a[7]=(+C*R-E*L+G*K)*O;a[8]=(+r*T-y*W+B*U)*O;a[9]=(-b*T+h*W-q*U)*O;a[10]=(+I*Q-J*L+F*M)*O;a[11]=(-C*Q+D*L-G*M)*O;a[12]=(-r*S+y*V-
A*U)*O;a[13]=(+b*S-h*V+m*U)*O;a[14]=(-I*P+J*K-H*M)*O;a[15]=(+C*P-D*K+E*M)*O;return a},lookAt:function(a,b,h,m){h=j.sub(b,h);h.$unit();m=j.cross(m,h);m.$unit();var q=j.cross(h,m);q.$unit();return s.set(a,m[0],m[1],m[2],-m.dot(b),q[0],q[1],q[2],-q.dot(b),h[0],h[1],h[2],-h.dot(b),0,0,0,1)},frustum:function(a,b,h,m,q,r,y){var A=h-b,B=q-m,C=y-r;a[0]=r*2/A;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=r*2/B;a[6]=0;a[7]=0;a[8]=(h+b)/A;a[9]=(q+m)/B;a[10]=-(y+r)/C;a[11]=-1;a[12]=0;a[13]=0;a[14]=-(y*r*2)/C;a[15]=0;return a},
perspective:function(a,b,h,m,q){b=m*d(b*f/360);var r=-b;return s.frustum(a,r*h,b*h,r,b,m,q)},ortho:function(a,b,h,m,q,r,y){var A=h-b,B=q-m,C=y-r;a[0]=2/A;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=2/B;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=-2/C;a[11]=0;a[12]=-(b+h)/A;a[13]=-(q+m)/B;a[14]=-(y+r)/C;a[15]=1;return a},toFloat32Array:function(a){var b=a.typedContainer;if(!b)return a;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];
b[13]=a[13];b[14]=a[14];b[15]=a[15];return b}};u=s.prototype;for(x in p){s[x]=p[x];u[x]=function(a){return function(){var b=l.call(arguments);b.unshift(this);return s[a].apply(s,b)}}(x)}var v=function(a,b,h,m){c.call(this,4);this[0]=a||0;this[1]=b||0;this[2]=h||0;this[3]=m||0;this.typedContainer=new g(4)};v.create=function(){return new g(4)};p={setQuat:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];return a},set:function(a,b,h,m,q){a[0]=b||0;a[1]=h||0;a[2]=m||0;a[3]=q||0;return a},clone:function(a){return a.$$family?
new v(a[0],a[1],a[2],a[3]):v.setQuat(new g(4),a)},neg:function(a){return new v(-a[0],-a[1],-a[2],-a[3])},$neg:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];a[3]=-a[3];return a},add:function(a,b){return new v(a[0]+b[0],a[1]+b[1],a[2]+b[2],a[3]+b[3])},$add:function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];a[3]+=b[3];return a},sub:function(a,b){return new v(a[0]-b[0],a[1]-b[1],a[2]-b[2],a[3]-b[3])},$sub:function(a,b){a[0]-=b[0];a[1]-=b[1];a[2]-=b[2];a[3]-=b[3];return a},scale:function(a,b){return new v(a[0]*
b,a[1]*b,a[2]*b,a[3]*b)},$scale:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;a[3]*=b;return a},mulQuat:function(a,b){var h=a[0],m=a[1],q=a[2],r=a[3],y=b[0],A=b[1],B=b[2],C=b[3];return new v(r*y+h*C+m*B-q*A,r*A+m*C+q*y-h*B,r*B+q*C+h*A-m*y,r*C-h*y-m*A-q*B)},$mulQuat:function(a,b){var h=a[0],m=a[1],q=a[2],r=a[3],y=b[0],A=b[1],B=b[2],C=b[3];a[0]=r*y+h*C+m*B-q*A;a[1]=r*A+m*C+q*y-h*B;a[2]=r*B+q*C+h*A-m*y;a[3]=r*C-h*y-m*A-q*B;return a},divQuat:function(a,b){var h=a[0],m=a[1],q=a[2],r=a[3],y=b[0],A=b[1],B=b[2],
C=b[3],D=1/(C*C+y*y+A*A+B*B);return new v((h*C-r*y-m*B+q*A)*D,(h*B-r*A+m*C-q*y)*D,(m*y+q*C-r*B-h*A)*D,(r*C+h*y+m*A+q*B)*D)},$divQuat:function(a,b){var h=a[0],m=a[1],q=a[2],r=a[3],y=b[0],A=b[1],B=b[2],C=b[3],D=1/(C*C+y*y+A*A+B*B);a[0]=(h*C-r*y-m*B+q*A)*D;a[1]=(h*B-r*A+m*C-q*y)*D;a[2]=(m*y+q*C-r*B-h*A)*D;a[3]=(r*C+h*y+m*A+q*B)*D;return a},invert:function(a){var b=a[0],h=a[1],m=a[2];a=a[3];var q=1/(b*b+h*h+m*m+a*a);return new v(-b*q,-h*q,-m*q,a*q)},$invert:function(a){var b=a[0],h=a[1],m=a[2],q=a[3],
r=1/(b*b+h*h+m*m+q*q);a[0]=-b*r;a[1]=-h*r;a[2]=-m*r;a[3]=q*r;return a},norm:function(a){var b=a[0],h=a[1],m=a[2];a=a[3];return w(b*b+h*h+m*m+a*a)},normSq:function(a){var b=a[0],h=a[1],m=a[2];a=a[3];return b*b+h*h+m*m+a*a},unit:function(a){return v.scale(a,1/v.norm(a))},$unit:function(a){return v.$scale(a,1/v.norm(a))},conjugate:function(a){return new v(-a[0],-a[1],-a[2],a[3])},$conjugate:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];return a}};u=v.prototype={};for(x in p){v[x]=p[x];u[x]=function(a){return function(){var b=
l.call(arguments);b.unshift(this);return v[a].apply(v,b)}}(x)}j.fromQuat=function(a){return new j(a[0],a[1],a[2])};v.fromVec3=function(a,b){return new v(a[0],a[1],a[2],b||0)};v.fromMat4=function(a){var b,h,m;if(a[0]>a[5]&&a[0]>a[10]){b=0;h=1;m=2}else if(a[5]>a[0]&&a[5]>a[10]){b=1;h=2;m=0}else{b=2;h=0;m=1}var q=w(1+a[b*5]-a[h*5]-a[m*5]),r=new v;r[b]=0.5*q;r[h]=0.5*(a["n"+h+""+b]+a["n"+b+""+h])/q;r[m]=0.5*(a["n"+b+""+m]+a["n"+m+""+b])/q;r[3]=0.5*(a["n"+h+""+m]-a["n"+m+""+h])/q;return r};v.fromXRotation=
function(a){return new v(i(a/2),0,0,k(a/2))};v.fromYRotation=function(a){return new v(0,i(a/2),0,k(a/2))};v.fromZRotation=function(a){return new v(0,0,i(a/2),k(a/2))};v.fromAxisRotation=function(a,b){var h=a[0],m=a[1],q=a[2],r=1/w(h*h+m*m+q*q),y=i(b/2),A=k(b/2);return new v(y*h*r,y*m*r,y*q*r,A)};s.fromQuat=function(a){var b=a[3],h=a[0],m=a[1];a=a[2];return new s(b*b+h*h-m*m-a*a,2*h*m-2*b*a,2*h*a+2*b*m,0,2*h*m+2*b*a,b*b-h*h+m*m-a*a,2*m*a-2*b*h,0,2*h*a-2*b*m,2*m*a+2*b*h,b*b-h*h-m*m+a*a,0,0,0,0,1)};
PhiloGL.Vec3=j;PhiloGL.Mat4=s;PhiloGL.Quat=v})();(function(){function z(f){return f!==true?f:false}var w=function(f){var l=function(g){for(var c={x:0,y:0};g&&!/^(?:body|html)$/i.test(g.tagName);){c.x+=g.offsetLeft;c.y+=g.offsetTop;g=g.offsetParent}return c}(f);f=function(g){for(var c={x:0,y:0};g&&!/^(?:body|html)$/i.test(g.tagName);){c.x+=g.scrollLeft;c.y+=g.scrollTop;g=g.parentNode}return c}(f);return{x:l.x-f.x,y:l.y-f.y}},i={get:function(f,l){return f||(l||window).event},getWheel:function(f){return f.wheelDelta?
f.wheelDelta/120:-(f.detail||0)/3},getKey:function(f){var l=f.which||f.keyCode,g;a:{g=d.Keys;for(var c in g)if(g[c]==l){g=c;break a}g=void 0}c=l-111;if(c>0&&c<13)g="f"+c;g=g||String.fromCharCode(l).toLowerCase();return{code:l,key:g,shift:f.shiftKey,control:f.ctrlKey,alt:f.altKey,meta:f.metaKey}},isRightClick:function(f){return f.which==3||f.button==2},getPos:function(f,l){l=l||window;f=f||l.event;var g=l.document;g=g.documentElement||g.body;if(f.touches&&f.touches.length)f=f.touches[0];return{x:f.pageX||
f.clientX+g.scrollLeft,y:f.pageY||f.clientY+g.scrollTop}},stop:function(f){f.stopPropagation&&f.stopPropagation();f.cancelBubble=true;if(f.preventDefault)f.preventDefault();else f.returnValue=false}},k=function(f,l){var g=f.canvas;this.scene=f.scene;this.domElem=g;this.pos=w(g);this.opt=this.callbacks=l;this.size={width:g.width||g.offsetWidth,height:g.height||g.offsetHeight};this.attachEvents()};k.prototype={hovered:false,pressed:false,touched:false,touchMoved:false,moved:false,attachEvents:function(){var f=
this.domElem,l=this;if(this.opt.disableContextMenu)f.oncontextmenu=function(){return false};["mouseup","mousedown","mousemove","mouseover","mouseout","touchstart","touchmove","touchend"].forEach(function(c){f.addEventListener(c,function(n,j){l[c](l.eventInfo(c,n,j))},false)});["keydown","keyup"].forEach(function(c){document.addEventListener(c,function(n,j){l[c](l.eventInfo(c,n,j))},false)});var g="";g=!document.getBoxObjectFor&&window.mozInnerScreenX==null?"mousewheel":"DOMMouseScroll";f.addEventListener(g,
function(c,n){l.mousewheel(l.eventInfo("mousewheel",c,n))},false)},eventInfo:function(f,l,g){var c=this.domElem,n=this.scene,j=this.opt,p=this.getSize(),u=j.relative,x=j.centerOrigin,s=j.cachePosition&&this.pos||w(c),v=i.get(l,g),a=i.getPos(l,g);l={};g=a.x;c=a.y;if(u){g-=s.x;c-=s.y;if(x){g-=p.width/2;c-=p.height/2;c*=-1}}switch(f){case "mousewheel":l.wheel=i.getWheel(v);break;case "keydown":t.extend(l,i.getKey(v));break;case "mouseup":l.isRightClick=i.isRightClick(v)}var b;t.extend(l,{x:g,y:c,cache:false,
stop:function(){i.stop(v)},getTarget:function(){if(b)return b;return b=!j.picking||n.pick(a.x-s.x,a.y-s.y)||true}});l.event=v;return l},getSize:function(){if(this.cacheSize)return this.size;var f=this.domElem;return{width:f.width||f.offsetWidth,height:f.height||f.offsetHeight}},mouseup:function(f){if(!this.moved)if(f.isRightClick)this.callbacks.onRightClick(f,this.hovered);else this.callbacks.onClick(f,z(this.pressed));if(this.pressed){if(this.moved)this.callbacks.onDragEnd(f,z(this.pressed));else this.callbacks.onDragCancel(f,
z(this.pressed));this.pressed=this.moved=false}},mouseout:function(f){for(var l=f.relatedTarget,g=this.domElem;l&&l.parentNode;){if(g==l.parentNode)return;l=l.parentNode}if(this.hovered){this.callbacks.onMouseLeave(f,this.hovered);this.hovered=false}},mouseover:function(){},mousemove:function(f){if(this.pressed){this.moved=true;this.callbacks.onDragMove(f,z(this.pressed))}else{if(this.hovered){var l=z(f.getTarget());if(!l||l.id!=this.hovered.id){this.callbacks.onMouseLeave(f,this.hovered);if(this.hovered=
l)this.callbacks.onMouseEnter(f,this.hovered)}else this.callbacks.onMouseMove(f,this.hovered)}else if(this.hovered=z(f.getTarget()))this.callbacks.onMouseEnter(f,this.hovered);if(!this.opt.picking)this.callbacks.onMouseMove(f)}},mousewheel:function(f){this.callbacks.onMouseWheel(f)},mousedown:function(f){this.pressed=f.getTarget();this.callbacks.onDragStart(f,z(this.pressed))},touchstart:function(f){this.touched=f.getTarget();this.callbacks.onTouchStart(f,z(this.touched))},touchmove:function(f){if(this.touched){this.touchMoved=
true;this.callbacks.onTouchMove(f,z(this.touched))}},touchend:function(f){if(this.touched){if(this.touchMoved)this.callbacks.onTouchEnd(f,z(this.touched));else this.callbacks.onTouchCancel(f,z(this.touched));this.touched=this.touchMoved=false}},keydown:function(f){this.callbacks.onKeyDown(f)},keyup:function(f){this.callbacks.onKeyUp(f)}};var d={};d.create=function(f,l){l=t.merge({cachePosition:true,cacheSize:true,relative:true,centerOrigin:true,disableContextMenu:true,bind:false,picking:false,onClick:t.empty,
onRightClick:t.empty,onDragStart:t.empty,onDragMove:t.empty,onDragEnd:t.empty,onDragCancel:t.empty,onTouchStart:t.empty,onTouchMove:t.empty,onTouchEnd:t.empty,onTouchCancel:t.empty,onMouseMove:t.empty,onMouseEnter:t.empty,onMouseLeave:t.empty,onMouseWheel:t.empty,onKeyDown:t.empty,onKeyUp:t.empty},l||{});var g=l.bind;if(g)for(var c in l)c.match(/^on[a-zA-Z0-9]+$/)&&function(n,j){l[n]=function(){return j.apply(g,Array.prototype.slice.call(arguments))}}(c,l[c]);new k(f,l)};d.Keys={enter:13,up:38,down:40,
left:37,right:39,esc:27,space:32,backspace:8,tab:9,"delete":46};PhiloGL.Events=d})();(function(){function z(){return arguments.length==2?{vs:arguments[0],fs:arguments[1]}:arguments[0]||{}}var w=function(d,f,l){var g=d.createShader(l);if(g==null)throw"Error creating the shader with shader type: "+l;d.shaderSource(g,f);d.compileShader(g);if(!d.getShaderParameter(g,d.COMPILE_STATUS)){f=d.getShaderInfoLog(g);d.deleteShader(g);throw"Error while compiling the shader "+f;}return g},i=function(d,f,l){var g=
o.getUniformLocation(d,f.name);d=f.type;var c=false,n=true,j,p;if(f.size>1&&l)switch(d){case o.FLOAT:j=o.uniform1fv;p=Float32Array;n=false;break;case o.INT:case o.BOOL:case o.SAMPLER_2D:case o.SAMPLER_CUBE:j=o.uniform1iv;p=Uint16Array;n=false}if(n)switch(d){case o.FLOAT:j=o.uniform1f;break;case o.FLOAT_VEC2:j=o.uniform2fv;p=l?Float32Array:new Float32Array(2);break;case o.FLOAT_VEC3:j=o.uniform3fv;p=l?Float32Array:new Float32Array(3);break;case o.FLOAT_VEC4:j=o.uniform4fv;p=l?Float32Array:new Float32Array(4);
break;case o.INT:case o.BOOL:case o.SAMPLER_2D:case o.SAMPLER_CUBE:j=o.uniform1i;break;case o.INT_VEC2:case o.BOOL_VEC2:j=o.uniform2iv;p=l?Uint16Array:new Uint16Array(2);break;case o.INT_VEC3:case o.BOOL_VEC3:j=o.uniform3iv;p=l?Uint16Array:new Uint16Array(3);break;case o.INT_VEC4:case o.BOOL_VEC4:j=o.uniform4iv;p=l?Uint16Array:new Uint16Array(4);break;case o.FLOAT_MAT2:c=true;j=o.uniformMatrix2fv;break;case o.FLOAT_MAT3:c=true;j=o.uniformMatrix3fv;break;case o.FLOAT_MAT4:c=true;j=o.uniformMatrix4fv}if(j.bind)j=
j.bind(o);else{var u=j;j=function(){u.apply(o,arguments)}}return l?function(x){j(g,new p(x))}:c?function(x){j(g,false,x.toFloat32Array())}:p?function(x){p.set(x);j(g,p)}:function(x){j(g,x)};throw"Unknown type: "+d;},k=function(d,f){var l=o,g=l.createProgram();l.attachShader(g,w(l,d,l.VERTEX_SHADER));l.attachShader(g,w(l,f,l.FRAGMENT_SHADER));l.linkProgram(g);if(!l.getProgramParameter(g,l.LINK_STATUS))throw"Error linking the shader: "+l.getProgramInfoLog(g);if(!g)return false;l={};for(var c={},n={},
j=o.getProgramParameter(g,o.ACTIVE_ATTRIBUTES),p=0;p<j;p++){var u=o.getActiveAttrib(g,p),x=u.name;u=o.getAttribLocation(g,u.name);l[x]=u;c[x]=false}j=o.getProgramParameter(g,o.ACTIVE_UNIFORMS);for(p=0;p<j;p++){u=o.getActiveUniform(g,p);x=u.name;x=x[x.length-1]=="]"?x.substr(0,x.length-3):x;n[x]=i(g,u,u.name!=x)}this.program=g;this.attributes=l;this.attributeEnabled=c;this.uniforms=n};k.prototype={$$family:"program",setUniform:function(d,f){if(this.uniforms[d])this.uniforms[d](f);return this},setUniforms:function(d){for(var f in d)this.setUniform(f,
d[f]);return this}};["setBuffer","setBuffers","use"].forEach(function(d){k.prototype[d]=function(){var f=Array.prototype.slice.call(arguments);f.unshift(this);N[d].apply(N,f);return this}});["setFrameBuffer","setFrameBuffers","setRenderBuffer","setRenderBuffers","setTexture","setTextures"].forEach(function(d){k.prototype[d]=function(){N[d].apply(N,arguments);return this}});k.fromShaderIds=function(){var d=z.apply({},arguments),f=t(d.vs);d=t(d.fs);return new k(f.innerHTML,d.innerHTML)};k.fromShaderSources=
function(d){d=z.apply({},arguments);return new k(d.vs,d.fs)};k.fromDefaultShaders=function(){var d=z.apply({},arguments),f=PhiloGL.Shaders;return PhiloGL.Program.fromShaderSources(f.Vertex[d.vs||"Default"],f.Fragment[d.fs||"Default"])};k.fromShaderURIs=function(d){d=t.merge({path:"",vs:"",fs:"",noCache:false,onSuccess:t.empty,onError:t.empty},d||{});(new PhiloGL.IO.XHR.Group({urls:[d.path+d.vs,d.path+d.fs],noCache:d.noCache,onError:function(f){d.onError(f)},onComplete:function(f){d.onSuccess(k.fromShaderSources(f[0],
f[1]),d)}})).send()};PhiloGL.Program=k})();(function(){var z={},w=function(d){this.opt=d=t.merge({url:"http://philogljs.org/",method:"GET",async:true,noCache:false,sendAsBinary:false,responseType:false,onProgress:t.empty,onSuccess:t.empty,onError:t.empty,onAbort:t.empty,onComplete:t.empty},d||{});this.initXHR()};w.State={};["UNINITIALIZED","LOADING","LOADED","INTERACTIVE","COMPLETED"].forEach(function(d,f){w.State[d]=f});w.prototype={initXHR:function(){var d=this.req=new XMLHttpRequest,f=this;["Progress",
"Error","Abort","Load"].forEach(function(l){d.addEventListener(l.toLowerCase(),function(g){f["handle"+l](g)},false)})},send:function(d){var f=this.req,l=this.opt,g=l.async;if(l.noCache)l.url+=(l.url.indexOf("?")>=0?"&":"?")+t.uid();f.open(l.method,l.url,g);if(l.responseType)f.responseType=l.responseType;if(g)f.onreadystatechange=function(){if(f.readyState==w.State.COMPLETED)if(f.status==200)l.onSuccess(f.responseType?f.response:f.responseText);else l.onError(f.status)};l.sendAsBinary?f.sendAsBinary(d||
l.body||null):f.send(d||l.body||null);if(!g)if(f.status==200)l.onSuccess(f.responseType?f.response:f.responseText);else l.onError(f.status)},setRequestHeader:function(d,f){this.req.setRequestHeader(d,f);return this},handleProgress:function(d){if(d.lengthComputable)this.opt.onProgress(d,Math.round(d.loaded/d.total*100));else this.opt.onProgress(d,-1)},handleError:function(d){this.opt.onError(d)},handleAbort:function(){this.opt.onAbort(e)},handleLoad:function(d){this.opt.onComplete(d)}};w.Group=function(d){function f(j){return function(p){--c;
d.onError(p,j);if(!c)d.onComplete(n)}}function l(j){return function(p){--c;n[j]=p;d.onSuccess(p,j);if(!c)d.onComplete(n)}}d=t.merge({urls:[],onError:t.empty,onSuccess:t.empty,onComplete:t.empty,method:"GET",async:true,noCache:false,sendAsBinary:false,responseType:false},d||{});var g=t.splat(d.urls),c=g.length,n=Array(c);this.reqs=g.map(function(j,p){return new w({url:j,method:d.method,async:d.async,noCache:d.noCache,sendAsBinary:d.sendAsBinary,responseType:d.responseType,body:d.body,onError:f(p),
onSuccess:l(p)})})};w.Group.prototype={send:function(){for(var d=0,f=this.reqs,l=f.length;d<l;++d)f[d].send()}};var i=function(d){d=t.merge({url:"http://philogljs.org/",data:{},noCache:false,onComplete:t.empty,callbackKey:"callback"},d||{});var f=i.counter++,l=[],g;for(g in d.data)l.push(g+"="+d.data[g]);l=l.join("&");if(d.noCache)l+=(l.indexOf("?")>=0?"&":"?")+t.uid();l=d.url+(d.url.indexOf("?")>-1?"&":"?")+d.callbackKey+"=PhiloGL.IO.JSONP.requests.request_"+f+(l.length>0?"&"+l:"");var c=document.createElement("script");
c.type="text/javascript";c.src=l;i.requests["request_"+f]=function(n){d.onComplete(n);c.parentNode&&c.parentNode.removeChild(c);c.clearAttributes&&c.clearAttributes()};document.getElementsByTagName("head")[0].appendChild(c)};i.counter=0;i.requests={};var k=function(d){d=t.merge({src:[],noCache:false,onProgress:t.empty,onComplete:t.empty},d||{});var f=0,l=d.src.length,g=function(){d.onProgress(Math.round(++f/l*100));if(f==l)d.onComplete(p)},c=function(){if(++f==l)d.onComplete(p)},n=d.noCache,j=t.uid(),
p=d.src.map(function(u,x){var s=new Image;s.index=x;s.onload=g;s.onerror=c;s.src=u+(n?(u.indexOf("?")>=0?"&":"?")+j:"");return s});return p};z.XHR=w;z.JSONP=i;z.Images=k;z.Textures=function(d){d=t.merge({src:[],noCache:false,onComplete:t.empty},d||{});k({src:d.src,noCache:d.noCache,onComplete:function(f){var l={};f.forEach(function(g,c){l[d.src[c]]=t.merge({data:{value:g}},d)});N.setTextures(l);d.onComplete()}})};PhiloGL.IO=z})();(function(){var z=PhiloGL.Vec3,w=PhiloGL.Mat4,i=function(k,d,f,l,g){g=
g||{};var c=g.position,n=g.target,j=g.up;this.type=g.type?g.type:"perspective";this.fov=k;this.near=f;this.far=l;this.aspect=d;this.position=c&&new z(c.x,c.y,c.z)||new z;this.target=n&&new z(n.x,n.y,n.z)||new z;this.up=j&&new z(j.x,j.y,j.z)||new z(0,1,0);if(this.type=="perspective")this.projection=(new w).perspective(k,d,f,l);else{k=f*Math.tan(k*Math.PI/360);g=-k;this.projection=(new w).ortho(g*d,k*d,g,k,f,l)}this.view=new w};i.prototype={update:function(){if(this.type=="perspective")this.projection=
(new w).perspective(this.fov,this.aspect,this.near,this.far);else{var k=this.near*Math.tan(this.fov*Math.PI/360),d=-k,f=d*this.aspect,l=k*this.aspect;this.projection=(new w).ortho(f,l,d,k,this.near,this.far)}this.view.lookAt(this.position,this.target,this.up)}};PhiloGL.Camera=i})();(function(){function z(c,n){if(c&&c.length<n){for(var j=c[0],p=c[1],u=c[2],x=c[3],s=[j,p,u,x],v=n/c.length,a;--v;){a=v*4;s[a]=j;s[a+1]=p;s[a+2]=u;s[a+3]=x}return new Float32Array(s)}else return c}var w=PhiloGL.Vec3,i=PhiloGL.Mat4,
k=Math.cos,d=Math.sin,f=Math.PI,l=Array.prototype.slice,g={};g.Model=function(c){c=c||{};this.id=c.id||t.uid();this.pickable=!!c.pickable;this.pick=c.pick||function(){return false};if(c.pickingColors)this.pickingColors=c.pickingColors;this.vertices=c.vertices;this.normals=c.normals;this.textures=c.textures&&t.splat(c.textures);this.colors=c.colors;this.indices=c.indices;this.shininess=c.shininess||0;this.reflection=c.reflection||0;this.refraction=c.refraction||0;if(c.texCoords)this.texCoords=c.texCoords;
this.uniforms=c.uniforms||{};this.attributes=c.attributes||{};this.render=c.render;this.drawType=c.drawType||"TRIANGLES";this.display="display"in c?c.display:true;this.onBeforeRender=c.onBeforeRender||t.empty;this.onAfterRender=c.onAfterRender||t.empty;if(c.program)this.program=c.program;this.position=new w;this.rotation=new w;this.scale=new w(1,1,1);this.matrix=new i;c.computeCentroids&&this.computeCentroids();c.computeNormals&&this.computeNormals()};g.Model.prototype=Object.create(null,{vertices:{set:function(c){if(c){var n=
c.length;if(c.BYTES_PER_ELEMENT)this.$vertices=c;else if(this.$verticesLength==n)this.$vertices.set(c);else this.$vertices=new Float32Array(c);this.$verticesLength=n}},get:function(){return this.$vertices}},normals:{set:function(c){if(c){var n=c.length;if(c.BYTES_PER_ELEMENT)this.$normals=c;else if(this.$normalsLength==n)this.$normals.set(c);else this.$normals=new Float32Array(c);this.$normalsLength=n}},get:function(){return this.$normals}},colors:{set:function(c){if(c){var n=c.length;if(c.BYTES_PER_ELEMENT)this.$colors=
c;else if(this.$colorsLength==n)this.$colors.set(c);else this.$colors=new Float32Array(c);if(this.$vertices&&this.$verticesLength/3*4!=n)this.$colors=z(l.call(this.$colors),this.$verticesLength/3*4);this.$colorsLength=this.$colors.length}},get:function(){return this.$colors}},pickingColors:{set:function(c){if(c){var n=c.length;if(c.BYTES_PER_ELEMENT)this.$pickingColors=c;else if(this.$pickingColorsLength==n)this.$pickingColors.set(c);else this.$pickingColors=new Float32Array(c);if(this.$vertices&&
this.$verticesLength/3*4!=n)this.$pickingColors=z(l.call(this.$pickingColors),this.$verticesLength/3*4);this.$pickingColorsLength=this.$pickingColors.length}},get:function(){return this.$pickingColors}},texCoords:{set:function(c){if(c)if(t.type(c)=="object"){var n={},j;for(j in c){var p=c[j];n[j]=p.BYTES_PER_ELEMENT?p:new Float32Array(p)}this.$texCoords=n}else{n=c.length;if(c.BYTES_PER_ELEMENT)this.$texCoords=c;else if(this.$texCoordsLength==n)this.$texCoords.set(c);else this.$texCoords=new Float32Array(c);
this.$texCoordsLength=n}},get:function(){return this.$texCoords}},indices:{set:function(c){if(c){var n=c.length;if(c.BYTES_PER_ELEMENT)this.$indices=c;else if(this.$indicesLength==n)this.$indices.set(c);else this.$indices=new Uint16Array(c);this.$indicesLength=n}},get:function(){return this.$indices}}});t.extend(g.Model.prototype,{$$family:"model",update:function(){var c=this.matrix,n=this.position,j=this.rotation,p=this.scale;c.id();c.$translate(n.x,n.y,n.z);c.$rotateXYZ(j.x,j.y,j.z);c.$scale(p.x,
p.y,p.z)},computeCentroids:function(){var c=this.vertices,n=[];this.faces.forEach(function(j){var p=[0,0,0],u=0;j.forEach(function(x){x=c[x];p[0]+=x[0];p[1]+=x[1];p[2]+=x[2];u++});p[0]/=u;p[1]/=u;p[2]/=u;n.push(p)});this.centroids=n},computeNormals:function(){var c=this.vertices,n=[];this.faces.forEach(function(j){var p=c[j[0]],u=c[j[1]];j=c[j[2]];p={x:p[0]-u[0],y:p[1]-u[1],z:p[2]-u[2]};w.$cross(p,{x:j[0]-u[0],y:j[1]-u[1],z:j[1]-u[2]});w.norm(p)>1.0E-6&&w.unit(p);n.push([p.x,p.y,p.z])});this.normals=
n}});t.extend(g.Model.prototype,{setUniforms:function(c){c.setUniforms(this.uniforms)},setAttributes:function(c){var n=this.attributes,j;for(j in n){var p=n[j],u=this.id+"-"+j;if(Object.keys(p).length){p.attribute=j;c.setBuffer(u,p);delete p.value}else c.setBuffer(u,true)}},unsetAttributes:function(c){var n=this.attributes,j;for(j in n)c.setBuffer(this.id+"-"+j,false)},setShininess:function(c){c.setUniform("shininess",this.shininess||0)},setReflection:function(c){this.reflection||this.refraction?
c.setUniforms({useReflection:true,refraction:this.refraction,reflection:this.reflection}):c.setUniform("useReflection",false)},setVertices:function(c,n){var j="vertices-"+this.id;if(this.vertices)n||this.dynamic?c.setBuffer(j,{attribute:"position",value:this.vertices,size:3}):c.setBuffer(j);else c.attributeEnabled[j]&&this.unsetVertices(c)},unsetVertices:function(c){c.setBuffer("vertices-"+this.id,false)},setNormals:function(c,n){var j="normals-"+this.id;if(this.normals)n||this.dynamic?c.setBuffer(j,
{attribute:"normal",value:this.normals,size:3}):c.setBuffer(j);else c.attributeEnabled[j]&&this.unsetNormals(c)},unsetNormals:function(c){c.setBuffer("normals-"+this.id,false)},setIndices:function(c,n){var j="indices-"+this.id;if(this.indices)n||this.dynamic?c.setBuffer(j,{bufferType:o.ELEMENT_ARRAY_BUFFER,drawType:o.STATIC_DRAW,value:this.indices,size:1}):c.setBuffer(j);else c.attributeEnabled[j]&&this.unsetIndices(c)},unsetIndices:function(c){c.setBuffer("indices-"+this.id,false)},setPickingColors:function(c,
n){var j="pickingColors-"+this.id;if(this.pickingColors)n||this.dynamic?c.setBuffer(j,{attribute:"pickingColor",value:this.pickingColors,size:4}):c.setBuffer(j);else c.attributeEnabled[j]&&this.unsetPickingColors(c)},unsetPickingColors:function(c){c.setBuffer("pickingColors-"+this.id,false)},setColors:function(c,n){var j="colors-"+this.id;if(this.colors)n||this.dynamic?c.setBuffer(j,{attribute:"color",value:this.colors,size:4}):c.setBuffer(j);else c.attributeEnabled[j]&&this.unsetColors(c)},unsetColors:function(c){c.setBuffer("colors-"+
this.id,false)},setTexCoords:function(c,n){var j=this.id,p="texCoords-"+j,u=t.type(this.texCoords);if(this.texCoords)if(n||this.dynamic)u=="object"?this.textures.forEach(function(x,s){c.setBuffer("texCoords-"+s+"-"+j,{attribute:"texCoord"+(s+1),value:this.texCoords[x],size:2})}):c.setBuffer(p,{attribute:"texCoord1",value:this.texCoords,size:2});else u=="object"?this.textures.forEach(function(x,s){c.setBuffer("texCoords-"+s+"-"+j)}):c.setBuffer(p);else if(u!="object"&&c.attributeEnabled[p]||u=="object"&&
c.attributeEnabled["texCoords-0-"+j])this.unsetTexCoords(c)},unsetTexCoords:function(c){c.setBuffer("texCoords-"+this.id,false)},setTextures:function(c){this.textures=this.textures?t.splat(this.textures):[];for(var n=0,j=this.textures,p=j.length,u=PhiloGL.Scene.MAX_TEXTURES;n<u;n++){if(n<p)if(N.textureMemo[j[n]].isCube){c.setUniform("hasTextureCube"+(n+1),true);c.setTexture(j[n],o["TEXTURE"+(n+5)])}else{c.setUniform("hasTexture"+(n+1),true);c.setTexture(j[n],o["TEXTURE"+n])}else{c.setUniform("hasTextureCube"+
(n+1),false);c.setUniform("hasTexture"+(n+1),false)}c.setUniform("sampler"+(n+1),n);c.setUniform("samplerCube"+(n+1),n+5)}}});g.Cube=function(c){g.Model.call(this,t.extend({vertices:[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1],texCoords:[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1],normals:[0,0,1,0,0,1,0,0,1,0,
0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]},c||{}))};g.Cube.prototype=Object.create(g.Model.prototype);g.Sphere=function(c){var n=c.nlat||10,j=c.nlong||10,p=c.radius||1,u=f-0,x=2*f-0,s=(n+1)*(j+1),v=new Float32Array(s*3),a=new Float32Array(s*3);s=new Float32Array(s*2);var b=new Uint16Array(n*j*6);if(typeof p==
"number"){var h=p;p=function(){return h}}for(var m=0;m<=n;m++)for(var q=0;q<=j;q++){var r=q/j,y=m/n,A=x*r,B=u*y,C=d(A);A=k(A);var D=d(B),E=k(B);B=A*D;A=E;C*=D;D=p(B,A,C,r,y);E=q+m*(j+1);var G=E*3;E*=2;v[G+0]=D*B;v[G+1]=D*A;v[G+2]=D*C;a[G+0]=B;a[G+1]=A;a[G+2]=C;s[E+0]=r;s[E+1]=y}p=n+1;for(q=0;q<n;q++)for(m=0;m<j;m++){E=(q*j+m)*6;b[E+0]=m*p+q;b[E+1]=m*p+q+1;b[E+2]=(m+1)*p+q;b[E+3]=(m+1)*p+q;b[E+4]=m*p+q+1;b[E+5]=(m+1)*p+q+1}g.Model.call(this,t.extend({vertices:v,indices:b,normals:a,texCoords:s},c||
{}))};g.Sphere.prototype=Object.create(g.Model.prototype);g.IcoSphere=function(c){var n=c.iterations||0,j=[],p=[],u=Math.sqrt,x=Math.acos,s=Math.atan2,v=Math.PI,a=v*2;c.onAddVertex=c.onAddVertex||t.empty;var b=(1+u(5))/2,h=u(1+b*b);j.push(-1/h,b/h,0,1/h,b/h,0,-1/h,-b/h,0,1/h,-b/h,0,0,-1/h,b/h,0,1/h,b/h,0,-1/h,-b/h,0,1/h,-b/h,b/h,0,-1/h,b/h,0,1/h,-b/h,0,-1/h,-b/h,0,1/h);p.push(0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,
7,9,8,1);var m=function(){var W={};return function(S,T){S*=3;T*=3;var X=(S<T?S:T)+"|"+(S>T?S:T);if(X in W)return W[X];var O=(j[S]+j[T])/2,Y=(j[S+1]+j[T+1])/2,Z=(j[S+2]+j[T+2])/2,$=u(O*O+Y*Y+Z*Z);O/=$;Y/=$;Z/=$;j.push(O,Y,Z);return W[X]=j.length/3-1}}();for(b=0;b<n;b++){var q=[],r=0;for(h=p.length;r<h;r+=3){var y=m(p[r],p[r+1]),A=m(p[r+1],p[r+2]),B=m(p[r+2],p[r]);q.push(p[r],y,B,p[r+1],A,y,p[r+2],B,A,y,A,B)}p=q}h=p.length;n=new Float32Array(h*3);m=new Float32Array(h*2);for(b=0;b<h;b+=3){A=p[b];B=p[b+
1];var C=p[b+2];q=A*3;r=B*3;y=C*3;A*=2;B*=2;C*=2;var D=j[q],E=j[q+1],G=j[q+2],I=x(G/u(D*D+E*E+G*G)),J=s(E,D);I/=v;J=1-J/a;var H=j[r],F=j[r+1],M=j[r+2],K=x(M/u(H*H+F*F+M*M)),L=s(F,H);K/=v;L=1-L/a;var P=j[y],Q=j[y+1],R=j[y+2],U=x(R/u(P*P+Q*Q+R*R)),V=s(Q,P);U/=v;V=1-V/a;D=w.cross({x:P-H,y:Q-F,z:R-M},{x:D-H,y:E-F,z:G-M}).$unit();n[q]=n[r]=n[y]=D.x;n[q+1]=n[r+1]=n[y+1]=D.y;n[q+2]=n[r+2]=n[y+2]=D.z;m[A]=J;m[A+1]=I;m[B]=L;m[B+1]=K;m[C]=V;m[C+1]=U}g.Model.call(this,t.extend({vertices:j,indices:p,normals:n,
texCoords:m},c||{}))};g.IcoSphere.prototype=Object.create(g.Model.prototype);g.TruncatedCone=function(c){var n=c.bottomRadius||0,j=c.topRadius||0,p=c.height||1,u=c.nradial||10,x=c.nvertical||10,s=!!c.topCap,v=!!c.bottomCap,a=(s?2:0)+(v?2:0),b=(u+1)*(x+1+a),h=new Float32Array(b*3),m=new Float32Array(b*3);b=new Float32Array(b*2);var q=new Uint16Array(u*(x+a)*6),r=u+1,y=Math,A=y.atan2(n-j,p),B=y.sin,C=y.cos;y=y.PI;var D=C(A);A=B(A);v=x+(v?2:0);var E=0,G=0;for(s=s?-2:0;s<=v;s++){var I=s/x,J=p*I,H;if(s<
0){J=0;I=1;H=n}else if(s>x){J=p;I=1;H=j}else H=n+(j-n)*(s/x);if(s==-2||s==x+2)I=H=0;J-=p/2;for(var F=0;F<r;F++){var M=B(F*y*2/u),K=C(F*y*2/u);h[E+0]=M*H;h[E+1]=J;h[E+2]=K*H;m[E+0]=s<0||s>x?0:M*D;m[E+1]=s<0?-1:s>x?1:A;m[E+2]=s<0||s>x?0:K*D;b[G+0]=F/u;b[G+1]=I;G+=2;E+=3}}for(s=0;s<x+a;s++)for(F=0;F<u;F++){n=(s*u+F)*6;q[n+0]=r*(s+0)+0+F;q[n+1]=r*(s+0)+1+F;q[n+2]=r*(s+1)+1+F;q[n+3]=r*(s+0)+0+F;q[n+4]=r*(s+1)+1+F;q[n+5]=r*(s+1)+0+F}g.Model.call(this,t.extend({vertices:h,normals:m,texCoords:b,indices:q},
c||{}))};g.TruncatedCone.prototype=Object.create(g.Model.prototype);g.Cone=function(c){c.topRadius=0;c.topCap=!!c.cap;c.bottomCap=!!c.cap;c.bottomRadius=c.radius||3;g.TruncatedCone.call(this,c)};g.Cone.prototype=Object.create(g.TruncatedCone.prototype);g.Cylinder=function(c){c.bottomRadius=c.radius;c.topRadius=c.radius;g.TruncatedCone.call(this,c)};g.Cylinder.prototype=Object.create(g.TruncatedCone.prototype);g.Plane=function(c){var n=c.type,j=n.split(","),p=c[j[0]+"len"],u=c[j[1]+"len"],x=c["n"+
j[0]]||1;j=c["n"+j[1]]||1;var s=c.offset;numVertices=(x+1)*(j+1);positions=new Float32Array(numVertices*3);normals=new Float32Array(numVertices*3);texCoords=new Float32Array(numVertices*2);for(var v=i3=i2=0;v<=j;v++)for(var a=0;a<=x;a++){var b=a/x,h=v/j;texCoords[i2+0]=b;texCoords[i2+1]=h;i2+=2;switch(n){case "x,y":positions[i3+0]=p*b-p*0.5;positions[i3+1]=u*h-u*0.5;positions[i3+2]=s;normals[i3+0]=0;normals[i3+1]=0;normals[i3+2]=1;break;case "x,z":positions[i3+0]=p*b-p*0.5;positions[i3+1]=s;positions[i3+
2]=u*h-u*0.5;normals[i3+0]=0;normals[i3+1]=1;normals[i3+2]=0;break;case "y,z":positions[i3+0]=s;positions[i3+1]=p*b-p*0.5;positions[i3+2]=u*h-u*0.5;normals[i3+0]=1;normals[i3+1]=0;normals[i3+2]=0}i3+=3}n=x+1;p=[];for(v=0;v<j;v++)for(a=0;a<x;a++){u=(v*x+a)*6;p[u+0]=(v+0)*n+a;p[u+1]=(v+1)*n+a;p[u+2]=(v+0)*n+a+1;p[u+3]=(v+1)*n+a;p[u+4]=(v+1)*n+a+1;p[u+5]=(v+0)*n+a+1}g.Model.call(this,t.extend({vertices:positions,normals:normals,texCoords:texCoords,indices:p},c))};g.Plane.prototype=Object.create(g.Model.prototype);
g.id=t.time();PhiloGL.O3D=g})();(function(){var z={Vertex:{},Fragment:{}},w=z.Fragment;z.Vertex.Default="#define LIGHT_MAX 40\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color;\nattribute vec4 pickingColor;\nattribute vec2 texCoord1;\nuniform mat4 viewMatrix;\nuniform mat4 viewInverseMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 viewProjectionMatrix;\nuniform mat4 worldMatrix;\nuniform mat4 worldInverseMatrix;\nuniform mat4 worldInverseTransposeMatrix;\nuniform mat4 objectMatrix;\nuniform vec3 cameraPosition;\nuniform bool enableLights;\nuniform vec3 ambientColor;\nuniform vec3 directionalColor;\nuniform vec3 lightingDirection;\nuniform vec3 pointLocation[LIGHT_MAX];\nuniform vec3 pointColor[LIGHT_MAX];\nuniform int numberPoints;\nuniform bool useReflection;\nvarying vec3 vReflection;\nvarying vec4 vColor;\nvarying vec4 vPickingColor;\nvarying vec2 vTexCoord;\nvarying vec4 vNormal;\nvarying vec3 lightWeighting;\nvoid main(void) {\nvec4 mvPosition = worldMatrix * vec4(position, 1.0);\nvec4 transformedNormal = worldInverseTransposeMatrix * vec4(normal, 1.0);\nif(!enableLights) {\nlightWeighting = vec3(1.0, 1.0, 1.0);\n} else {\nvec3 plightDirection;\nvec3 pointWeight = vec3(0.0, 0.0, 0.0);\nfloat directionalLightWeighting = max(dot(transformedNormal.xyz, lightingDirection), 0.0);\nfor (int i = 0; i < LIGHT_MAX; i++) {\nif (i < numberPoints) {\nplightDirection = normalize((viewMatrix * vec4(pointLocation[i], 1.0)).xyz - mvPosition.xyz);\npointWeight += max(dot(transformedNormal.xyz, plightDirection), 0.0) * pointColor[i];\n} else {\nbreak;\n}\n}\nlightWeighting = ambientColor + (directionalColor * directionalLightWeighting) + pointWeight;\n}\nif (useReflection) {\nvReflection = (viewInverseMatrix[3] - (worldMatrix * vec4(position, 1.0))).xyz;\n} else {\nvReflection = vec3(1.0, 1.0, 1.0);\n}\nvColor = color;\nvPickingColor = pickingColor;\nvTexCoord = texCoord1;\nvNormal = transformedNormal;\ngl_Position = projectionMatrix * worldMatrix * vec4(position, 1.0);\n}";
w.Default="#ifdef GL_ES\nprecision highp float;\n#endif\nvarying vec4 vColor;\nvarying vec4 vPickingColor;\nvarying vec2 vTexCoord;\nvarying vec3 lightWeighting;\nvarying vec3 vReflection;\nvarying vec4 vNormal;\nuniform bool hasTexture1;\nuniform sampler2D sampler1;\nuniform bool hasTextureCube1;\nuniform samplerCube samplerCube1;\nuniform bool enablePicking;\nuniform bool hasPickingColors;\nuniform vec3 pickColor;\nuniform float reflection;\nuniform float refraction;\nuniform bool hasFog;\nuniform vec3 fogColor;\nuniform float fogNear;\nuniform float fogFar;\nvoid main(){\nif (!hasTexture1) {\ngl_FragColor = vec4(vColor.rgb * lightWeighting, vColor.a);\n} else {\ngl_FragColor = vec4(texture2D(sampler1, vec2(vTexCoord.s, vTexCoord.t)).rgb * lightWeighting, 1.0);\n}\nif (hasTextureCube1) {\nvec3 nReflection = normalize(vReflection);\nvec3 reflectionValue;\nif (refraction > 0.0) {\nreflectionValue = refract(nReflection, vNormal.xyz, refraction);\n} else {\nreflectionValue = -reflect(nReflection, vNormal.xyz);\n}\nvec4 cubeColor = textureCube(samplerCube1, vec3(-reflectionValue.x, -reflectionValue.y, reflectionValue.z));\ngl_FragColor = vec4(mix(gl_FragColor.xyz, cubeColor.xyz, reflection), 1.0);\n}\nif (enablePicking) {\nif (hasPickingColors) {\ngl_FragColor = vPickingColor;\n} else {\ngl_FragColor = vec4(pickColor, 1.0);\n}\n}\nif (hasFog) {\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\nfloat fogFactor = smoothstep(fogNear, fogFar, depth);\ngl_FragColor = mix(gl_FragColor, vec4(fogColor, gl_FragColor.w), fogFactor);\n}\n}";
PhiloGL.Shaders=z})();(function(){var z=PhiloGL.Vec3,w=function(i,k,d){d=t.merge({lights:{enable:false,ambient:{r:0.2,g:0.2,b:0.2},directional:{direction:{x:1,y:1,z:1},color:{r:0,g:0,b:0}}},effects:{fog:false}},d||{});this.program=d.program?i[d.program]:i;this.camera=k;this.models=[];this.config=d};w.prototype={add:function(){for(var i=0,k=this.models,d=arguments.length;i<d;i++){var f=arguments[i];f.id=f.id||t.uid();k.push(f);this.defineBuffers(f)}},remove:function(i){var k=this.models;i=k.indexOf(i);
i>-1&&k.splice(i,1)},getProgram:function(i){var k=this.program;if(k.$$family!="program"&&i&&i.program){k=k[i.program];k.use()}return k},defineBuffers:function(i){var k=this.getProgram(i);i.setAttributes(k,true);i.setVertices(k,true);i.setColors(k,true);i.setPickingColors(k,true);i.setNormals(k,true);i.setTexCoords(k,true);i.setIndices(k,true)},beforeRender:function(i){this.setupLighting(i);this.setupEffects(i);var k=this.camera,d=k.position,f=k.view;k=k.projection;var l=f.mulMat4(k),g=l.invert();
i.setUniforms({cameraPosition:[d.x,d.y,d.z],projectionMatrix:k,viewMatrix:f,viewProjectionMatrix:l,viewInverseMatrix:f.invert(),viewProjectionInverseMatrix:g})},setupLighting:function(i){var k=this.config.lights,d=k.ambient,f=k.directional,l=f.color,g=f.direction,c=k.enable;k=k.points&&t.splat(k.points)||[];f=k.length;var n=[],j=[],p=[],u=[];g=(new z(g.x,g.y,g.z)).$unit().$scale(-1);i.setUniform("enableLights",c);if(c){i.setUniform("ambientColor",[d.r,d.g,d.b]);i.setUniform("directionalColor",[l.r,
l.g,l.b]);i.setUniform("lightingDirection",[g.x,g.y,g.z]);i.setUniform("numberPoints",f);for(d=0;d<f;d++){c=k[d];l=c.position;g=c.color||c.diffuse;c=c.specular;n.push(l.x,l.y,l.z);j.push(g.r,g.g,g.b);p.push(+!!c);c?u.push(c.r,c.g,c.b):u.push(0,0,0)}i.setUniforms({pointLocation:n,pointColor:j});i.setUniforms({enableSpecular:p,pointSpecularColor:u})}},setupEffects:function(i){var k=this.config.effects.fog,d=k.color||{r:0.5,g:0.5,b:0.5};k?i.setUniforms({hasFog:true,fogNear:k.near,fogFar:k.far,fogColor:[d.r,
d.g,d.b]}):i.setUniform("hasFog",false)},render:function(i){i=i||{};var k=this.camera,d=this.program,f=i.renderProgram,l=t.type(d);l=!f&&l=="object";i=t.merge({onBeforeRender:t.empty,onAfterRender:t.empty},i||{});!l&&this.beforeRender(f||d);for(var g=0,c=this.models,n=c.length;g<n;++g){var j=c[g];if(j.display){d=f||this.getProgram(j);l&&this.beforeRender(d);j.onBeforeRender(d,k);i.onBeforeRender(j,g);this.renderObject(j,d);i.onAfterRender(j,g);j.onAfterRender(d,k)}}},renderToTexture:function(i,k){k=
k||{};var d=N.textures[i+"-texture"],f=N.textureMemo[i+"-texture"];this.render(k);o.bindTexture(f.textureType,d);o.generateMipmap(f.textureType);o.bindTexture(f.textureType,null)},renderObject:function(i,k){var d=this.camera,f=i.matrix,l=d.view.mulMat4(f),g=l.invert(),c=g.transpose();i.setUniforms(k);i.setAttributes(k);i.setShininess(k);i.setReflection(k);i.setVertices(k);i.setColors(k);i.setPickingColors(k);i.setNormals(k);i.setTextures(k);i.setTexCoords(k);i.setIndices(k);k.setUniforms({objectMatrix:f,
worldMatrix:l,worldInverseMatrix:g,worldInverseTransposeMatrix:c});if(i.render)i.render(o,k,d);else i.indices?o.drawElements(i.drawType!==undefined?o.get(i.drawType):o.TRIANGLES,i.indices.length,o.UNSIGNED_SHORT,0):o.drawArrays(i.drawType!==undefined?o.get(i.drawType):o.TRIANGLES,0,i.vertices.length/3);i.unsetAttributes(k)},setupPicking:function(){var i=PhiloGL.Program.fromDefaultShaders(),k=w.PICKING_RES;N.setFrameBuffer("$picking",{width:N.canvas.width/k>>0,height:N.canvas.height/k>>0,bindToTexture:{parameters:[{name:"TEXTURE_MAG_FILTER",
value:"LINEAR"},{name:"TEXTURE_MIN_FILTER",value:"LINEAR",generateMipmap:false}]},bindToRenderBuffer:true});N.setFrameBuffer("$picking",false);this.pickingProgram=i},pick:function(i,k){this.pickingProgram||this.setupPicking();var d={},f=[],l=N.usedProgram,g=this.pickingProgram,c=w.PICKING_RES,n=this.config,j=n.lights.enable,p=n.effects.fog,u=o.canvas.width,x=o.canvas.height,s=[],v=new Uint8Array(4),a=0,b;n.lights.enable=false;n.effects.fog=false;g.use();N.setFrameBuffer("$picking",true);g.setUniform("enablePicking",
true);o.disable(o.BLEND);o.viewport(0,0,u/c,x/c);o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);o.readPixels(0,0,1,1,o.RGBA,o.UNSIGNED_BYTE,v);b=v[0]+v[1]*256+v[2]*65536;this.renderToTexture("$picking",{renderProgram:g,onBeforeRender:function(m,q){if(q==b)a=1;var r=q+a,y=!!m.pickingColors;g.setUniform("hasPickingColors",y);if(y)f.push(m);else{s[0]=r%256;s[1]=(r/256>>0)%256;s[2]=(r/65536>>0)%256;g.setUniform("pickColor",[s[0]/255,s[1]/255,s[2]/255]);d[s.join()]=m}}});o.readPixels(i/c>>0,(x-k)/c>>0,
1,1,o.RGBA,o.UNSIGNED_BYTE,v);c=[v[0],v[1],v[2]].join();c=d[c];if(!c){x=0;for(var h=f.length;x<h;x++){c=f[x];u=c.pick(v);if(u!==false)c.$pickingIndex=u;else c=false}}N.setFrameBuffer("$picking",false);g.setUniform("enablePicking",false);n.lights.enable=j;n.effects.fog=p;l&&l.use();return c&&c.pickable&&c}};w.MAX_TEXTURES=10;w.MAX_POINT_LIGHTS=50;w.PICKING_RES=4;PhiloGL.Scene=w})();(function(){function z(w,i){for(var k=this.workers=[];i--;)k.push(new Worker(w))}z.prototype={map:function(w){var i=this.workers,
k=this.configs=[],d=0;for(i=i.length;d<i;d++)k.push(w&&w(d));return this},reduce:function(w){for(var i=w.reduceFn,k=this.workers,d=this.configs,f=k.length,l=w.initialValue,g=function(p){f--;l=l===undefined?p.data:i(l,p.data);if(f==0)w.onComplete(l)},c=0,n=f;c<n;c++){var j=k[c];j.onmessage=g;j.postMessage(d[c])}return this}};PhiloGL.WorkerGroup=z})();(function(){var z=function(d){this.opt=t.merge({duration:1E3,transition:function(f){return f},onCompute:t.empty,onComplete:t.empty},d||{})};z.prototype=
{timer:null,time:null,start:function(d){this.opt=t.merge(this.opt,d||{});this.time=t.time();this.animating=true},step:function(){if(this.animating){var d=t.time(),f=this.time,l=this.opt;if(d<f+l.duration){d=l.transition((d-f)/l.duration);l.onCompute.call(this,d)}else{this.animating=false;l.onCompute.call(this,1);l.onComplete.call(this)}}}};z.compute=function(d,f,l){return d+(f-d)*l};z.Transition={linear:function(d){return d}};var w=z.Transition;(function(){var d=function(g,c){c=t.splat(c);return t.extend(g,
{easeIn:function(n){return g(n,c)},easeOut:function(n){return 1-g(1-n,c)},easeInOut:function(n){return n<=0.5?g(2*n,c)/2:(2-g(2*(1-n),c))/2}})},f={Pow:function(g,c){return Math.pow(g,c[0]||6)},Expo:function(g){return Math.pow(2,8*(g-1))},Circ:function(g){return 1-Math.sin(Math.acos(g))},Sine:function(g){return 1-Math.sin((1-g)*Math.PI/2)},Back:function(g,c){c=c[0]||1.618;return Math.pow(g,2)*((c+1)*g-c)},Bounce:function(g){for(var c,n=0,j=1;;n+=j,j/=2)if(g>=(7-4*n)/11){c=j*j-Math.pow((11-6*n-11*g)/
4,2);break}return c},Elastic:function(g,c){return Math.pow(2,10*--g)*Math.cos(20*g*Math.PI*(c[0]||1)/3)}},l;for(l in f)w[l]=d(f[l]);["Quad","Cubic","Quart","Quint"].forEach(function(g,c){w[g]=d(function(n){return Math.pow(n,[c+2])})})})();var i=self||window;if(i){var k=false;["webkitAnimationTime","mozAnimationTime","animationTime","webkitAnimationStartTime","mozAnimationStartTime","animationStartTime"].forEach(function(d){if(d in i){z.animationTime=function(){return i[d]};k=true}});if(!k)z.animationTime=
t.time;k=false;["webkitRequestAnimationFrame","mozRequestAnimationFrame","requestAnimationFrame"].forEach(function(d){if(d in i){z.requestAnimationFrame=function(f){i[d](function(){f()})};k=true}});if(!k)z.requestAnimationFrame=function(d){setTimeout(function(){d()},1E3/60)}}PhiloGL.Fx=z})();(function(){var z={},w=function(){};w.postProcess=function(i){var k=N.program[i.program],d=i.fromTexture?t.splat(i.fromTexture):[],f=i.toFrameBuffer,l=!!i.toScreen,g=i.width||N.canvas.width,c=i.height||N.canvas.height;
d=new PhiloGL.O3D.Plane({type:"x,y",xlen:1,ylen:1,offset:0,textures:d,program:i.program});var n=new PhiloGL.Camera(45,1,0.1,100,{position:{x:0,y:0,z:1}}),j=new PhiloGL.Scene(k,n);n.update();if(f){f in N.frameBufferMemo||N.setFrameBuffer(f,{width:g,height:c,bindToTexture:{parameters:[{name:"TEXTURE_MAG_FILTER",value:"LINEAR"},{name:"TEXTURE_MIN_FILTER",value:"LINEAR_MIPMAP_NEAREST",generateMipmap:false}]},bindToRenderBuffer:true});k.use();N.setFrameBuffer(f,true);o.viewport(0,0,g,c);o.clear(o.COLOR_BUFFER_BIT|
o.DEPTH_BUFFER_BIT);j.add(d);k.setUniforms(i.uniforms||{});j.renderToTexture(f);N.setFrameBuffer(f,false)}else if(l){k.use();o.viewport(0,0,g,c);o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);j.add(d);k.setUniforms(i.uniforms||{});j.render()}return this};z.Image=w;PhiloGL.Media=z})()})();
