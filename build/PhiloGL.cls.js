/*

 Copyright (c) 2011 Sencha Inc. - Author: Nicolas Garcia Belmonte (http://philogb.github.com/)

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.

*/
(function(){function q(t){return document.getElementById(t)}this.PhiloGL=null;(function(){PhiloGL=function(t,o){function m(a,b,i){b.use();var k=a.canvas,n=new PhiloGL.Camera(g.fov,k.width/k.height,g.near,g.far,g);n.update();var r=new PhiloGL.Scene(b,n,j),u={$$family:"app",gl:a,canvas:k,program:b,scene:r,camera:n};d&&PhiloGL.Events.create(u,q.extend(d,{bind:u}));if(c.src.length)new PhiloGL.IO.Textures(b,q.extend(c,{onComplete:function(){i(u)}}));else i(u)}o=q.merge({context:{},camera:{fov:45,near:0.1,
far:500},program:{from:"defaults",vs:"Default",fs:"Default"},scene:{},textures:{src:[]},events:{},onLoad:q.empty,onError:q.empty},o||{});var g=o.camera,d=o.events,c=o.textures,f=o.program,h=f.from,j=o.scene;l=PhiloGL.WebGL.getContext(t,o.context);if(!l){o.onError();return null}var p={defaults:"fromDefaultShaders",ids:"fromShaderIds",sources:"fromShaderSources",uris:"fromShaderURIs"},s;for(s in p)if(h==s){program=PhiloGL.Program[p[s]](q.extend({onSuccess:function(a){m(l,a,function(b){o.onLoad(b)})},
onError:function(a){o.onError(a)}},f));break}program&&m(l,program,function(a){o.onLoad(a)})}})();PhiloGL.unpack=function(){["Vec3","Mat4","Camera","Program","WebGL","O3D","Scene","Shaders","IO","Events","WorkerGroup","Fx"].forEach(function(t){window[t]=PhiloGL[t]})};PhiloGL.version="1.1.0";var l;q.empty=function(){};q.time=Date.now||function(){return+new Date};q.uid=function(){var t=q.time();return function(){return t++}}();q.extend=function(t,o){for(var m in o)t[m]=o[m];return t};q.type=function(){var t=
Object.prototype.toString;return function(o){var m;m=t.call(o);m=m.substr(8,m.length-9).toLowerCase();if(m!="object")return m;if(o.$$family)return o.$$family;return o&&o.nodeName&&o.nodeType==1?"element":m}}();(function(){function t(o){var m=q.type(o);if(m=="object"){m={};for(var g in o)m[g]=t(o[g]);return m}else if(m=="array"){m=[];g=0;for(var d=o.length;g<d;g++)m[g]=t(o[g]);return m}else return o}q.merge=function(){for(var o={},m=0,g=arguments.length;m<g;m++){var d=arguments[m];if(q.type(d)=="object")for(var c in d){var f=
d[c],h=o[c];o[c]=h&&q.type(f)=="object"&&q.type(h)=="object"?q.merge(h,f):t(f)}}return o}})();q.splat=function(){var t=Array.isArray;return function(o){return t(o)&&o||[o]}}();(function(){var t=Math.sqrt,o=Math.sin,m=Math.cos,g=Math.tan,d=Math.PI,c=Array.prototype.slice,f=function(a,b,i){this.x=a||0;this.y=b||0;this.z=i||0},h={setVec3:function(a,b){a.x=b.x;a.y=b.y;a.z=b.z;return a},set:function(a,b,i,k){a.x=b;a.y=i;a.z=k;return a},add:function(a,b){return new f(a.x+b.x,a.y+b.y,a.z+b.z)},$add:function(a,
b){a.x+=b.x;a.y+=b.y;a.z+=b.z;return a},add2:function(a,b,i){a.x=b.x+i.x;a.y=b.y+i.y;a.z=b.z+i.z;return a},sub:function(a,b){return new f(a.x-b.x,a.y-b.y,a.z-b.z)},$sub:function(a,b){a.x-=b.x;a.y-=b.y;a.z-=b.z;return a},sub2:function(a,b,i){a.x=b.x-i.x;a.y=b.y-i.y;a.z=b.z-i.z;return a},scale:function(a,b){return new f(a.x*b,a.y*b,a.z*b)},$scale:function(a,b){a.x*=b;a.y*=b;a.z*=b;return a},neg:function(a){return new f(-a.x,-a.y,-a.z)},$neg:function(a){a.x=-a.x;a.y=-a.y;a.z=-a.z;return a},unit:function(a){var b=
f.norm(a);if(b>0)return f.scale(a,1/b);return f.clone(a)},$unit:function(a){var b=f.norm(a);if(b>0)return f.$scale(a,1/b);return a},cross:function(a,b){var i=a.x,k=a.y,n=a.z,r=b.x,u=b.y,v=b.z;return new f(k*v-n*u,n*r-i*v,i*u-k*r)},$cross:function(a,b){var i=a.x,k=a.y,n=a.z,r=b.x,u=b.y,v=b.z;a.x=k*v-n*u;a.y=n*r-i*v;a.z=i*u-k*r;return a},distTo:function(a,b){var i=a.x-b.x,k=a.y-b.y,n=a.z-b.z;return t(i*i,k*k,n*n)},distToSq:function(a,b){var i=a.x-b.x,k=a.y-b.y,n=a.z-b.z;return i*i+k*k+n*n},norm:function(a){var b=
a.x,i=a.y;a=a.z;return t(b*b+i*i+a*a)},normSq:function(a){var b=a.x,i=a.y;a=a.z;return b*b+i*i+a*a},dot:function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z},clone:function(a){return new f(a.x,a.y,a.z)}},j=f.prototype={},p;for(p in h){f[p]=h[p];j[p]=function(a){return function(){var b=c.call(arguments);b.unshift(this);return f[a].apply(f,b)}}(p)}var s=function(a,b,i,k,n,r,u,v,y,z,A,B,D,C,x,E){typeof a=="number"?this.set(a,b,i,k,n,r,u,v,y,z,A,B,D,C,x,E):this.id()};h={id:function(a){a.n11=a.n22=a.n33=a.n44=
1;a.n12=a.n13=a.n14=0;a.n21=a.n23=a.n24=0;a.n31=a.n32=a.n34=0;a.n41=a.n42=a.n43=0;return a},set:function(a,b,i,k,n,r,u,v,y,z,A,B,D,C,x,E,F){a.n11=b;a.n12=i;a.n13=k;a.n14=n;a.n21=r;a.n22=u;a.n23=v;a.n24=y;a.n31=z;a.n32=A;a.n33=B;a.n34=D;a.n41=C;a.n42=x;a.n43=E;a.n44=F;return a},mulVec3:function(a,b){var i=b.x,k=b.y,n=b.z;return new f(a.n11*i+a.n12*k+a.n13*n+a.n14,a.n21*i+a.n22*k+a.n23*n+a.n24,a.n31*i+a.n32*k+a.n33*n+a.n34)},$mulVec3:function(a,b){var i=b.x,k=b.y,n=b.z;b.x=a.n11*i+a.n12*k+a.n13*n+a.n14;
b.y=a.n21*i+a.n22*k+a.n23*n+a.n24;b.z=a.n31*i+a.n32*k+a.n33*n+a.n34;return b},mulMat42:function(a,b,i){var k=b.n11,n=b.n12,r=b.n13,u=b.n14,v=b.n21,y=b.n22,z=b.n23,A=b.n24,B=b.n31,D=b.n32,C=b.n33,x=b.n34,E=b.n41,F=b.n42,G=b.n43;b=b.n44;var H=i.n11,I=i.n12,J=i.n13,K=i.n14,L=i.n21,M=i.n22,N=i.n23,O=i.n24,P=i.n31,Q=i.n32,R=i.n33,w=i.n34,T=i.n41,U=i.n42,V=i.n43;i=i.n44;a.n11=k*H+n*L+r*P+u*T;a.n12=k*I+n*M+r*Q+u*U;a.n13=k*J+n*N+r*R+u*V;a.n14=k*K+n*O+r*w+u*i;a.n21=v*H+y*L+z*P+A*T;a.n22=v*I+y*M+z*Q+A*U;a.n23=
v*J+y*N+z*R+A*V;a.n24=v*K+y*O+z*w+A*i;a.n31=B*H+D*L+C*P+x*T;a.n32=B*I+D*M+C*Q+x*U;a.n33=B*J+D*N+C*R+x*V;a.n34=B*K+D*O+C*w+x*i;a.n41=E*H+F*L+G*P+b*T;a.n42=E*I+F*M+G*Q+b*U;a.n43=E*J+F*N+G*R+b*V;a.n44=E*K+F*O+G*w+b*i;return a},mulMat4:function(a,b){var i=a.n11,k=a.n12,n=a.n13,r=a.n14,u=a.n21,v=a.n22,y=a.n23,z=a.n24,A=a.n31,B=a.n32,D=a.n33,C=a.n34,x=a.n41,E=a.n42,F=a.n43,G=a.n44,H=b.n11,I=b.n12,J=b.n13,K=b.n14,L=b.n21,M=b.n22,N=b.n23,O=b.n24,P=b.n31,Q=b.n32,R=b.n33,w=b.n34,T=b.n41,U=b.n42,V=b.n43,W=b.n44,
S=new s;S.n11=i*H+k*L+n*P+r*T;S.n12=i*I+k*M+n*Q+r*U;S.n13=i*J+k*N+n*R+r*V;S.n14=i*K+k*O+n*w+r*W;S.n21=u*H+v*L+y*P+z*T;S.n22=u*I+v*M+y*Q+z*U;S.n23=u*J+v*N+y*R+z*V;S.n24=u*K+v*O+y*w+z*W;S.n31=A*H+B*L+D*P+C*T;S.n32=A*I+B*M+D*Q+C*U;S.n33=A*J+B*N+D*R+C*V;S.n34=A*K+B*O+D*w+C*W;S.n41=x*H+E*L+F*P+G*T;S.n42=x*I+E*M+F*Q+G*U;S.n43=x*J+E*N+F*R+G*V;S.n44=x*K+E*O+F*w+G*W;return S},$mulMat4:function(a,b){var i=a.n11,k=a.n12,n=a.n13,r=a.n14,u=a.n21,v=a.n22,y=a.n23,z=a.n24,A=a.n31,B=a.n32,D=a.n33,C=a.n34,x=a.n41,
E=a.n42,F=a.n43,G=a.n44,H=b.n11,I=b.n12,J=b.n13,K=b.n14,L=b.n21,M=b.n22,N=b.n23,O=b.n24,P=b.n31,Q=b.n32,R=b.n33,w=b.n34,T=b.n41,U=b.n42,V=b.n43,W=b.n44;a.n11=i*H+k*L+n*P+r*T;a.n12=i*I+k*M+n*Q+r*U;a.n13=i*J+k*N+n*R+r*V;a.n14=i*K+k*O+n*w+r*W;a.n21=u*H+v*L+y*P+z*T;a.n22=u*I+v*M+y*Q+z*U;a.n23=u*J+v*N+y*R+z*V;a.n24=u*K+v*O+y*w+z*W;a.n31=A*H+B*L+D*P+C*T;a.n32=A*I+B*M+D*Q+C*U;a.n33=A*J+B*N+D*R+C*V;a.n34=A*K+B*O+D*w+C*W;a.n41=x*H+E*L+F*P+G*T;a.n42=x*I+E*M+F*Q+G*U;a.n43=x*J+E*N+F*R+G*V;a.n44=x*K+E*O+F*w+G*
W;return a},add:function(a,b){var i=new s;i.n11=a.n11+b.n11;i.n12=a.n12+b.n12;i.n13=a.n13+b.n13;i.n14=a.n14+b.n14;i.n21=a.n21+b.n21;i.n22=a.n22+b.n22;i.n23=a.n23+b.n23;i.n24=a.n24+b.n24;i.n31=a.n31+b.n31;i.n32=a.n32+b.n32;i.n33=a.n33+b.n33;i.n34=a.n34+b.n34;i.n41=a.n41+b.n41;i.n42=a.n42+b.n42;i.n43=a.n43+b.n43;i.n44=a.n44+b.n44;return i},$add:function(a,b){a.n11+=b.n11;a.n12+=b.n12;a.n13+=b.n13;a.n14+=b.n14;a.n21+=b.n21;a.n22+=b.n22;a.n23+=b.n23;a.n24+=b.n24;a.n31+=b.n31;a.n32+=b.n32;a.n33+=b.n33;
a.n34+=b.n34;a.n41+=b.n41;a.n42+=b.n42;a.n43+=b.n43;a.n44+=b.n44;return a},transpose:function(a){return new s(a.n11,a.n21,a.n31,a.n41,a.n12,a.n22,a.n32,a.n42,a.n13,a.n23,a.n33,a.n43,a.n14,a.n24,a.n34,a.n44)},$transpose:function(a){return s.set(a,a.n11,a.n21,a.n31,a.n41,a.n12,a.n22,a.n32,a.n42,a.n13,a.n23,a.n33,a.n43,a.n14,a.n24,a.n34,a.n44)},rotateAxis:function(a,b,i){var k=o(b);b=m(b);var n=1-b,r=i.x,u=i.y;i=i.z;k=new s(r*r*n+b,r*u*n-i*k,r*i*n+u*k,0,u*r*n+i*k,u*u*n+b,u*i*n-r*k,0,r*i*n-u*k,u*i*n+
r*k,i*i*n+b,0,0,0,0,1);return s.mulMat4(a,k)},$rotateAxis:function(a,b,i){var k=o(b);b=m(b);var n=1-b,r=i.x,u=i.y;i=i.z;k=new s(r*r*n+b,r*u*n-i*k,r*i*n+u*k,0,u*r*n+i*k,u*u*n+b,u*i*n-r*k,0,r*i*n-u*k,u*i*n+r*k,i*i*n+b,0,0,0,0,1);return s.$mulMat4(a,k)},rotateXYZ:function(a,b,i,k){b=new s(m(i)*m(k),-m(b)*o(k)+o(b)*o(i)*m(k),o(b)*o(k)+m(b)*o(i)*m(k),0,m(i)*o(k),m(b)*m(k)+o(b)*o(i)*o(k),-o(b)*m(k)+m(b)*o(i)*o(k),0,-o(i),o(b)*m(i),m(b)*m(i),0,0,0,0,1);return s.mulMat4(a,b)},$rotateXYZ:function(a,b,i,k){b=
new s(m(i)*m(k),-m(b)*o(k)+o(b)*o(i)*m(k),o(b)*o(k)+m(b)*o(i)*m(k),0,m(i)*o(k),m(b)*m(k)+o(b)*o(i)*o(k),-o(b)*m(k)+m(b)*o(i)*o(k),0,-o(i),o(b)*m(i),m(b)*m(i),0,0,0,0,1);return s.$mulMat4(a,b)},translate:function(a,b,i,k){b=new s(1,0,0,b,0,1,0,i,0,0,1,k,0,0,0,1);return s.mulMat4(a,b)},$translate:function(a,b,i,k){b=new s(1,0,0,b,0,1,0,i,0,0,1,k,0,0,0,1);return s.$mulMat4(a,b)},scale:function(a,b,i,k){b=new s(b,0,0,0,0,i,0,0,0,0,k,0,0,0,0,1);return s.mulMat4(a,b)},$scale:function(a,b,i,k){b=new s(b,
0,0,0,0,i,0,0,0,0,k,0,0,0,0,1);return s.$mulMat4(a,b)},invert:function(a){var b=new s,i=a.n11,k=a.n12,n=a.n13,r=a.n14,u=a.n21,v=a.n22,y=a.n23,z=a.n24,A=a.n31,B=a.n32,D=a.n33,C=a.n34,x=a.n41,E=a.n42,F=a.n43;a=a.n44;var G=i*v-k*u,H=i*y-n*u,I=i*z-r*u,J=k*y-n*v,K=k*z-r*v,L=n*z-r*y,M=A*E-B*x,N=A*F-D*x,O=A*a-C*x,P=B*F-D*E,Q=B*a-C*E,R=D*a-C*F,w=1/(G*R-H*Q+I*P+J*O-K*N+L*M);b.n11=(+v*R-y*Q+z*P)*w;b.n12=(-k*R+n*Q-r*P)*w;b.n13=(+E*L-F*K+a*J)*w;b.n14=(-B*L+D*K-C*J)*w;b.n21=(-u*R+y*O-z*N)*w;b.n22=(+i*R-n*O+r*
N)*w;b.n23=(-x*L+F*I-a*H)*w;b.n24=(+A*L-D*I+C*H)*w;b.n31=(+u*Q-v*O+z*M)*w;b.n32=(-i*Q+k*O-r*M)*w;b.n33=(+x*K-E*I+a*G)*w;b.n34=(-A*K+B*I-C*G)*w;b.n41=(-u*P+v*N-y*M)*w;b.n42=(+i*P-k*N+n*M)*w;b.n43=(-x*J+E*H-F*G)*w;b.n44=(+A*J-B*H+D*G)*w;return b},$invert:function(a){var b=a.n11,i=a.n12,k=a.n13,n=a.n14,r=a.n21,u=a.n22,v=a.n23,y=a.n24,z=a.n31,A=a.n32,B=a.n33,D=a.n34,C=a.n41,x=a.n42,E=a.n43,F=a.n44,G=b*u-i*r,H=b*v-k*r,I=b*y-n*r,J=i*v-k*u,K=i*y-n*u,L=k*y-n*v,M=z*x-A*C,N=z*E-B*C,O=z*F-D*C,P=A*E-B*x,Q=A*
F-D*x,R=B*F-D*E,w=1/(G*R-H*Q+I*P+J*O-K*N+L*M);a.n11=(+u*R-v*Q+y*P)*w;a.n12=(-i*R+k*Q-n*P)*w;a.n13=(+x*L-E*K+F*J)*w;a.n14=(-A*L+B*K-D*J)*w;a.n21=(-r*R+v*O-y*N)*w;a.n22=(+b*R-k*O+n*N)*w;a.n23=(-C*L+E*I-F*H)*w;a.n24=(+z*L-B*I+D*H)*w;a.n31=(+r*Q-u*O+y*M)*w;a.n32=(-b*Q+i*O-n*M)*w;a.n33=(+C*K-x*I+F*G)*w;a.n34=(-z*K+A*I-D*G)*w;a.n41=(-r*P+u*N-v*M)*w;a.n42=(+b*P-i*N+k*M)*w;a.n43=(-C*J+x*H-E*G)*w;a.n44=(+z*J-A*H+B*G)*w;return a},lookAt:function(a,b,i,k){i=f.sub(b,i);i.$unit();k=f.cross(k,i);k.$unit();var n=
f.cross(i,k);n.$unit();return s.set(a,k.x,k.y,k.z,-k.dot(b),n.x,n.y,n.z,-n.dot(b),i.x,i.y,i.z,-i.dot(b),0,0,0,1)},frustum:function(a,b,i,k,n,r,u){return s.set(a,2*r/(i-b),0,(i+b)/(i-b),0,0,2*r/(n-k),(n+k)/(n-k),0,0,0,-(u+r)/(u-r),-2*u*r/(u-r),0,0,-1,0)},perspective:function(a,b,i,k,n){b=k*g(b*d/360);var r=-b;return s.frustum(a,r*i,b*i,r,b,k,n)},ortho:function(a,b,i,k,n,r,u){var v=i-b,y=n-k,z=u-r;return s.set(a,2/v,0,0,-((i+b)/v),0,2/y,0,-((n+k)/y),0,0,-2/z,-((u+r)/z),0,0,0,1)},toFloat32Array:function(a){return new Float32Array([a.n11,
a.n21,a.n31,a.n41,a.n12,a.n22,a.n32,a.n42,a.n13,a.n23,a.n33,a.n43,a.n14,a.n24,a.n34,a.n44])}};j=s.prototype={};for(p in h){s[p]=h[p];j[p]=function(a){return function(){var b=c.call(arguments);b.unshift(this);return s[a].apply(s,b)}}(p)}PhiloGL.Vec3=f;PhiloGL.Mat4=s})();(function(){function t(c){return c!==true?c:false}var o=function(c){var f=function(h){for(var j={x:0,y:0};h&&!/^(?:body|html)$/i.test(h.tagName);){j.x+=h.offsetLeft;j.y+=h.offsetTop;h=h.offsetParent}return j}(c);c=function(h){for(var j=
{x:0,y:0};h&&!/^(?:body|html)$/i.test(h.tagName);){j.x+=h.scrollLeft;j.y+=h.scrollTop;h=h.parentNode}return j}(c);return{x:f.x-c.x,y:f.y-c.y}},m={get:function(c,f){return c||(f||window).event},getWheel:function(c){return c.wheelDelta?c.wheelDelta/120:-(c.detail||0)/3},getKey:function(c){var f=c.which||c.keyCode,h;a:{h=d.Keys;for(var j in h)if(h[j]==f){h=j;break a}h=void 0}j=f-111;if(j>0&&j<13)h="f"+j;h=h||String.fromCharCode(f).toLowerCase();return{code:f,key:h,shift:c.shiftKey,control:c.ctrlKey,
alt:c.altKey,meta:c.metaKey}},isRightClick:function(c){return c.which==3||c.button==2},getPos:function(c,f){f=f||window;c=c||f.event;var h=f.document;h=h.documentElement||h.body;if(c.touches&&c.touches.length)c=c.touches[0];return{x:c.pageX||c.clientX+h.scrollLeft,y:c.pageY||c.clientY+h.scrollTop}},stop:function(c){c.stopPropagation&&c.stopPropagation();c.cancelBubble=true;if(c.preventDefault)c.preventDefault();else c.returnValue=false}},g=function(c,f){var h=c.canvas;this.scene=c.scene;this.domElem=
h;this.pos=o(h);this.opt=this.callbacks=f;this.size={width:h.width||h.offsetWidth,height:h.height||h.offsetHeight};this.attachEvents()};g.prototype={hovered:false,pressed:false,touched:false,touchMoved:false,moved:false,attachEvents:function(){var c=this.domElem,f=this;if(this.opt.disableContextMenu)c.oncontextmenu=function(){return false};["mouseup","mousedown","mousemove","mouseover","mouseout","touchstart","touchmove","touchend"].forEach(function(j){c.addEventListener(j,function(p,s){f[j](f.eventInfo(j,
p,s))},false)});["keydown","keyup"].forEach(function(j){document.addEventListener(j,function(p,s){f[j](f.eventInfo(j,p,s))},false)});var h="";h=!document.getBoxObjectFor&&window.mozInnerScreenX==null?"mousewheel":"DOMMouseScroll";c.addEventListener(h,function(j,p){f.mousewheel(f.eventInfo("mousewheel",j,p))},false)},eventInfo:function(c,f,h){var j=this.domElem,p=this.scene,s=this.opt,a=this.getSize(),b=s.relative,i=s.centerOrigin,k=s.cachePosition&&this.pos||o(j),n=m.get(f,h),r=m.getPos(f,h);f={};
h=r.x;j=r.y;if(b){h-=k.x;j-=k.y;if(i){h-=a.width/2;j-=a.height/2;j*=-1}}switch(c){case "mousewheel":f.wheel=m.getWheel(n);break;case "keydown":q.extend(f,m.getKey(n));break;case "mouseup":f.isRightClick=m.isRightClick(n)}var u;q.extend(f,{x:h,y:j,cache:false,stop:function(){m.stop(n)},getTarget:function(){if(u)return u;return u=!s.picking||p.pick(r.x-k.x,r.y-k.y)||true}});f.event=n;return f},getSize:function(){if(this.cacheSize)return this.size;var c=this.domElem;return{width:c.width||c.offsetWidth,
height:c.height||c.offsetHeight}},mouseup:function(c){if(!this.moved)if(c.isRightClick)this.callbacks.onRightClick(c,this.hovered);else this.callbacks.onClick(c,t(this.pressed));if(this.pressed){if(this.moved)this.callbacks.onDragEnd(c,t(this.pressed));else this.callbacks.onDragCancel(c,t(this.pressed));this.pressed=this.moved=false}},mouseout:function(c){for(var f=c.relatedTarget,h=this.domElem;f&&f.parentNode;){if(h==f.parentNode)return;f=f.parentNode}if(this.hovered){this.callbacks.onMouseLeave(c,
this.hovered);this.hovered=false}},mouseover:function(){},mousemove:function(c){if(this.pressed){this.moved=true;this.callbacks.onDragMove(c,t(this.pressed))}else if(this.hovered){var f=t(c.getTarget());if(this.hovered!=f){this.callbacks.onMouseLeave(c,this.hovered);if(this.hovered=f)this.callbacks.onMouseEnter(c,this.hovered)}else this.callbacks.onMouseMove(c,this.hovered)}else if(this.hovered=t(c.getTarget()))this.callbacks.onMouseEnter(c,this.hovered)},mousewheel:function(c){this.callbacks.onMouseWheel(c)},
mousedown:function(c){this.pressed=c.getTarget();this.callbacks.onDragStart(c,t(this.pressed))},touchstart:function(c){this.touched=c.getTarget();this.callbacks.onTouchStart(c,t(this.touched))},touchmove:function(c){if(this.touched){this.touchMoved=true;this.callbacks.onTouchMove(c,t(this.touched))}},touchend:function(c){if(this.touched){if(this.touchMoved)this.callbacks.onTouchEnd(c,t(this.touched));else this.callbacks.onTouchCancel(c,t(this.touched));this.touched=this.touchMoved=false}},keydown:function(c){this.callbacks.onKeyDown(c)},
keyup:function(c){this.callbacks.onKeyUp(c)}};var d={};d.create=function(c,f){f=q.merge({cachePosition:true,cacheSize:true,relative:true,centerOrigin:true,disableContextMenu:true,bind:false,picking:false,onClick:q.empty,onRightClick:q.empty,onDragStart:q.empty,onDragMove:q.empty,onDragEnd:q.empty,onDragCancel:q.empty,onTouchStart:q.empty,onTouchMove:q.empty,onTouchEnd:q.empty,onTouchCancel:q.empty,onMouseMove:q.empty,onMouseEnter:q.empty,onMouseLeave:q.empty,onMouseWheel:q.empty,onKeyDown:q.empty,
onKeyUp:q.empty},f||{});var h=f.bind;if(h)for(var j in f)j.match(/^on[a-zA-Z0-9]+$/)&&function(p,s){f[p]=function(){return s.apply(h,Array.prototype.slice.call(arguments))}}(j,f[j]);new g(c,f)};d.Keys={enter:13,up:38,down:40,left:37,right:39,esc:27,space:32,backspace:8,tab:9,"delete":46};PhiloGL.Events=d})();(function(){function t(){return arguments.length==2?{vs:arguments[0],fs:arguments[1]}:arguments[0]||{}}var o=function(d,c,f){var h=d.createShader(f);if(h==null)throw"Error creating the shader with shader type: "+
f;d.shaderSource(h,c);d.compileShader(h);if(!d.getShaderParameter(h,d.COMPILE_STATUS)){c=d.getShaderInfoLog(h);d.deleteShader(h);throw"Error while compiling the shader "+c;}return h},m=function(d,c,f){var h=l.getUniformLocation(d,c.name);d=c.type;if(c.size>1&&f)switch(d){case l.FLOAT:return function(j){l.uniform1fv(h,new Float32Array(j))};case l.INT:case l.BOOL:return function(j){l.uniform1iv(h,new Uint16Array(j))}}switch(d){case l.FLOAT:return function(j){l.uniform1f(h,j)};case l.FLOAT_VEC2:return function(j){l.uniform2fv(h,
new Float32Array(j))};case l.FLOAT_VEC3:return function(j){l.uniform3fv(h,new Float32Array(j))};case l.FLOAT_VEC4:return function(j){l.uniform4fv(h,new Float32Array(j))};case l.INT:case l.BOOL:case l.SAMPLER_2D:case l.SAMPLER_CUBE:return function(j){l.uniform1i(h,j)};case l.INT_VEC2:case l.BOOL_VEC2:return function(j){l.uniform2iv(h,new Uint16Array(j))};case l.INT_VEC3:case l.BOOL_VEC3:return function(j){l.uniform3iv(h,new Uint16Array(j))};case l.INT_VEC4:case l.BOOL_VEC4:return function(j){l.uniform4iv(h,
new Uint16Array(j))};case l.FLOAT_MAT2:return function(j){l.uniformMatrix2fv(h,false,j.toFloat32Array())};case l.FLOAT_MAT3:return function(j){l.uniformMatrix3fv(h,false,j.toFloat32Array())};case l.FLOAT_MAT4:return function(j){l.uniformMatrix4fv(h,false,j.toFloat32Array())}}throw"Unknown type: "+d;},g=function(d,c){var f=l,h=f.createProgram();f.attachShader(h,o(f,d,f.VERTEX_SHADER));f.attachShader(h,o(f,c,f.FRAGMENT_SHADER));f.linkProgram(h);if(!f.getProgramParameter(h,f.LINK_STATUS))throw"Error linking the shader: "+
f.getProgramInfoLog(h);if(!h)return false;f={};for(var j={},p=l.getProgramParameter(h,l.ACTIVE_ATTRIBUTES),s=0;s<p;s++){var a=l.getActiveAttrib(h,s),b=a.name;a=l.getAttribLocation(h,a.name);f[b]=a}p=l.getProgramParameter(h,l.ACTIVE_UNIFORMS);for(s=0;s<p;s++){a=l.getActiveUniform(h,s);b=a.name;b=b[b.length-1]=="]"?b.substr(0,b.length-3):b;j[b]=m(h,a,a.name!=b)}this.program=h;this.attributes=f;this.uniforms=j;this.buffers={};this.bufferMemo={};this.frameBuffers={};this.frameBufferMemo={};this.renderBuffers=
{};this.renderBufferMemo={};this.textures={};this.textureMemo={}};g.prototype={$$family:"program",setState:function(d){q.extend(d,{buffers:this.buffers,bufferMemo:this.bufferMemo,renderBuffers:this.renderBuffers,renderBufferMemo:this.renderBufferMemo,frameBuffers:this.frameBuffers,frameBufferMemo:this.frameBufferMemo,textures:this.textures,textureMemo:this.textureMemo});return this},setUniform:function(d,c){if(this.uniforms[d])this.uniforms[d](c);return this},setUniforms:function(d){for(var c in d)this.setUniform(c,
d[c]);return this},setBuffer:function(d,c){if(c===false||c===null){(c=this.bufferMemo[d])&&l.bindBuffer(c.bufferType,null);var f=c&&c.attribute||d,h=this.attributes[f];h!==undefined&&l.disableVertexAttribArray(h)}else{c=q.merge({bufferType:l.ARRAY_BUFFER,size:1,dataType:l.FLOAT,stride:0,offset:0,drawType:l.STATIC_DRAW},this.bufferMemo[d]||{},c||{});f=c.attribute||d;var j=c.bufferType,p=d in this.buffers,s=p?this.buffers[d]:l.createBuffer(),a="value"in c,b=c.value,i=c.size,k=c.dataType,n=c.stride,
r=c.offset,u=c.drawType;h=this.attributes[f];var v=h!==undefined;p||(this.buffers[d]=s);v&&l.enableVertexAttribArray(h);l.bindBuffer(j,s);a&&l.bufferData(j,b,u);v&&l.vertexAttribPointer(h,i,k,false,n,r);delete c.value;this.bufferMemo[d]=c;if(v)this.bufferMemo[f]=c;return this}},setBuffers:function(d){for(var c in d)this.setBuffer(c,d[c]);return this},setFrameBuffer:function(d,c){if(typeof c!="object")l.bindFramebuffer(l.FRAMEBUFFER,c?this.frameBuffers[d]:null);else{c=q.merge({width:0,height:0,bindToTexture:false,
textureOptions:{attachment:l.COLOR_ATTACHMENT0},bindToRenderBuffer:false,renderBufferOptions:{attachment:l.DEPTH_ATTACHMENT}},this.frameBufferMemo[d]||{},c||{});var f=c.bindToTexture,h=c.bindToRenderBuffer,j=d in this.frameBuffers,p=j?this.frameBuffers[d]:l.createFramebuffer(l.FRAMEBUFFER);l.bindFramebuffer(l.FRAMEBUFFER,p);j||(this.frameBuffers[d]=p);if(f){f=q.merge({data:{width:c.width,height:c.height}},q.type(f)=="object"?f:{});j=d+"-texture";p=c.textureOptions;this.setTexture(j,f);l.framebufferTexture2D(l.FRAMEBUFFER,
p.attachment,this.textureMemo[j].textureType,this.textures[j],0)}if(h){h=q.merge({width:c.width,height:c.height},q.type(h)=="object"?h:{});f=d+"-renderbuffer";j=c.renderBufferOptions;this.setRenderBuffer(f,h);l.framebufferRenderbuffer(l.FRAMEBUFFER,j.attachment,l.RENDERBUFFER,this.renderBuffers[f])}l.bindTexture(l.TEXTURE_2D,null);l.bindRenderbuffer(l.RENDERBUFFER,null);l.bindFramebuffer(l.FRAMEBUFFER,null);this.frameBufferMemo[d]=c;return this}},setFrameBuffers:function(d){for(var c in d)this.setFrameBuffer(c,
d[c]);return this},setRenderBuffer:function(d,c){if(typeof c!="object")l.bindRenderbuffer(l.RENDERBUFFER,c?this.renderBufferMemo[d]:null);else{c=q.merge({storageType:l.DEPTH_COMPONENT16,width:0,height:0},this.renderBufferMemo[d]||{},c||{});var f=d in this.renderBuffers,h=f?this.renderBuffers[d]:l.createRenderbuffer(l.RENDERBUFFER);f||(this.renderBuffers[d]=h);l.bindRenderbuffer(l.RENDERBUFFER,h);l.renderbufferStorage(l.RENDERBUFFER,c.storageType,c.width,c.height);this.renderBufferMemo[d]=c;return this}},
setRenderBuffers:function(d){for(var c in d)this.setRenderBuffer(c,d[c]);return this},setTexture:function(d,c){if(!c||typeof c!="object"){l.activeTexture(c||l.TEXTURE0);l.bindTexture(this.textureMemo[d].textureType||l.TEXTURE_2D,this.textures[d])}else{c=q.merge({textureType:l.TEXTURE_2D,pixelStore:[{name:l.UNPACK_FLIP_Y_WEBGL,value:true}],parameters:[{name:l.TEXTURE_MAG_FILTER,value:l.NEAREST},{name:l.TEXTURE_MIN_FILTER,value:l.NEAREST}],data:{format:l.RGBA,value:false,width:0,height:0,border:0}},
this.textureMemo[d]||{},c||{});var f="textureType"in c?c.textureType:l.TEXTURE_2D,h=d in this.textures,j=h?this.textures[d]:l.createTexture(),p=c.pixelStore,s=c.parameters,a=c.data,b=!!c.data.value;h||(this.textures[d]=j);l.bindTexture(f,j);h||p.forEach(function(i){i.name=typeof i.name=="string"?l[i.name]:i.name;l.pixelStorei(i.name,i.value)});if(b)l.texImage2D(f,0,a.format,a.format,l.UNSIGNED_BYTE,a.value);else if(a.width||a.height)l.texImage2D(f,0,a.format,a.width,a.height,a.border,a.format,l.UNSIGNED_BYTE,
null);h||s.forEach(function(i){i.name=l.get(i.name);i.value=l.get(i.value);l.texParameteri(f,i.name,i.value);i.generateMipmap&&l.generateMipmap(f)});delete c.data;this.textureMemo[d]=c;return this}},setTextures:function(d){for(var c in d)this.setTexture(c,d[c]);return this},use:function(){l.useProgram(this.program);return this}};g.fromShaderIds=function(){var d=t.apply({},arguments),c=q(d.vs);d=q(d.fs);return new g(c.innerHTML,d.innerHTML)};g.fromShaderSources=function(d){d=t.apply({},arguments);
return new g(d.vs,d.fs)};g.fromDefaultShaders=function(){var d=t.apply({},arguments),c=PhiloGL.Shaders;return PhiloGL.Program.fromShaderSources(c.Vertex[d.vs||"Default"],c.Fragment[d.fs||"Default"])};g.fromShaderURIs=function(d){d=q.merge({path:"",vs:"",fs:"",noCache:false,onSuccess:q.empty,onError:q.empty},d||{});var c=d.path+d.fs,f=PhiloGL.IO.XHR;(new f({url:d.path+d.vs,noCache:d.noCache,onError:function(h){d.onError(h)},onSuccess:function(h){(new f({url:c,noCache:d.noCache,onError:function(j){d.onError(j)},
onSuccess:function(j){d.onSuccess(g.fromShaderSources(h,j))}})).send()}})).send()};PhiloGL.Program=g})();(function(){var t={},o=function(d){this.opt=d=q.merge({url:"http://sencha.com/",method:"GET",async:true,noCache:false,sendAsBinary:false,onProgress:q.empty,onSuccess:q.empty,onError:q.empty,onAbort:q.empty,onComplete:q.empty},d||{});this.initXHR()};o.State={};["UNINITIALIZED","LOADING","LOADED","INTERACTIVE","COMPLETED"].forEach(function(d,c){o.State[d]=c});o.prototype={initXHR:function(){var d=
this.req=new XMLHttpRequest,c=this;["Progress","Error","Abort","Load"].forEach(function(f){d.addEventListener(f.toLowerCase(),function(h){c["handle"+f](h)},false)})},send:function(d){var c=this.req,f=this.opt,h=f.async;if(f.noCache)f.url+=(f.url.indexOf("?")>=0?"&":"?")+q.uid();c.open(f.method,f.url,h);if(h)c.onreadystatechange=function(){if(c.readyState==o.State.COMPLETED)if(c.status==200)f.onSuccess(c.responseText);else f.onError(c.status)};f.sendAsBinary?c.sendAsBinary(d||f.body||null):c.send(d||
f.body||null);if(!h)if(c.status==200)f.onSuccess(c.responseText);else f.onError(c.status)},setRequestHeader:function(d,c){this.req.setRequestHeader(d,c);return this},handleProgress:function(d){if(d.lengthComputable)this.opt.onProgress(d,Math.round(d.loaded/d.total*100));else this.opt.onProgress(d,-1)},handleError:function(d){this.opt.onError(d)},handleAbort:function(){this.opt.onAbort(e)},handleLoad:function(d){this.opt.onComplete(d)}};var m=function(d){d=q.merge({url:"http://sencha.com/",data:{},
noCache:false,onComplete:q.empty,callbackKey:"callback"},d||{});var c=m.counter++,f=[],h;for(h in d.data)f.push(h+"="+d.data[h]);f=f.join("&");if(d.noCache)f+=(f.indexOf("?")>=0?"&":"?")+q.uid();f=d.url+(d.url.indexOf("?")>-1?"&":"?")+d.callbackKey+"=PhiloGL.IO.JSONP.requests.request_"+c+(f.length>0?"&"+f:"");var j=document.createElement("script");j.type="text/javascript";j.src=f;m.requests["request_"+c]=function(p){d.onComplete(p);j.parentNode&&j.parentNode.removeChild(j);j.clearAttributes&&j.clearAttributes()};
document.getElementsByTagName("head")[0].appendChild(j)};m.counter=0;m.requests={};var g=function(d){d=q.merge({src:[],noCache:false,onProgress:q.empty,onComplete:q.empty},d||{});var c=0,f=d.src.length,h=function(){d.onProgress(Math.round(++c/f*100));if(c==f)d.onComplete(a)},j=function(){if(++c==f)d.onComplete(a)},p=d.noCache,s=q.uid(),a=d.src.map(function(b,i){var k=new Image;k.index=i;k.onload=h;k.onerror=j;k.src=b+(p?(b.indexOf("?")>=0?"&":"?")+s:"");return k});return a};t.XHR=o;t.JSONP=m;t.Images=
g;t.Textures=function(d,c){c=q.merge({src:[],noCache:false,onComplete:q.empty},c||{});g({src:c.src,noCache:c.noCache,onComplete:function(f){var h={};f.forEach(function(j,p){h[c.src[p]]=q.merge({data:{value:j}},c)});d.setTextures(h);c.onComplete()}})};PhiloGL.IO=t})();(function(){var t=PhiloGL.Vec3,o=PhiloGL.Mat4,m=function(g,d,c,f,h){h=h||{};var j=h.position,p=h.target;h=h.up;this.near=c;this.far=f;this.position=j&&new t(j.x,j.y,j.z)||new t;this.target=p&&new t(p.x,p.y,p.z)||new t;this.up=h&&new t(h.x,
h.y,h.z)||new t(0,1,0);this.projection=(new o).perspective(g,d,c,f);this.modelView=new o};m.prototype={update:function(){this.modelView.lookAt(this.position,this.target,this.up)}};PhiloGL.Camera=m})();(function(){(function(){try{var t=document.createElement("canvas");PhiloGL.hasWebGL=function(){return!!(window.WebGLRenderingContext&&(t.getContext("webgl")||t.getContext("experimental-webgl")))}}catch(o){PhiloGL.hasWebGL=function(){return false}}})();PhiloGL.WebGL={getContext:function(t,o){t=typeof t==
"string"?q(t):t;var m;(m=t.getContext("experimental-webgl",o))||(m=t.getContext("webgl",o));if(m&&o&&o.debug){l={};for(var g in m){var d=m[g];l[g]=typeof d=="function"?function(c,f){return function(){console.log(c,Array.prototype.join.call(arguments),Array.prototype.slice.call(arguments));try{var h=f.apply(m,arguments)}catch(j){throw c+" "+j;}for(var p=[],s;(s=m.getError())!==m.NO_ERROR;)p.push(s);if(p.length)throw p.join();return h}}(g,d):d}}else l=m;l.get=function(c){return typeof c=="string"?l[c]:
c};return l}}})();(function(){var t=PhiloGL.Vec3,o=PhiloGL.Mat4;cos=Math.cos;sin=Math.sin;pi=Math.PI;max=Math.max;flatten=function(g){if(g&&g.length&&q.type(g[0])=="array")return[].concat.apply([],g);return g};var m={};m.Model=function(g){this.$$family="model";this.pickable=!!g.pickable;this.vertices=flatten(g.vertices);this.faces=flatten(g.faces);this.normals=flatten(g.normals);this.textures=g.textures&&q.splat(g.textures);this.centroids=flatten(g.centroids);this.colors=flatten(g.colors);this.indices=
flatten(g.indices);this.shininess=g.shininess||0;this.uniforms=g.uniforms||{};this.render=g.render;this.drawType=g.drawType;this.display="display"in g?g.display:true;if(g.texCoords)this.texCoords=q.type(g.texCoords)=="object"?g.texCoords:flatten(g.texCoords);this.onBeforeRender=g.onBeforeRender||q.empty;this.onAfterRender=g.onAfterRender||q.empty;this.position=new t;this.rotation=new t;this.scale=new t(1,1,1);this.matrix=new o;this.normalizeColors();g.computeCentroids&&this.computeCentroids();g.computeNormals&&
this.computeNormals()};m.Model.prototype={update:function(){var g=this.matrix,d=this.position,c=this.rotation,f=this.scale;g.id();g.$translate(d.x,d.y,d.z);g.$rotateXYZ(c.x,c.y,c.z);g.$scale(f.x,f.y,f.z)},toFloat32Array:function(g){return new Float32Array(this[g])},toUint16Array:function(g){return new Uint16Array(this[g])},normalizeColors:function(){if(this.vertices){var g=this.vertices.length*4/3;if(this.colors&&this.colors.length<g){g/=this.colors.length;for(var d=this.colors,c=d.slice();--g;)d.push.apply(d,
c)}}},computeCentroids:function(){var g=this.vertices,d=[];this.faces.forEach(function(c){var f=[0,0,0],h=0;c.forEach(function(j){j=g[j];f[0]+=j[0];f[1]+=j[1];f[2]+=j[2];h++});f[0]/=h;f[1]/=h;f[2]/=h;d.push(f)});this.centroids=d},computeNormals:function(){var g=this.vertices,d=[];this.faces.forEach(function(c){var f=g[c[0]],h=g[c[1]];c=g[c[2]];f={x:f[0]-h[0],y:f[1]-h[1],z:f[2]-h[2]};t.$cross(f,{x:c[0]-h[0],y:c[1]-h[1],z:c[1]-h[2]});t.norm(f)>1.0E-6&&t.unit(f);d.push([f.x,f.y,f.z])});this.normals=
d}};q.extend(m.Model.prototype,{setUniforms:function(g){g.setUniforms(this.uniforms)},setShininess:function(g){g.setUniform("shininess",this.shininess||0)},setVertices:function(g,d){if(this.vertices)d||this.dynamic?g.setBuffer("vertices-"+this.id,{attribute:"position",value:this.toFloat32Array("vertices"),size:3}):g.setBuffer("vertices-"+this.id)},unsetVertices:function(g){g.setBuffer("vertices-"+this.id,false)},setNormals:function(g,d){if(this.normals)d||this.dynamic?g.setBuffer("normals-"+this.id,
{attribute:"normal",value:this.toFloat32Array("normals"),size:3}):g.setBuffer("normals-"+this.id)},unsetNormals:function(g){g.setBuffer("normals-"+this.id,false)},setIndices:function(g,d){if(this.indices)d||this.dynamic?g.setBuffer("indices-"+this.id,{bufferType:l.ELEMENT_ARRAY_BUFFER,drawType:l.STATIC_DRAW,value:this.toUint16Array("indices"),size:1}):g.setBuffer("indices-"+this.id)},unsetIndices:function(g){g.setBuffer("indices-"+this.id,false)},setColors:function(g,d){if(this.colors)d||this.dynamic?
g.setBuffer("colors-"+this.id,{attribute:"color",value:this.toFloat32Array("colors"),size:4}):g.setBuffer("colors-"+this.id)},unsetColors:function(g){g.setBuffer("colors-"+this.id,false)},setTexCoords:function(g,d){if(this.texCoords){var c=this.id;if(d||this.dynamic)q.type(this.texCoords)=="object"?this.textures.forEach(function(j,p){g.setBuffer("texCoords-"+p+"-"+c,{attribute:"texCoord"+(p+1),value:new Float32Array(this.texCoords[j]),size:2})}):g.setBuffer("texCoords-"+c,{attribute:"texCoord1",value:this.toFloat32Array("texCoords"),
size:2});else q.type(this.texCoords)=="object"?this.textures.forEach(function(j,p){g.setBuffer("texCoords-"+p+"-"+c)}):g.setBuffer("texCoords-"+c)}else for(var f=0,h=PhiloGL.Scene.MAX_TEXTURES;f<h;f++)g.setBuffer("texCoord"+(f+1),false)},unsetTexCoords:function(g){g.setBuffer("texCoords-"+this.id,false)},setTextures:function(g){this.textures=this.textures?q.splat(this.textures):[];for(var d=0,c=this.textures,f=c.length,h=PhiloGL.Scene.MAX_TEXTURES;d<h;d++)if(d<f){g.setUniform("hasTexture"+(d+1),true);
g.setUniform("sampler"+(d+1),d);g.setTexture(c[d],l["TEXTURE"+d])}else g.setUniform("hasTexture"+(d+1),false)}});m.Cube=function(g){m.Model.call(this,q.extend({vertices:[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1],texCoords:[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1],normals:[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,
0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]},g||{}))};m.Cube.prototype=Object.create(m.Model.prototype);m.Sphere=function(g){var d=g.nlat||10,c=g.nlong||10,f=g.radius||1,h=pi-0,j=2*pi-0,p=[],s=[],a=[],b=[];if(typeof f=="number"){var i=f;f=function(){return i}}for(var k=0;k<=c;k++)for(var n=0;n<=d;n++){var r=n/d,u=k/c,
v=j*r,y=h*u,z=sin(v),A=cos(v);v=sin(y);var B=cos(y);y=A*v;A=B;z*=v;v=f(y,A,z,r,u);p.push(v*y,v*A,v*z);s.push(y,A,z);a.push(r,u)}f=d+1;for(n=0;n<d;n++)for(k=0;k<c;k++){b.push(k*f+n,k*f+n+1,(k+1)*f+n);b.push((k+1)*f+n,k*f+n+1,(k+1)*f+n+1)}m.Model.call(this,q.extend({vertices:p,indices:b,normals:s,texCoords:a},g||{}))};m.Sphere.prototype=Object.create(m.Model.prototype);m.TruncatedCone=function(g){var d=g.bottomRadius||0,c=g.topRadius||0,f=g.height||1,h=g.nradial||10,j=g.nvertical||10,p=!!g.topCap,s=
!!g.bottomCap,a=(p?2:0)+(s?2:0),b=[],i=[],k=[],n=[],r=h+1,u=Math.atan2(d-c,f),v=Math,y=v.sin,z=v.cos;v=v.PI;var A=z(u);u=y(u);s=j+(s?2:0);for(p=p?-2:0;p<=s;p++){var B=p/j,D=f*B,C;if(p<0){D=0;B=1;C=d}else if(p>j){D=f;B=1;C=c}else C=d+(c-d)*(p/j);if(p==-2||p==j+2)B=C=0;D-=f/2;for(var x=0;x<r;x++){var E=y(x*v*2/h),F=z(x*v*2/h);b.push(E*C,D,F*C);i.push(p<0||p>j?0:E*A,p<0?-1:p>j?1:u,p<0||p>j?0:F*A);k.push(x/h,B)}}for(p=0;p<j+a;p++)for(x=0;x<h;x++)n.push(r*(p+0)+0+x,r*(p+0)+1+x,r*(p+1)+1+x,r*(p+0)+0+x,
r*(p+1)+1+x,r*(p+1)+0+x);m.Model.call(this,q.extend({vertices:b,normals:i,texCoords:k,indices:n},g||{}))};m.TruncatedCone.prototype=Object.create(m.Model.prototype);m.Cone=function(g){g.topRadius=0;g.topCap=!!g.cap;g.bottomCap=!!g.cap;g.bottomRadius=g.radius||3;m.TruncatedCone.call(this,g)};m.Cone.prototype=Object.create(m.TruncatedCone.prototype);m.Cylinder=function(g){g.bottomRadius=g.radius;g.topRadius=g.radius;m.TruncatedCone.call(this,g)};m.Cylinder.prototype=Object.create(m.TruncatedCone.prototype);
PhiloGL.O3D=m})();(function(){var t={Vertex:{},Fragment:{}},o=t.Fragment;t.Vertex.Default="#define LIGHT_MAX 50\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color;\nattribute vec2 texCoord1;\nuniform mat4 modelViewMatrix;\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 normalMatrix;\nuniform bool enableLights;\nuniform vec3 ambientColor;\nuniform vec3 directionalColor;\nuniform vec3 lightingDirection;\nuniform vec3 pointLocation[LIGHT_MAX];\nuniform vec3 pointColor[LIGHT_MAX];\nuniform int numberPoints;\nvarying vec4 vColor;\nvarying vec2 vTexCoord;\nvarying vec3 lightWeighting;\nvoid main(void) {\nvec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\nif(!enableLights) {\nlightWeighting = vec3(1.0, 1.0, 1.0);\n} else {\nvec3 plightDirection;\nvec3 pointWeight = vec3(0.0, 0.0, 0.0);\nvec4 transformedNormal = normalMatrix * vec4(normal, 1.0);\nfloat directionalLightWeighting = max(dot(transformedNormal.xyz, lightingDirection), 0.0);\nfor (int i = 0; i < LIGHT_MAX; i++) {\nif (i < numberPoints) {\nplightDirection = normalize((viewMatrix * vec4(pointLocation[i], 1.0)).xyz - mvPosition.xyz);\npointWeight += max(dot(transformedNormal.xyz, plightDirection), 0.0) * pointColor[i];\n} else {\nbreak;\n}\n}\nlightWeighting = ambientColor + (directionalColor * directionalLightWeighting) + pointWeight;\n}\nvColor = color;\nvTexCoord = texCoord1;\ngl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}";
o.Default="#ifdef GL_ES\nprecision highp float;\n#endif\nvarying vec4 vColor;\nvarying vec2 vTexCoord;\nvarying vec3 lightWeighting;\nuniform bool hasTexture1;\nuniform sampler2D sampler1;\nuniform bool enablePicking;\nuniform vec3 pickColor;\nuniform bool hasFog;\nuniform vec3 fogColor;\nuniform float fogNear;\nuniform float fogFar;\nvoid main(){\nif(!hasTexture1) {\ngl_FragColor = vec4(vColor.rgb * lightWeighting, vColor.a);\n} else {\ngl_FragColor = vec4(texture2D(sampler1, vec2(vTexCoord.s, vTexCoord.t)).rgb * lightWeighting, 1.0);\n}\nif(enablePicking) {\ngl_FragColor = vec4(pickColor, 1.0);\n}\nif (hasFog) {\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\nfloat fogFactor = smoothstep(fogNear, fogFar, depth);\ngl_FragColor = mix(gl_FragColor, vec4(fogColor, gl_FragColor.w), fogFactor);\n}\n}";
PhiloGL.Shaders=t})();(function(){var t=PhiloGL.Vec3,o=PhiloGL.Mat4,m=function(g,d,c){c=q.merge({lights:{enable:false,ambient:{r:0.2,g:0.2,b:0.2},directional:{direction:{x:1,y:1,z:1},color:{r:0,g:0,b:0}}},effects:{fog:false}},c||{});this.program=g;this.camera=d;this.models=[];this.config=c;this.setupPicking()};m.prototype={add:function(){for(var g=0,d=this.models,c=arguments.length;g<c;g++){var f=arguments[g];f.id=f.id||m.id++;d.push(f);this.defineBuffers(f)}},defineBuffers:function(g){var d=this.program;
g.setVertices(d,true);g.setColors(d,true);g.setNormals(d,true);g.setTexCoords(d,true);g.setIndices(d,true)},beforeRender:function(){this.setupLighting();this.setupEffects();var g=this.camera,d=this.program;d.setUniform("projectionMatrix",g.projection);d.setUniform("viewMatrix",g.modelView)},setupLighting:function(){var g=this.program,d=this.config.lights,c=d.ambient,f=d.directional,h=f.color,j=f.direction,p=d.enable;f=d.points&&q.splat(d.points)||[];var s=f.length,a=[],b=[],i=[],k=[];j=t.unit(j).$scale(-1);
g.setUniform("enableLights",p);if(d.enable){g.setUniform("ambientColor",[c.r,c.g,c.b]);g.setUniform("directionalColor",[h.r,h.g,h.b]);g.setUniform("lightingDirection",[j.x,j.y,j.z])}g.setUniform("numberPoints",s);for(d=0;d<s;d++){j=f[d];c=j.position;h=j.color||j.diffuse;j=j.specular;a.push(c.x,c.y,c.z);b.push(h.r,h.g,h.b);i.push(+!!j);j?k.push(j.r,j.g,j.b):k.push(0,0,0)}g.setUniforms({pointLocation:a,pointColor:b});g.setUniforms({enableSpecular:i,pointSpecularColor:k})},setupEffects:function(){var g=
this.program,d=this.config.effects.fog,c=d.color||{r:0.5,g:0.5,b:0.5};d?g.setUniforms({hasFog:true,fogNear:d.near,fogFar:d.far,fogColor:[c.r,c.g,c.b]}):g.setUniform("hasFog",false)},render:function(g){var d=this.program,c=this.camera,f=q.merge({onBeforeRender:q.empty,onAfterRender:q.empty},g||{});this.beforeRender();this.models.forEach(function(h,j){if(h.display){h.onBeforeRender(d,c);f.onBeforeRender(h,j);this.renderObject(h);f.onAfterRender(h,j);h.onAfterRender(d,c)}},this)},renderToTexture:function(g,
d){var c=this.program,f=c.textures[g+"-texture"];c=c.textureMemo[g+"-texture"];this.render(d);l.bindTexture(c.textureType,f);l.generateMipmap(c.textureType);l.bindTexture(c.textureType,null)},renderObject:function(g){var d=this.program,c=this.camera,f=new o;g.setUniforms(d);g.setShininess(d);g.setVertices(d);g.setColors(d);g.setNormals(d);g.setTextures(d);g.setTexCoords(d);g.setIndices(d);f.mulMat42(c.modelView,g.matrix);d.setUniform("modelViewMatrix",f);d.setUniform("normalMatrix",f.invert().$transpose());
if(g.render)g.render(l,d,c);else g.indices?l.drawElements(g.drawType!==undefined?l.get(g.drawType):l.TRIANGLES,g.indices.length,l.UNSIGNED_SHORT,0):l.drawArrays(l.get(g.drawType||"TRIANGLES"),0,g.toFloat32Array("vertices").length/3);g.unsetVertices(d);g.unsetColors(d);g.unsetNormals(d);g.unsetTexCoords(d);g.unsetIndices(d)},setupPicking:function(){var g=this.program;g.setFrameBuffer("$picking",{width:1,height:1,bindToTexture:{parameters:[{name:"TEXTURE_MAG_FILTER",value:"LINEAR"},{name:"TEXTURE_MIN_FILTER",
value:"LINEAR",generateMipmap:false}]},bindToRenderBuffer:true});g.setFrameBuffer("$picking",false)},pick:function(g,d){var c={},f=this.program,h=this.config,j=h.lights.enable,p=h.effects.fog,s=l.canvas.width,a=l.canvas.height,b=[];q.time();var i=new Uint8Array(4),k=0,n;h.lights.enable=false;h.effects.fog=false;f.setUniform("enablePicking",true);f.setFrameBuffer("$picking",true);l.disable(l.BLEND);l.viewport(-g,d-a,s,a);l.clear(l.COLOR_BUFFER_BIT|l.DEPTH_BUFFER_BIT);l.readPixels(0,0,1,1,l.RGBA,l.UNSIGNED_BYTE,
i);n=i[0]+i[1]*256+i[2]*65536;this.renderToTexture("$picking",{onBeforeRender:function(r,u){if(u==n)k=1;var v=u+k;b[0]=v%256;b[1]=(v/256>>0)%256;b[2]=(v/65536>>0)%256;f.setUniform("pickColor",[b[0]/255,b[1]/255,b[2]/255]);c[String(b)]=r}});l.readPixels(0,0,1,1,l.RGBA,l.UNSIGNED_BYTE,i);s=c[String([i[0],i[1],i[2]])];f.setFrameBuffer("$picking",false);f.setUniform("enablePicking",false);h.lights.enable=j;h.effects.fog=p;return s&&s.pickable&&s}};m.id=q.time();m.MAX_TEXTURES=3;m.MAX_POINT_LIGHTS=3;PhiloGL.Scene=
m})();(function(){function t(o,m){for(var g=this.workers=[];m--;)g.push(new Worker(o))}t.prototype={map:function(o){var m=this.workers,g=this.configs=[],d=0;for(m=m.length;d<m;d++)g.push(o&&o(d));return this},reduce:function(o){for(var m=o.reduceFn,g=this.workers,d=this.configs,c=g.length,f=o.initialValue,h=function(a){c--;f=f===undefined?a.data:m(f,a.data);if(c==0)o.onComplete(f)},j=0,p=c;j<p;j++){var s=g[j];s.onmessage=h;s.postMessage(d[j])}return this}};PhiloGL.WorkerGroup=t})();(function(){var t=
function(d){this.opt=q.merge({duration:1E3,transition:function(c){return c},onCompute:q.empty,onComplete:q.empty},d||{})};t.prototype={timer:null,time:null,start:function(d){this.opt=q.merge(this.opt,d||{});this.time=q.time();this.animating=true},step:function(){if(this.animating){var d=q.time(),c=this.time,f=this.opt;if(d<c+f.duration){d=f.transition((d-c)/f.duration);f.onCompute.call(this,d)}else{this.animating=false;f.onCompute.call(this,1);f.onComplete.call(this)}}}};t.compute=function(d,c,f){return d+
(c-d)*f};t.Transition={linear:function(d){return d}};var o=t.Transition;(function(){var d=function(h,j){j=q.splat(j);return q.extend(h,{easeIn:function(p){return h(p,j)},easeOut:function(p){return 1-h(1-p,j)},easeInOut:function(p){return p<=0.5?h(2*p,j)/2:(2-h(2*(1-p),j))/2}})},c={Pow:function(h,j){return Math.pow(h,j[0]||6)},Expo:function(h){return Math.pow(2,8*(h-1))},Circ:function(h){return 1-Math.sin(Math.acos(h))},Sine:function(h){return 1-Math.sin((1-h)*Math.PI/2)},Back:function(h,j){j=j[0]||
1.618;return Math.pow(h,2)*((j+1)*h-j)},Bounce:function(h){for(var j,p=0,s=1;;p+=s,s/=2)if(h>=(7-4*p)/11){j=s*s-Math.pow((11-6*p-11*h)/4,2);break}return j},Elastic:function(h,j){return Math.pow(2,10*--h)*Math.cos(20*h*Math.PI*(j[0]||1)/3)}},f;for(f in c)o[f]=d(c[f]);["Quad","Cubic","Quart","Quint"].forEach(function(h,j){o[h]=d(function(p){return Math.pow(p,[j+2])})})})();var m=self||window;if(m){var g=false;["webkitAnimationTime","mozAnimationTime","animationTime","webkitAnimationStartTime","mozAnimationStartTime",
"animationStartTime"].forEach(function(d){if(d in m){t.animationTime=function(){return m[d]};g=true}});if(!g)t.animationTime=q.time;g=false;["webkitRequestAnimationFrame","mozRequestAnimationFrame","requestAnimationFrame"].forEach(function(d){if(d in m){t.requestAnimationFrame=function(c){m[d](function(){c()})};g=true}});if(!g)t.requestAnimationFrame=function(d){setTimeout(function(){d()},1E3/60)}}PhiloGL.Fx=t})()})();
