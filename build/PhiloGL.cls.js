/*

 Copyright (c) 2011 Sencha Labs - Author: Nicolas Garcia Belmonte (http://philogb.github.com/)

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.

*/
(function(){function u(y){return document.getElementById(y)}this.PhiloGL=null;(function(){PhiloGL=function(y,v){function k(t,A,s){var w=t.canvas,a=new PhiloGL.Camera(d.fov,w.width/w.height,d.near,d.far,d);a.update();var b=new PhiloGL.Scene(A,a,c);N=new PhiloGL.WebGL.Application({gl:t,canvas:w,program:A,scene:b,camera:a});A.$$family=="program"&&A.use();f&&PhiloGL.Events.create(N,u.extend(f,{bind:N}));if(j.src.length)new PhiloGL.IO.Textures(u.extend(j,{onComplete:function(){s(N)}}));else s(N)}v=u.merge({context:{},
camera:{fov:45,near:0.1,far:500},program:{from:"defaults",vs:"Default",fs:"Default"},scene:{},textures:{src:[]},events:{},onLoad:u.empty,onError:u.empty},v||{});var m=v.context,d=v.camera,f=v.events,j=v.textures,h=u.splat(v.program),c=v.scene;p=PhiloGL.WebGL.getContext(y,m);if(!p){v.onError("The WebGL context couldn't been initialized");return null}var l={defaults:"fromDefaultShaders",ids:"fromShaderIds",sources:"fromShaderSources",uris:"fromShaderURIs"},i=h.length,o=function(){var t=i,A={},s=false;
return{onSuccess:function(w,a){A[a.id||i-t]=w;t--;if(t==0&&!s)k(p,i==1?w:A,function(b){v.onLoad(b)})},onError:function(){t--;v.onError(v.id);s=true}}}();h.forEach(function(t){var A=t.from,s;for(s in l)if(A==s){program=PhiloGL.Program[l[s]](u.extend(o,t));break}if(program)o.onSuccess(program,t)})}})();PhiloGL.unpack=function(y){y=y||aa;["Vec3","Mat4","Quat","Camera","Program","WebGL","O3D","Scene","Shaders","IO","Events","WorkerGroup","Fx","Media"].forEach(function(v){y[v]=PhiloGL[v]})};PhiloGL.version=
"1.3.1";var p,N,aa=this;u.empty=function(){};u.time=Date.now;u.uid=function(){var y=u.time();return function(){return y++}}();u.extend=function(y,v){for(var k in v)y[k]=v[k];return y};u.type=function(){var y=Object.prototype.toString;return function(v){var k;k=y.call(v);k=k.substr(8,k.length-9).toLowerCase();if(k!="object")return k;if(v.$$family)return v.$$family;return v&&v.nodeName&&v.nodeType==1?"element":k}}();(function(){function y(v){var k=u.type(v);if(k=="object"){k={};for(var m in v)k[m]=
y(v[m]);return k}else if(k=="array"){k=[];m=0;for(var d=v.length;m<d;m++)k[m]=y(v[m]);return k}else return v}u.merge=function(){for(var v={},k=0,m=arguments.length;k<m;k++){var d=arguments[k];if(u.type(d)=="object")for(var f in d){var j=d[f],h=v[f];v[f]=h&&u.type(j)=="object"&&u.type(h)=="object"?u.merge(h,j):y(j)}}return v}})();u.splat=function(){var y=Array.isArray;return function(v){return y(v)&&v||[v]}}();(function(){function y(k){for(var m in k)this[m]=k[m];this.buffers={};this.bufferMemo={};
this.frameBuffers={};this.frameBufferMemo={};this.renderBuffers={};this.renderBufferMemo={};this.textures={};this.textureMemo={}}var v={getContext:function(k,m){k=typeof k=="string"?u(k):k;var d;(d=k.getContext("experimental-webgl",m))||(d=k.getContext("webgl",m));if(d&&m&&m.debug){p={};for(var f in d){var j=d[f];p[f]=typeof j=="function"?function(h,c){return function(){console.log(h,Array.prototype.join.call(arguments),Array.prototype.slice.call(arguments));try{var l=c.apply(d,arguments)}catch(i){throw h+
" "+i;}for(var o=[],t;(t=d.getError())!==d.NO_ERROR;)o.push(t);if(o.length)throw o.join();return l}}(f,j):j}}else p=d;if(p)p.get=function(h){return typeof h=="string"?p[h]:h};return p}};y.prototype={$$family:"application",setBuffer:function(k,m,d){if(d===false||d===null){(d=this.bufferMemo[m])&&p.bindBuffer(d.bufferType,null);var f=d&&d.attribute||m;k=k.attributes[f];k!==undefined&&p.disableVertexAttribArray(k)}else{d=u.extend(this.bufferMemo[m]||{bufferType:p.ARRAY_BUFFER,size:1,dataType:p.FLOAT,
stride:0,offset:0,drawType:p.STATIC_DRAW},d||{});f=d.attribute||m;var j=d.bufferType,h=m in this.buffers,c=h?this.buffers[m]:p.createBuffer(),l="value"in d,i=d.value,o=d.size,t=d.dataType,A=d.stride,s=d.offset,w=d.drawType;k=k.attributes[f];var a=k!==undefined;h||(this.buffers[m]=c);a&&p.enableVertexAttribArray(k);p.bindBuffer(j,c);l&&p.bufferData(j,i,w);a&&p.vertexAttribPointer(k,o,t,false,A,s);delete d.value;this.bufferMemo[m]=d;if(a)this.bufferMemo[f]=d;return this}},setBuffers:function(k,m){for(var d in m)this.setBuffer(k,
d,m[d]);return this},setFrameBuffer:function(k,m){if(typeof m!="object")p.bindFramebuffer(p.FRAMEBUFFER,m?this.frameBuffers[k]:null);else{m=u.merge(this.frameBufferMemo[k]||{width:0,height:0,bindToTexture:false,textureOptions:{attachment:p.COLOR_ATTACHMENT0},bindToRenderBuffer:false,renderBufferOptions:{attachment:p.DEPTH_ATTACHMENT}},m||{});var d=m.bindToTexture,f=m.bindToRenderBuffer,j=k in this.frameBuffers,h=j?this.frameBuffers[k]:p.createFramebuffer(p.FRAMEBUFFER);p.bindFramebuffer(p.FRAMEBUFFER,
h);j||(this.frameBuffers[k]=h);if(d){d=u.merge({data:{width:m.width,height:m.height}},u.type(d)=="object"?d:{});j=k+"-texture";h=m.textureOptions;this.setTexture(j,d);p.framebufferTexture2D(p.FRAMEBUFFER,h.attachment,this.textureMemo[j].textureType,this.textures[j],0)}if(f){f=u.extend({width:m.width,height:m.height},u.type(f)=="object"?f:{});d=k+"-renderbuffer";j=m.renderBufferOptions;this.setRenderBuffer(d,f);p.framebufferRenderbuffer(p.FRAMEBUFFER,j.attachment,p.RENDERBUFFER,this.renderBuffers[d])}p.bindTexture(p.TEXTURE_2D,
null);p.bindRenderbuffer(p.RENDERBUFFER,null);p.bindFramebuffer(p.FRAMEBUFFER,null);this.frameBufferMemo[k]=m;return this}},setFrameBuffers:function(k){for(var m in k)this.setFrameBuffer(m,k[m]);return this},setRenderBuffer:function(k,m){if(typeof m!="object")p.bindRenderbuffer(p.RENDERBUFFER,m?this.renderBufferMemo[k]:null);else{m=u.extend(this.renderBufferMemo[k]||{storageType:p.DEPTH_COMPONENT16,width:0,height:0},m||{});var d=k in this.renderBuffers,f=d?this.renderBuffers[k]:p.createRenderbuffer(p.RENDERBUFFER);
d||(this.renderBuffers[k]=f);p.bindRenderbuffer(p.RENDERBUFFER,f);p.renderbufferStorage(p.RENDERBUFFER,m.storageType,m.width,m.height);this.renderBufferMemo[k]=m;return this}},setRenderBuffers:function(k){for(var m in k)this.setRenderBuffer(m,k[m]);return this},setTexture:function(k,m){if(!m||typeof m!="object"){p.activeTexture(m||p.TEXTURE0);p.bindTexture(this.textureMemo[k].textureType||p.TEXTURE_2D,this.textures[k])}else{m=u.merge(this.textureMemo[k]||{textureType:p.TEXTURE_2D,pixelStore:[{name:p.UNPACK_FLIP_Y_WEBGL,
value:true}],parameters:[{name:p.TEXTURE_MAG_FILTER,value:p.NEAREST},{name:p.TEXTURE_MIN_FILTER,value:p.NEAREST}],data:{format:p.RGBA,value:false,width:0,height:0,border:0}},m||{});var d="textureType"in m?p.get(m.textureType):p.TEXTURE_2D,f="textureTarget"in m?p.get(m.textureTarget):d,j=d==p.TEXTURE_CUBE_MAP,h=k in this.textures,c=h?this.textures[k]:p.createTexture(),l=m.pixelStore,i=m.parameters,o=m.data,t=o.value,A=o.format,s=!!o.value;h||(this.textures[k]=c);p.bindTexture(d,c);h||l.forEach(function(w){w.name=
typeof w.name=="string"?p[w.name]:w.name;p.pixelStorei(w.name,w.value)});if(s)if(j)for(c=0;c<6;++c)p.texImage2D(f[c],0,A,A,p.UNSIGNED_BYTE,t[c]);else p.texImage2D(f,0,A,A,p.UNSIGNED_BYTE,t);else if(o.width||o.height)p.texImage2D(f,0,A,o.width,o.height,o.border,A,p.UNSIGNED_BYTE,null);h||i.forEach(function(w){w.name=p.get(w.name);w.value=p.get(w.value);p.texParameteri(d,w.name,w.value);w.generateMipmap&&p.generateMipmap(d)});m.isCube=j;delete m.data;this.textureMemo[k]=m;return this}},setTextures:function(k){for(var m in k)this.setTexture(m,
k[m]);return this},use:function(k){p.useProgram(k.program);this.usedProgram=k;return this}};v.Application=y;(function(){try{var k=document.createElement("canvas");PhiloGL.hasWebGL=function(){return!!(window.WebGLRenderingContext&&(k.getContext("webgl")||k.getContext("experimental-webgl")))}}catch(m){PhiloGL.hasWebGL=function(){return false}}})();PhiloGL.WebGL=v})();(function(){function y(a){return{get:function(){return this[a]},set:function(b){this[a]=b},configurable:false,enumerable:false}}var v=
Math.sqrt,k=Math.sin,m=Math.cos,d=Math.tan,f=Math.PI,j=Array.prototype.slice,h=this.Float32Array,c=function(){if(!h||!h.call)return Array;try{h.call({},10)}catch(a){return Array}return h}(),l=c!=Array,i=function(a,b,g){if(l){h.call(this,3);this[0]=a||0;this[1]=b||0;this[2]=g||0}else this.push(a||0,b||0,g||0);this.typedContainer=new h(3)};i.create=function(){return new h(3)};i.prototype=Object.create(c.prototype,{$$family:{value:"Vec3"},x:y(0),y:y(1),z:y(2)});var o={setVec3:function(a,b){a[0]=b[0];
a[1]=b[1];a[2]=b[2];return a},set:function(a,b,g,n){a[0]=b;a[1]=g;a[2]=n;return a},add:function(a,b){return new i(a[0]+b[0],a[1]+b[1],a[2]+b[2])},$add:function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];return a},add2:function(a,b,g){a[0]=b[0]+g[0];a[1]=b[1]+g[1];a[2]=b[2]+g[2];return a},sub:function(a,b){return new i(a[0]-b[0],a[1]-b[1],a[2]-b[2])},$sub:function(a,b){a[0]-=b[0];a[1]-=b[1];a[2]-=b[2];return a},sub2:function(a,b,g){a[0]=b[0]-g[0];a[1]=b[1]-g[1];a[2]=b[2]-g[2];return a},scale:function(a,
b){return new i(a[0]*b,a[1]*b,a[2]*b)},$scale:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;return a},neg:function(a){return new i(-a[0],-a[1],-a[2])},$neg:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];return a},unit:function(a){var b=i.norm(a);if(b>0)return i.scale(a,1/b);return i.clone(a)},$unit:function(a){var b=i.norm(a);if(b>0)return i.$scale(a,1/b);return a},cross:function(a,b){var g=a[0],n=a[1],q=a[2],r=b[0],x=b[1],z=b[2];return new i(n*z-q*x,q*r-g*z,g*x-n*r)},$cross:function(a,b){var g=a[0],n=a[1],
q=a[2],r=b[0],x=b[1],z=b[2];a[0]=n*z-q*x;a[1]=q*r-g*z;a[2]=g*x-n*r;return a},distTo:function(a,b){var g=a[0]-b[0],n=a[1]-b[1],q=a[2]-b[2];return v(g*g+n*n+q*q)},distToSq:function(a,b){var g=a[0]-b[0],n=a[1]-b[1],q=a[2]-b[2];return g*g+n*n+q*q},norm:function(a){var b=a[0],g=a[1];a=a[2];return v(b*b+g*g+a*a)},normSq:function(a){var b=a[0],g=a[1];a=a[2];return b*b+g*g+a*a},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},clone:function(a){return a.$$family?new i(a[0],a[1],a[2]):i.setVec3(new h(3),
a)},toFloat32Array:function(a){var b=a.typedContainer;if(!b)return a;b[0]=a[0];b[1]=a[1];b[2]=a[2];return b}},t=i.prototype,A;for(A in o){i[A]=o[A];t[A]=function(a){return function(){var b=j.call(arguments);b.unshift(this);return i[a].apply(i,b)}}(A)}var s=function(a,b,g,n,q,r,x,z,B,C,D,E,G,I,J,H){c.call(this,16);this.length=16;typeof a=="number"?this.set(a,b,g,n,q,r,x,z,B,C,D,E,G,I,J,H):this.id();this.typedContainer=new h(16)};s.create=function(){return new h(16)};s.prototype=Object.create(c.prototype,
{$$family:{value:"Mat4"},n11:y(0),n12:y(4),n13:y(8),n14:y(12),n21:y(1),n22:y(5),n23:y(9),n24:y(13),n31:y(2),n32:y(6),n33:y(10),n34:y(14),n41:y(3),n42:y(7),n43:y(11),n44:y(15)});o={id:function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},clone:function(a){return a.$$family?new s(a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]):new h(a)},set:function(a,b,g,n,q,r,x,z,B,C,D,E,G,
I,J,H,F){a[0]=b;a[4]=g;a[8]=n;a[12]=q;a[1]=r;a[5]=x;a[9]=z;a[13]=B;a[2]=C;a[6]=D;a[10]=E;a[14]=G;a[3]=I;a[7]=J;a[11]=H;a[15]=F;return a},mulVec3:function(a,b){var g=i.clone(b);return s.$mulVec3(a,g)},$mulVec3:function(a,b){var g=b[0],n=b[1],q=b[2];b[0]=a[0]*g+a[4]*n+a[8]*q+a[12];b[1]=a[1]*g+a[5]*n+a[9]*q+a[13];b[2]=a[2]*g+a[6]*n+a[10]*q+a[14];return b},mulMat42:function(a,b,g){var n=b[0],q=b[1],r=b[2],x=b[3],z=b[4],B=b[5],C=b[6],D=b[7],E=b[8],G=b[9],I=b[10],J=b[11],H=b[12],F=b[13],M=b[14];b=b[15];
var K=g[0],L=g[1],P=g[2],Q=g[3],R=g[4],U=g[5],V=g[6],W=g[7],S=g[8],T=g[9],X=g[10],O=g[11],Y=g[12],Z=g[13],$=g[14];g=g[15];a[0]=K*n+L*z+P*E+Q*H;a[1]=K*q+L*B+P*G+Q*F;a[2]=K*r+L*C+P*I+Q*M;a[3]=K*x+L*D+P*J+Q*b;a[4]=R*n+U*z+V*E+W*H;a[5]=R*q+U*B+V*G+W*F;a[6]=R*r+U*C+V*I+W*M;a[7]=R*x+U*D+V*J+W*b;a[8]=S*n+T*z+X*E+O*H;a[9]=S*q+T*B+X*G+O*F;a[10]=S*r+T*C+X*I+O*M;a[11]=S*x+T*D+X*J+O*b;a[12]=Y*n+Z*z+$*E+g*H;a[13]=Y*q+Z*B+$*G+g*F;a[14]=Y*r+Z*C+$*I+g*M;a[15]=Y*x+Z*D+$*J+g*b;return a},mulMat4:function(a,b){var g=
s.clone(a);return s.mulMat42(g,a,b)},$mulMat4:function(a,b){return s.mulMat42(a,a,b)},add:function(a,b){var g=s.clone(a);return s.$add(g,b)},$add:function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];a[3]+=b[3];a[4]+=b[4];a[5]+=b[5];a[6]+=b[6];a[7]+=b[7];a[8]+=b[8];a[9]+=b[9];a[10]+=b[10];a[11]+=b[11];a[12]+=b[12];a[13]+=b[13];a[14]+=b[14];a[15]+=b[15];return a},transpose:function(a){a=s.clone(a);return s.$transpose(a)},$transpose:function(a){var b=a[8],g=a[12],n=a[1],q=a[9],r=a[13],x=a[2],z=a[6],B=a[14],
C=a[3],D=a[7],E=a[11];a[1]=a[4];a[2]=b;a[3]=g;a[4]=n;a[6]=q;a[7]=r;a[8]=x;a[9]=z;a[11]=B;a[12]=C;a[13]=D;a[14]=E;return a},rotateAxis:function(a,b,g){a=s.clone(a);return s.$rotateAxis(a,b,g)},$rotateAxis:function(a,b,g){var n=k(b),q=m(b),r=1-q,x=g[0],z=g[1],B=g[2];g=x*x*r+q;b=x*z*r+B*n;var C=x*B*r-z*n,D=z*x*r-B*n,E=z*z*r+q,G=z*B*r+x*n,I=x*B*r+z*n;n=z*B*r-x*n;q=B*B*r+q;r=a[0];x=a[1];z=a[2];B=a[3];var J=a[4],H=a[5],F=a[6],M=a[7],K=a[8],L=a[9],P=a[10],Q=a[11];a[0]=r*g+J*b+K*C;a[1]=x*g+H*b+L*C;a[2]=z*
g+F*b+P*C;a[3]=B*g+M*b+Q*C;a[4]=r*D+J*E+K*G;a[5]=x*D+H*E+L*G;a[6]=z*D+F*E+P*G;a[7]=B*D+M*E+Q*G;a[8]=r*I+J*n+K*q;a[9]=x*I+H*n+L*q;a[10]=z*I+F*n+P*q;a[11]=B*I+M*n+Q*q;return a},rotateXYZ:function(a,b,g,n){a=s.clone(a);return s.$rotateXYZ(a,b,g,n)},$rotateXYZ:function(a,b,g,n){var q=a[0],r=a[1],x=a[2],z=a[3],B=a[4],C=a[5],D=a[6],E=a[7],G=a[8],I=a[9],J=a[10],H=a[11],F=m(b),M=m(g),K=m(n);b=k(b);var L=k(g),P=k(n);n=M*K;g=-F*P+b*L*K;var Q=b*P+F*L*K,R=M*P,U=F*K+b*L*P;K=-b*K+F*L*P;L=-L;b*=M;F*=M;a[0]=q*n+
B*R+G*L;a[1]=r*n+C*R+I*L;a[2]=x*n+D*R+J*L;a[3]=z*n+E*R+H*L;a[4]=q*g+B*U+G*b;a[5]=r*g+C*U+I*b;a[6]=x*g+D*U+J*b;a[7]=z*g+E*U+H*b;a[8]=q*Q+B*K+G*F;a[9]=r*Q+C*K+I*F;a[10]=x*Q+D*K+J*F;a[11]=z*Q+E*K+H*F;return a},translate:function(a,b,g,n){a=s.clone(a);return s.$translate(a,b,g,n)},$translate:function(a,b,g,n){a[12]=a[0]*b+a[4]*g+a[8]*n+a[12];a[13]=a[1]*b+a[5]*g+a[9]*n+a[13];a[14]=a[2]*b+a[6]*g+a[10]*n+a[14];a[15]=a[3]*b+a[7]*g+a[11]*n+a[15];return a},scale:function(a,b,g,n){a=s.clone(a);return s.$scale(a,
b,g,n)},$scale:function(a,b,g,n){a[0]*=b;a[1]*=b;a[2]*=b;a[3]*=b;a[4]*=g;a[5]*=g;a[6]*=g;a[7]*=g;a[8]*=n;a[9]*=n;a[10]*=n;a[11]*=n;return a},invert:function(a){a=s.clone(a);return s.$invert(a)},$invert:function(a){var b=a[0],g=a[1],n=a[2],q=a[3],r=a[4],x=a[5],z=a[6],B=a[7],C=a[8],D=a[9],E=a[10],G=a[11],I=a[12],J=a[13],H=a[14],F=a[15],M=b*x-g*r,K=b*z-n*r,L=b*B-q*r,P=g*z-n*x,Q=g*B-q*x,R=n*B-q*z,U=C*J-D*I,V=C*H-E*I,W=C*F-G*I,S=D*H-E*J,T=D*F-G*J,X=E*F-G*H,O=1/(M*X-K*T+L*S+P*W-Q*V+R*U);a[0]=(+x*X-z*T+
B*S)*O;a[1]=(-g*X+n*T-q*S)*O;a[2]=(+J*R-H*Q+F*P)*O;a[3]=(-D*R+E*Q-G*P)*O;a[4]=(-r*X+z*W-B*V)*O;a[5]=(+b*X-n*W+q*V)*O;a[6]=(-I*R+H*L-F*K)*O;a[7]=(+C*R-E*L+G*K)*O;a[8]=(+r*T-x*W+B*U)*O;a[9]=(-b*T+g*W-q*U)*O;a[10]=(+I*Q-J*L+F*M)*O;a[11]=(-C*Q+D*L-G*M)*O;a[12]=(-r*S+x*V-z*U)*O;a[13]=(+b*S-g*V+n*U)*O;a[14]=(-I*P+J*K-H*M)*O;a[15]=(+C*P-D*K+E*M)*O;return a},lookAt:function(a,b,g,n){g=i.sub(b,g);g.$unit();n=i.cross(n,g);n.$unit();var q=i.cross(g,n);q.$unit();return s.set(a,n[0],n[1],n[2],-n.dot(b),q[0],q[1],
q[2],-q.dot(b),g[0],g[1],g[2],-g.dot(b),0,0,0,1)},frustum:function(a,b,g,n,q,r,x){var z=g-b,B=q-n,C=x-r;a[0]=r*2/z;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=r*2/B;a[6]=0;a[7]=0;a[8]=(g+b)/z;a[9]=(q+n)/B;a[10]=-(x+r)/C;a[11]=-1;a[12]=0;a[13]=0;a[14]=-(x*r*2)/C;a[15]=0;return a},perspective:function(a,b,g,n,q){b=n*d(b*f/360);var r=-b;return s.frustum(a,r*g,b*g,r,b,n,q)},ortho:function(a,b,g,n,q,r,x){var z=g-b,B=q-n,C=x-r;a[0]=2/z;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=2/B;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=-2/C;a[11]=
0;a[12]=-(b+g)/z;a[13]=-(q+n)/B;a[14]=-(x+r)/C;a[15]=1;return a},toFloat32Array:function(a){var b=a.typedContainer;if(!b)return a;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return b}};t=s.prototype;for(A in o){s[A]=o[A];t[A]=function(a){return function(){var b=j.call(arguments);b.unshift(this);return s[a].apply(s,b)}}(A)}var w=function(a,b,g,n){c.call(this,4);this[0]=a||
0;this[1]=b||0;this[2]=g||0;this[3]=n||0;this.typedContainer=new h(4)};w.create=function(){return new h(4)};o={setQuat:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];return a},set:function(a,b,g,n,q){a[0]=b||0;a[1]=g||0;a[2]=n||0;a[3]=q||0;return a},clone:function(a){return a.$$family?new w(a[0],a[1],a[2],a[3]):w.setQuat(new h(4),a)},neg:function(a){return new w(-a[0],-a[1],-a[2],-a[3])},$neg:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];a[3]=-a[3];return a},add:function(a,b){return new w(a[0]+
b[0],a[1]+b[1],a[2]+b[2],a[3]+b[3])},$add:function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];a[3]+=b[3];return a},sub:function(a,b){return new w(a[0]-b[0],a[1]-b[1],a[2]-b[2],a[3]-b[3])},$sub:function(a,b){a[0]-=b[0];a[1]-=b[1];a[2]-=b[2];a[3]-=b[3];return a},scale:function(a,b){return new w(a[0]*b,a[1]*b,a[2]*b,a[3]*b)},$scale:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;a[3]*=b;return a},mulQuat:function(a,b){var g=a[0],n=a[1],q=a[2],r=a[3],x=b[0],z=b[1],B=b[2],C=b[3];return new w(r*x+g*C+n*B-q*z,r*z+n*C+
q*x-g*B,r*B+q*C+g*z-n*x,r*C-g*x-n*z-q*B)},$mulQuat:function(a,b){var g=a[0],n=a[1],q=a[2],r=a[3],x=b[0],z=b[1],B=b[2],C=b[3];a[0]=r*x+g*C+n*B-q*z;a[1]=r*z+n*C+q*x-g*B;a[2]=r*B+q*C+g*z-n*x;a[3]=r*C-g*x-n*z-q*B;return a},divQuat:function(a,b){var g=a[0],n=a[1],q=a[2],r=a[3],x=b[0],z=b[1],B=b[2],C=b[3],D=1/(C*C+x*x+z*z+B*B);return new w((g*C-r*x-n*B+q*z)*D,(g*B-r*z+n*C-q*x)*D,(n*x+q*C-r*B-g*z)*D,(r*C+g*x+n*z+q*B)*D)},$divQuat:function(a,b){var g=a[0],n=a[1],q=a[2],r=a[3],x=b[0],z=b[1],B=b[2],C=b[3],
D=1/(C*C+x*x+z*z+B*B);a[0]=(g*C-r*x-n*B+q*z)*D;a[1]=(g*B-r*z+n*C-q*x)*D;a[2]=(n*x+q*C-r*B-g*z)*D;a[3]=(r*C+g*x+n*z+q*B)*D;return a},invert:function(a){var b=a[0],g=a[1],n=a[2];a=a[3];var q=1/(b*b+g*g+n*n+a*a);return new w(-b*q,-g*q,-n*q,a*q)},$invert:function(a){var b=a[0],g=a[1],n=a[2],q=a[3],r=1/(b*b+g*g+n*n+q*q);a[0]=-b*r;a[1]=-g*r;a[2]=-n*r;a[3]=q*r;return a},norm:function(a){var b=a[0],g=a[1],n=a[2];a=a[3];return v(b*b+g*g+n*n+a*a)},normSq:function(a){var b=a[0],g=a[1],n=a[2];a=a[3];return b*
b+g*g+n*n+a*a},unit:function(a){return w.scale(a,1/w.norm(a))},$unit:function(a){return w.$scale(a,1/w.norm(a))},conjugate:function(a){return new w(-a[0],-a[1],-a[2],a[3])},$conjugate:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];return a}};t=w.prototype={};for(A in o){w[A]=o[A];t[A]=function(a){return function(){var b=j.call(arguments);b.unshift(this);return w[a].apply(w,b)}}(A)}i.fromQuat=function(a){return new i(a[0],a[1],a[2])};w.fromVec3=function(a,b){return new w(a[0],a[1],a[2],b||0)};w.fromMat4=
function(a){var b,g,n;if(a[0]>a[5]&&a[0]>a[10]){b=0;g=1;n=2}else if(a[5]>a[0]&&a[5]>a[10]){b=1;g=2;n=0}else{b=2;g=0;n=1}var q=v(1+a[b*5]-a[g*5]-a[n*5]),r=new w;r[b]=0.5*q;r[g]=0.5*(a["n"+g+""+b]+a["n"+b+""+g])/q;r[n]=0.5*(a["n"+b+""+n]+a["n"+n+""+b])/q;r[3]=0.5*(a["n"+g+""+n]-a["n"+n+""+g])/q;return r};w.fromXRotation=function(a){return new w(k(a/2),0,0,m(a/2))};w.fromYRotation=function(a){return new w(0,k(a/2),0,m(a/2))};w.fromZRotation=function(a){return new w(0,0,k(a/2),m(a/2))};w.fromAxisRotation=
function(a,b){var g=a[0],n=a[1],q=a[2],r=1/v(g*g+n*n+q*q),x=k(b/2),z=m(b/2);return new w(x*g*r,x*n*r,x*q*r,z)};s.fromQuat=function(a){var b=a[3],g=a[0],n=a[1];a=a[2];return new s(b*b+g*g-n*n-a*a,2*g*n-2*b*a,2*g*a+2*b*n,0,2*g*n+2*b*a,b*b-g*g+n*n-a*a,2*n*a-2*b*g,0,2*g*a-2*b*n,2*n*a+2*b*g,b*b-g*g-n*n+a*a,0,0,0,0,1)};PhiloGL.Vec3=i;PhiloGL.Mat4=s;PhiloGL.Quat=w})();(function(){function y(f){return f!==true?f:false}var v=function(f){var j=function(h){for(var c={x:0,y:0};h&&!/^(?:body|html)$/i.test(h.tagName);){c.x+=
h.offsetLeft;c.y+=h.offsetTop;h=h.offsetParent}return c}(f);f=function(h){for(var c={x:0,y:0};h&&!/^(?:body|html)$/i.test(h.tagName);){c.x+=h.scrollLeft;c.y+=h.scrollTop;h=h.parentNode}return c}(f);return{x:j.x-f.x,y:j.y-f.y}},k={get:function(f,j){return f||(j||window).event},getWheel:function(f){return f.wheelDelta?f.wheelDelta/120:-(f.detail||0)/3},getKey:function(f){var j=f.which||f.keyCode,h;a:{h=d.Keys;for(var c in h)if(h[c]==j){h=c;break a}h=void 0}c=j-111;if(c>0&&c<13)h="f"+c;h=h||String.fromCharCode(j).toLowerCase();
return{code:j,key:h,shift:f.shiftKey,control:f.ctrlKey,alt:f.altKey,meta:f.metaKey}},isRightClick:function(f){return f.which==3||f.button==2},getPos:function(f,j){j=j||window;f=f||j.event;var h=j.document;h=h.documentElement||h.body;if(f.touches&&f.touches.length)f=f.touches[0];return{x:f.pageX||f.clientX+h.scrollLeft,y:f.pageY||f.clientY+h.scrollTop}},stop:function(f){f.stopPropagation&&f.stopPropagation();f.cancelBubble=true;if(f.preventDefault)f.preventDefault();else f.returnValue=false}},m=function(f,
j){var h=f.canvas;this.scene=f.scene;this.domElem=h;this.pos=v(h);this.opt=this.callbacks=j;this.size={width:h.width||h.offsetWidth,height:h.height||h.offsetHeight};this.attachEvents()};m.prototype={hovered:false,pressed:false,touched:false,touchMoved:false,moved:false,attachEvents:function(){var f=this.domElem,j=this;if(this.opt.disableContextMenu)f.oncontextmenu=function(){return false};["mouseup","mousedown","mousemove","mouseover","mouseout","touchstart","touchmove","touchend"].forEach(function(c){f.addEventListener(c,
function(l,i){j[c](j.eventInfo(c,l,i))},false)});["keydown","keyup"].forEach(function(c){document.addEventListener(c,function(l,i){j[c](j.eventInfo(c,l,i))},false)});var h="";h=!document.getBoxObjectFor&&window.mozInnerScreenX==null?"mousewheel":"DOMMouseScroll";f.addEventListener(h,function(c,l){j.mousewheel(j.eventInfo("mousewheel",c,l))},false)},eventInfo:function(f,j,h){var c=this.domElem,l=this.scene,i=this.opt,o=this.getSize(),t=i.relative,A=i.centerOrigin,s=i.cachePosition&&this.pos||v(c),
w=k.get(j,h),a=k.getPos(j,h);j={};h=a.x;c=a.y;if(t){h-=s.x;c-=s.y;if(A){h-=o.width/2;c-=o.height/2;c*=-1}}switch(f){case "mousewheel":j.wheel=k.getWheel(w);break;case "keydown":u.extend(j,k.getKey(w));break;case "mouseup":j.isRightClick=k.isRightClick(w)}var b;u.extend(j,{x:h,y:c,cache:false,stop:function(){k.stop(w)},getTarget:function(){if(b)return b;return b=!i.picking||l.pick(a.x-s.x,a.y-s.y)||true}});j.event=w;return j},getSize:function(){if(this.cacheSize)return this.size;var f=this.domElem;
return{width:f.width||f.offsetWidth,height:f.height||f.offsetHeight}},mouseup:function(f){if(!this.moved)if(f.isRightClick)this.callbacks.onRightClick(f,this.hovered);else this.callbacks.onClick(f,y(this.pressed));if(this.pressed){if(this.moved)this.callbacks.onDragEnd(f,y(this.pressed));else this.callbacks.onDragCancel(f,y(this.pressed));this.pressed=this.moved=false}},mouseout:function(f){for(var j=f.relatedTarget,h=this.domElem;j&&j.parentNode;){if(h==j.parentNode)return;j=j.parentNode}if(this.hovered){this.callbacks.onMouseLeave(f,
this.hovered);this.hovered=false}if(this.pressed&&this.moved){this.callbacks.onDragEnd(f);this.pressed=this.moved=false}},mouseover:function(){},mousemove:function(f){if(this.pressed){this.moved=true;this.callbacks.onDragMove(f,y(this.pressed))}else{if(this.hovered){var j=y(f.getTarget());if(!j||j.id!=this.hovered.id){this.callbacks.onMouseLeave(f,this.hovered);if(this.hovered=j)this.callbacks.onMouseEnter(f,this.hovered)}else this.callbacks.onMouseMove(f,this.hovered)}else if(this.hovered=y(f.getTarget()))this.callbacks.onMouseEnter(f,
this.hovered);if(!this.opt.picking)this.callbacks.onMouseMove(f)}},mousewheel:function(f){this.callbacks.onMouseWheel(f)},mousedown:function(f){this.pressed=f.getTarget();this.callbacks.onDragStart(f,y(this.pressed))},touchstart:function(f){this.touched=f.getTarget();this.callbacks.onTouchStart(f,y(this.touched))},touchmove:function(f){if(this.touched){this.touchMoved=true;this.callbacks.onTouchMove(f,y(this.touched))}},touchend:function(f){if(this.touched){if(this.touchMoved)this.callbacks.onTouchEnd(f,
y(this.touched));else this.callbacks.onTouchCancel(f,y(this.touched));this.touched=this.touchMoved=false}},keydown:function(f){this.callbacks.onKeyDown(f)},keyup:function(f){this.callbacks.onKeyUp(f)}};var d={};d.create=function(f,j){j=u.extend({cachePosition:true,cacheSize:true,relative:true,centerOrigin:true,disableContextMenu:true,bind:false,picking:false,onClick:u.empty,onRightClick:u.empty,onDragStart:u.empty,onDragMove:u.empty,onDragEnd:u.empty,onDragCancel:u.empty,onTouchStart:u.empty,onTouchMove:u.empty,
onTouchEnd:u.empty,onTouchCancel:u.empty,onMouseMove:u.empty,onMouseEnter:u.empty,onMouseLeave:u.empty,onMouseWheel:u.empty,onKeyDown:u.empty,onKeyUp:u.empty},j||{});var h=j.bind;if(h)for(var c in j)c.match(/^on[a-zA-Z0-9]+$/)&&function(l,i){j[l]=function(){return i.apply(h,Array.prototype.slice.call(arguments))}}(c,j[c]);new m(f,j);f.events=j};d.Keys={enter:13,up:38,down:40,left:37,right:39,esc:27,space:32,backspace:8,tab:9,"delete":46};PhiloGL.Events=d})();(function(){function y(){return arguments.length==
2?{vs:arguments[0],fs:arguments[1]}:arguments[0]||{}}var v=function(d,f,j){var h=d.createShader(j);if(h==null)throw"Error creating the shader with shader type: "+j;d.shaderSource(h,f);d.compileShader(h);if(!d.getShaderParameter(h,d.COMPILE_STATUS)){f=d.getShaderInfoLog(h);d.deleteShader(h);throw"Error while compiling the shader "+f;}return h},k=function(d,f,j){var h=p.getUniformLocation(d,f.name);d=f.type;var c=false,l=true,i,o;if(f.size>1&&j)switch(d){case p.FLOAT:i=p.uniform1fv;o=Float32Array;l=
false;break;case p.INT:case p.BOOL:case p.SAMPLER_2D:case p.SAMPLER_CUBE:i=p.uniform1iv;o=Uint16Array;l=false}if(l)switch(d){case p.FLOAT:i=p.uniform1f;break;case p.FLOAT_VEC2:i=p.uniform2fv;o=j?Float32Array:new Float32Array(2);break;case p.FLOAT_VEC3:i=p.uniform3fv;o=j?Float32Array:new Float32Array(3);break;case p.FLOAT_VEC4:i=p.uniform4fv;o=j?Float32Array:new Float32Array(4);break;case p.INT:case p.BOOL:case p.SAMPLER_2D:case p.SAMPLER_CUBE:i=p.uniform1i;break;case p.INT_VEC2:case p.BOOL_VEC2:i=
p.uniform2iv;o=j?Uint16Array:new Uint16Array(2);break;case p.INT_VEC3:case p.BOOL_VEC3:i=p.uniform3iv;o=j?Uint16Array:new Uint16Array(3);break;case p.INT_VEC4:case p.BOOL_VEC4:i=p.uniform4iv;o=j?Uint16Array:new Uint16Array(4);break;case p.FLOAT_MAT2:c=true;i=p.uniformMatrix2fv;break;case p.FLOAT_MAT3:c=true;i=p.uniformMatrix3fv;break;case p.FLOAT_MAT4:c=true;i=p.uniformMatrix4fv}if(i.bind)i=i.bind(p);else{var t=i;i=function(){t.apply(p,arguments)}}return j?function(A){i(h,new o(A))}:c?function(A){i(h,
false,A.toFloat32Array())}:o?function(A){o.set(A);i(h,o)}:function(A){i(h,A)};throw"Unknown type: "+d;},m=function(d,f){var j=p,h=j.createProgram();j.attachShader(h,v(j,d,j.VERTEX_SHADER));j.attachShader(h,v(j,f,j.FRAGMENT_SHADER));j.linkProgram(h);if(!j.getProgramParameter(h,j.LINK_STATUS))throw"Error linking the shader: "+j.getProgramInfoLog(h);if(!h)return false;j={};for(var c={},l,i,o=p.getProgramParameter(h,p.ACTIVE_ATTRIBUTES),t=0;t<o;t++){l=p.getActiveAttrib(h,t);i=l.name;l=p.getAttribLocation(h,
l.name);j[i]=l}o=p.getProgramParameter(h,p.ACTIVE_UNIFORMS);for(t=0;t<o;t++){l=p.getActiveUniform(h,t);i=l.name;i=i[i.length-1]=="]"?i.substr(0,i.length-3):i;c[i]=k(h,l,l.name!=i)}this.program=h;this.attributes=j;this.attributeEnabled={};this.uniforms=c};m.prototype={$$family:"program",setUniform:function(d,f){if(this.uniforms[d])this.uniforms[d](f);return this},setUniforms:function(d){for(var f in d)this.setUniform(f,d[f]);return this}};["setBuffer","setBuffers","use"].forEach(function(d){m.prototype[d]=
function(){var f=Array.prototype.slice.call(arguments);f.unshift(this);N[d].apply(N,f);return this}});["setFrameBuffer","setFrameBuffers","setRenderBuffer","setRenderBuffers","setTexture","setTextures"].forEach(function(d){m.prototype[d]=function(){N[d].apply(N,arguments);return this}});m.fromShaderIds=function(){var d=y.apply({},arguments),f=u(d.vs);d=u(d.fs);return new m(f.innerHTML,d.innerHTML)};m.fromShaderSources=function(d){d=y.apply({},arguments);return new m(d.vs,d.fs)};m.fromDefaultShaders=
function(){var d=y.apply({},arguments),f=PhiloGL.Shaders;return PhiloGL.Program.fromShaderSources(f.Vertex[d.vs||"Default"],f.Fragment[d.fs||"Default"])};m.fromShaderURIs=function(d){d=u.merge({path:"",vs:"",fs:"",noCache:false,onSuccess:u.empty,onError:u.empty},d||{});(new PhiloGL.IO.XHR.Group({urls:[d.path+d.vs,d.path+d.fs],noCache:d.noCache,onError:function(f){d.onError(f)},onComplete:function(f){d.onSuccess(m.fromShaderSources(f[0],f[1]),d)}})).send()};PhiloGL.Program=m})();(function(){var y=
{},v=function(d){this.opt=d=u.merge({url:"http://philogljs.org/",method:"GET",async:true,noCache:false,sendAsBinary:false,responseType:false,onProgress:u.empty,onSuccess:u.empty,onError:u.empty,onAbort:u.empty,onComplete:u.empty},d||{});this.initXHR()};v.State={};["UNINITIALIZED","LOADING","LOADED","INTERACTIVE","COMPLETED"].forEach(function(d,f){v.State[d]=f});v.prototype={initXHR:function(){var d=this.req=new XMLHttpRequest,f=this;["Progress","Error","Abort","Load"].forEach(function(j){d.addEventListener(j.toLowerCase(),
function(h){f["handle"+j](h)},false)})},send:function(d){var f=this.req,j=this.opt,h=j.async;if(j.noCache)j.url+=(j.url.indexOf("?")>=0?"&":"?")+u.uid();f.open(j.method,j.url,h);if(j.responseType)f.responseType=j.responseType;if(h)f.onreadystatechange=function(){if(f.readyState==v.State.COMPLETED)if(f.status==200)j.onSuccess(f.responseType?f.response:f.responseText);else j.onError(f.status)};j.sendAsBinary?f.sendAsBinary(d||j.body||null):f.send(d||j.body||null);if(!h)if(f.status==200)j.onSuccess(f.responseType?
f.response:f.responseText);else j.onError(f.status)},setRequestHeader:function(d,f){this.req.setRequestHeader(d,f);return this},handleProgress:function(d){if(d.lengthComputable)this.opt.onProgress(d,Math.round(d.loaded/d.total*100));else this.opt.onProgress(d,-1)},handleError:function(d){this.opt.onError(d)},handleAbort:function(){this.opt.onAbort(e)},handleLoad:function(d){this.opt.onComplete(d)}};v.Group=function(d){function f(i){return function(o){--c;d.onError(o,i);if(!c)d.onComplete(l)}}function j(i){return function(o){--c;
l[i]=o;d.onSuccess(o,i);if(!c)d.onComplete(l)}}d=u.merge({urls:[],onError:u.empty,onSuccess:u.empty,onComplete:u.empty,method:"GET",async:true,noCache:false,sendAsBinary:false,responseType:false},d||{});var h=u.splat(d.urls),c=h.length,l=Array(c);this.reqs=h.map(function(i,o){return new v({url:i,method:d.method,async:d.async,noCache:d.noCache,sendAsBinary:d.sendAsBinary,responseType:d.responseType,body:d.body,onError:f(o),onSuccess:j(o)})})};v.Group.prototype={send:function(){for(var d=0,f=this.reqs,
j=f.length;d<j;++d)f[d].send()}};var k=function(d){d=u.merge({url:"http://philogljs.org/",data:{},noCache:false,onComplete:u.empty,callbackKey:"callback"},d||{});var f=k.counter++,j=[],h;for(h in d.data)j.push(h+"="+d.data[h]);j=j.join("&");if(d.noCache)j+=(j.indexOf("?")>=0?"&":"?")+u.uid();j=d.url+(d.url.indexOf("?")>-1?"&":"?")+d.callbackKey+"=PhiloGL.IO.JSONP.requests.request_"+f+(j.length>0?"&"+j:"");var c=document.createElement("script");c.type="text/javascript";c.src=j;k.requests["request_"+
f]=function(l){d.onComplete(l);c.parentNode&&c.parentNode.removeChild(c);c.clearAttributes&&c.clearAttributes()};document.getElementsByTagName("head")[0].appendChild(c)};k.counter=0;k.requests={};var m=function(d){d=u.merge({src:[],noCache:false,onProgress:u.empty,onComplete:u.empty},d||{});var f=0,j=d.src.length,h=function(){d.onProgress(Math.round(++f/j*100));if(f==j)d.onComplete(o)},c=function(){if(++f==j)d.onComplete(o)},l=d.noCache,i=u.uid(),o=d.src.map(function(t,A){var s=new Image;s.index=
A;s.onload=h;s.onerror=c;s.src=t+(l?(t.indexOf("?")>=0?"&":"?")+i:"");return s});return o};y.XHR=v;y.JSONP=k;y.Images=m;y.Textures=function(d){d=u.merge({src:[],noCache:false,onComplete:u.empty},d||{});m({src:d.src,noCache:d.noCache,onComplete:function(f){var j={};f.forEach(function(h,c){j[d.src[c]]=u.merge({data:{value:h}},d)});N.setTextures(j);d.onComplete()}})};PhiloGL.IO=y})();(function(){var y=PhiloGL.Vec3,v=PhiloGL.Mat4,k=function(m,d,f,j,h){h=h||{};var c=h.position,l=h.target,i=h.up;this.type=
h.type?h.type:"perspective";this.fov=m;this.near=f;this.far=j;this.aspect=d;this.position=c&&new y(c.x,c.y,c.z)||new y;this.target=l&&new y(l.x,l.y,l.z)||new y;this.up=i&&new y(i.x,i.y,i.z)||new y(0,1,0);if(this.type=="perspective")this.projection=(new v).perspective(m,d,f,j);else{m=f*Math.tan(m*Math.PI/360);h=-m;this.projection=(new v).ortho(h*d,m*d,h,m,f,j)}this.view=new v};k.prototype={update:function(){if(this.type=="perspective")this.projection=(new v).perspective(this.fov,this.aspect,this.near,
this.far);else{var m=this.near*Math.tan(this.fov*Math.PI/360),d=-m,f=d*this.aspect,j=m*this.aspect;this.projection=(new v).ortho(f,j,d,m,this.near,this.far)}this.view.lookAt(this.position,this.target,this.up)}};PhiloGL.Camera=k})();(function(){function y(c,l){if(c&&c.length<l){for(var i=c[0],o=c[1],t=c[2],A=c[3],s=[i,o,t,A],w=l/c.length,a;--w;){a=w*4;s[a]=i;s[a+1]=o;s[a+2]=t;s[a+3]=A}return new Float32Array(s)}else return c}var v=PhiloGL.Vec3,k=PhiloGL.Mat4,m=Math.cos,d=Math.sin,f=Math.PI,j=Array.prototype.slice,
h={attributeMap:{position:"vertices",normal:"normals",pickingColor:"pickingColors",colors:"color"}};h.Model=function(c){c=c||{};this.id=c.id||u.uid();this.pickable=!!c.pickable;this.pick=c.pick||function(){return false};if(c.pickingColors)this.pickingColors=c.pickingColors;this.vertices=c.vertices;this.normals=c.normals;this.textures=c.textures&&u.splat(c.textures);this.colors=c.colors;this.indices=c.indices;this.shininess=c.shininess||0;this.reflection=c.reflection||0;this.refraction=c.refraction||
0;if(c.texCoords)this.texCoords=c.texCoords;this.uniforms=c.uniforms||{};this.attributes=c.attributes||{};this.render=c.render;this.drawType=c.drawType||"TRIANGLES";this.display="display"in c?c.display:true;this.onBeforeRender=c.onBeforeRender||u.empty;this.onAfterRender=c.onAfterRender||u.empty;if(c.program)this.program=c.program;this.position=new v;this.rotation=new v;this.scale=new v(1,1,1);this.matrix=new k;c.computeCentroids&&this.computeCentroids();c.computeNormals&&this.computeNormals()};h.Model.prototype=
Object.create(null,{vertices:{set:function(c){if(c){var l=c.length;if(c.BYTES_PER_ELEMENT)this.$vertices=c;else if(this.$verticesLength==l)this.$vertices.set(c);else this.$vertices=new Float32Array(c);this.$verticesLength=l}else{delete this.$vertices;delete this.$verticesLength}},get:function(){return this.$vertices}},normals:{set:function(c){if(c){var l=c.length;if(c.BYTES_PER_ELEMENT)this.$normals=c;else if(this.$normalsLength==l)this.$normals.set(c);else this.$normals=new Float32Array(c);this.$normalsLength=
l}else{delete this.$normals;delete this.$normalsLength}},get:function(){return this.$normals}},colors:{set:function(c){if(c){var l=c.length;if(c.BYTES_PER_ELEMENT)this.$colors=c;else if(this.$colorsLength==l)this.$colors.set(c);else this.$colors=new Float32Array(c);if(this.$vertices&&this.$verticesLength/3*4!=l)this.$colors=y(j.call(this.$colors),this.$verticesLength/3*4);this.$colorsLength=this.$colors.length}else{delete this.$colors;delete this.$colorsLength}},get:function(){return this.$colors}},
pickingColors:{set:function(c){if(c){var l=c.length;if(c.BYTES_PER_ELEMENT)this.$pickingColors=c;else if(this.$pickingColorsLength==l)this.$pickingColors.set(c);else this.$pickingColors=new Float32Array(c);if(this.$vertices&&this.$verticesLength/3*4!=l)this.$pickingColors=y(j.call(this.$pickingColors),this.$verticesLength/3*4);this.$pickingColorsLength=this.$pickingColors.length}else{delete this.$pickingColors;delete this.$pickingColorsLength}},get:function(){return this.$pickingColors}},texCoords:{set:function(c){if(c)if(u.type(c)==
"object"){var l={},i;for(i in c){var o=c[i];l[i]=o.BYTES_PER_ELEMENT?o:new Float32Array(o)}this.$texCoords=l}else{l=c.length;if(c.BYTES_PER_ELEMENT)this.$texCoords=c;else if(this.$texCoordsLength==l)this.$texCoords.set(c);else this.$texCoords=new Float32Array(c);this.$texCoordsLength=l}else{delete this.$texCoords;delete this.$texCoordsLength}},get:function(){return this.$texCoords}},indices:{set:function(c){if(c){var l=c.length;if(c.BYTES_PER_ELEMENT)this.$indices=c;else if(this.$indicesLength==l)this.$indices.set(c);
else this.$indices=new Uint16Array(c);this.$indicesLength=l}else{delete this.$indices;delete this.$indicesLength}},get:function(){return this.$indices}}});u.extend(h.Model.prototype,{$$family:"model",update:function(){var c=this.matrix,l=this.position,i=this.rotation,o=this.scale;c.id();c.$translate(l.x,l.y,l.z);c.$rotateXYZ(i.x,i.y,i.z);c.$scale(o.x,o.y,o.z)},computeCentroids:function(){var c=this.vertices,l=[];this.faces.forEach(function(i){var o=[0,0,0],t=0;i.forEach(function(A){A=c[A];o[0]+=A[0];
o[1]+=A[1];o[2]+=A[2];t++});o[0]/=t;o[1]/=t;o[2]/=t;l.push(o)});this.centroids=l},computeNormals:function(){var c=this.vertices,l=[];this.faces.forEach(function(i){var o=c[i[0]],t=c[i[1]];i=c[i[2]];o={x:o[0]-t[0],y:o[1]-t[1],z:o[2]-t[2]};v.$cross(o,{x:i[0]-t[0],y:i[1]-t[1],z:i[1]-t[2]});v.norm(o)>1.0E-6&&v.unit(o);l.push([o.x,o.y,o.z])});this.normals=l}});u.extend(h.Model.prototype,{setUniforms:function(c){c.setUniforms(this.uniforms)},setAttributes:function(c){var l=this.attributes,i;for(i in l){var o=
l[i],t=this.id+"-"+i;if(Object.keys(o).length){o.attribute=i;c.setBuffer(t,o);delete o.value}else c.setBuffer(t,true)}},unsetAttributes:function(c){var l=this.attributes,i;for(i in l)c.setBuffer(this.id+"-"+i,false)},setReflection:function(c){this.reflection||this.refraction?c.setUniforms({useReflection:true,refraction:this.refraction,reflection:this.reflection}):c.setUniform("useReflection",false)},setVertices:function(c){if(this.$vertices)this.dynamic?c.setBuffer("position-"+this.id,{attribute:"position",
value:this.$vertices,size:3}):c.setBuffer("position-"+this.id)},unsetVertices:function(c){c.setBuffer("position-"+this.id,false)},setNormals:function(c){if(this.$normals)this.dynamic?c.setBuffer("normal-"+this.id,{attribute:"normal",value:this.$normals,size:3}):c.setBuffer("normal-"+this.id)},unsetNormals:function(c){c.setBuffer("normal-"+this.id,false)},setIndices:function(c){if(this.$indices)this.dynamic?c.setBuffer("indices-"+this.id,{bufferType:p.ELEMENT_ARRAY_BUFFER,drawType:p.STATIC_DRAW,value:this.$indices,
size:1}):c.setBuffer("indices-"+this.id)},unsetIndices:function(c){c.setBuffer("indices-"+this.id,false)},setPickingColors:function(c){if(this.$pickingColors)this.dynamic?c.setBuffer("pickingColor-"+this.id,{attribute:"pickingColor",value:this.$pickingColors,size:4}):c.setBuffer("pickingColor-"+this.id)},unsetPickingColors:function(c){c.setBuffer("pickingColor-"+this.id,false)},setColors:function(c){if(this.$colors)this.dynamic?c.setBuffer("color-"+this.id,{attribute:"color",value:this.$colors,size:4}):
c.setBuffer("color-"+this.id)},unsetColors:function(c){c.setBuffer("color-"+this.id,false)},setTexCoords:function(c){if(this.$texCoords){var l=this.id,i,o,t,A;if(this.dynamic)if(u.type(this.$texCoords)=="object"){i=0;o=this.textures;for(t=o.length;i<t;i++){A=o[i];c.setBuffer("texCoord-"+i+"-"+l,{attribute:"texCoord"+(i+1),value:this.$texCoords[A],size:2})}}else c.setBuffer("texCoord-"+l,{attribute:"texCoord1",value:this.$texCoords,size:2});else if(u.type(this.$texCoords)=="object"){i=0;o=this.textures;
for(t=o.length;i<t;i++)c.setBuffer("texCoord-"+i+"-"+l)}else c.setBuffer("texCoord-"+l)}},unsetTexCoords:function(c){c.setBuffer("texCoord-"+this.id,false)},setTextures:function(c){this.textures=this.textures?u.splat(this.textures):[];for(var l=0,i=this.textures,o=i.length,t=PhiloGL.Scene.MAX_TEXTURES;l<t;l++){if(l<o)if(N.textureMemo[i[l]].isCube){c.setUniform("hasTextureCube"+(l+1),true);c.setTexture(i[l],p["TEXTURE"+(l+5)])}else{c.setUniform("hasTexture"+(l+1),true);c.setTexture(i[l],p["TEXTURE"+
l])}else{c.setUniform("hasTextureCube"+(l+1),false);c.setUniform("hasTexture"+(l+1),false)}c.setUniform("sampler"+(l+1),l);c.setUniform("samplerCube"+(l+1),l+5)}},setState:function(c){this.setUniforms(c);this.setAttributes(c);this.setVertices(c);this.setColors(c);this.setPickingColors(c);this.setNormals(c);this.setTextures(c);this.setTexCoords(c);this.setIndices(c)},unsetState:function(c){c=c.attributes;p.bindBuffer(p.ARRAY_BUFFER,null);p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,null);for(var l in c)p.disableVertexAttribArray(c[l])}});
h.Cube=function(c){h.Model.call(this,u.extend({vertices:[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1],texCoords:[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1],normals:[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,
0,-1,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]},c||{}))};h.Cube.prototype=Object.create(h.Model.prototype);h.Sphere=function(c){var l=c.nlat||10,i=c.nlong||10,o=c.radius||1,t=f-0,A=2*f-0,s=(l+1)*(i+1),w=new Float32Array(s*3),a=new Float32Array(s*3);s=new Float32Array(s*2);var b=new Uint16Array(l*i*6);if(typeof o=="number"){var g=o;o=function(){return g}}for(var n=0;n<=l;n++)for(var q=0;q<=i;q++){var r=q/i,x=n/l,z=A*r,B=t*x,C=d(z);z=
m(z);var D=d(B),E=m(B);B=z*D;z=E;C*=D;D=o(B,z,C,r,x);E=q+n*(i+1);var G=E*3;E*=2;w[G+0]=D*B;w[G+1]=D*z;w[G+2]=D*C;a[G+0]=B;a[G+1]=z;a[G+2]=C;s[E+0]=r;s[E+1]=x}o=l+1;for(q=0;q<l;q++)for(n=0;n<i;n++){E=(q*i+n)*6;b[E+0]=n*o+q;b[E+1]=n*o+q+1;b[E+2]=(n+1)*o+q;b[E+3]=(n+1)*o+q;b[E+4]=n*o+q+1;b[E+5]=(n+1)*o+q+1}h.Model.call(this,u.extend({vertices:w,indices:b,normals:a,texCoords:s},c||{}))};h.Sphere.prototype=Object.create(h.Model.prototype);h.IcoSphere=function(c){var l=c.iterations||0,i=[],o=[],t=Math.sqrt,
A=Math.acos,s=Math.atan2,w=Math.PI,a=w*2;c.onAddVertex=c.onAddVertex||u.empty;var b=(1+t(5))/2,g=t(1+b*b);i.push(-1/g,b/g,0,1/g,b/g,0,-1/g,-b/g,0,1/g,-b/g,0,0,-1/g,b/g,0,1/g,b/g,0,-1/g,-b/g,0,1/g,-b/g,b/g,0,-1/g,b/g,0,1/g,-b/g,0,-1/g,-b/g,0,1/g);o.push(0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1);var n=function(){var W={};return function(S,T){S*=3;T*=3;var X=(S<T?S:T)+"|"+(S>T?S:T);if(X in W)return W[X];var O=(i[S]+
i[T])/2,Y=(i[S+1]+i[T+1])/2,Z=(i[S+2]+i[T+2])/2,$=t(O*O+Y*Y+Z*Z);O/=$;Y/=$;Z/=$;i.push(O,Y,Z);return W[X]=i.length/3-1}}();for(b=0;b<l;b++){var q=[],r=0;for(g=o.length;r<g;r+=3){var x=n(o[r],o[r+1]),z=n(o[r+1],o[r+2]),B=n(o[r+2],o[r]);q.push(o[r],x,B,o[r+1],z,x,o[r+2],B,z,x,z,B)}o=q}g=o.length;l=new Float32Array(g*3);n=new Float32Array(g*2);for(b=0;b<g;b+=3){z=o[b];B=o[b+1];var C=o[b+2];q=z*3;r=B*3;x=C*3;z*=2;B*=2;C*=2;var D=i[q],E=i[q+1],G=i[q+2],I=A(G/t(D*D+E*E+G*G)),J=s(E,D);I/=w;J=1-J/a;var H=
i[r],F=i[r+1],M=i[r+2],K=A(M/t(H*H+F*F+M*M)),L=s(F,H);K/=w;L=1-L/a;var P=i[x],Q=i[x+1],R=i[x+2],U=A(R/t(P*P+Q*Q+R*R)),V=s(Q,P);U/=w;V=1-V/a;D=v.cross({x:P-H,y:Q-F,z:R-M},{x:D-H,y:E-F,z:G-M}).$unit();l[q]=l[r]=l[x]=D.x;l[q+1]=l[r+1]=l[x+1]=D.y;l[q+2]=l[r+2]=l[x+2]=D.z;n[z]=J;n[z+1]=I;n[B]=L;n[B+1]=K;n[C]=V;n[C+1]=U}h.Model.call(this,u.extend({vertices:i,indices:o,normals:l,texCoords:n},c||{}))};h.IcoSphere.prototype=Object.create(h.Model.prototype);h.TruncatedCone=function(c){var l=c.bottomRadius||
0,i=c.topRadius||0,o=c.height||1,t=c.nradial||10,A=c.nvertical||10,s=!!c.topCap,w=!!c.bottomCap,a=(s?2:0)+(w?2:0),b=(t+1)*(A+1+a),g=new Float32Array(b*3),n=new Float32Array(b*3);b=new Float32Array(b*2);var q=new Uint16Array(t*(A+a)*6),r=t+1,x=Math,z=x.atan2(l-i,o),B=x.sin,C=x.cos;x=x.PI;var D=C(z);z=B(z);w=A+(w?2:0);var E=0,G=0;for(s=s?-2:0;s<=w;s++){var I=s/A,J=o*I,H;if(s<0){J=0;I=1;H=l}else if(s>A){J=o;I=1;H=i}else H=l+(i-l)*(s/A);if(s==-2||s==A+2)I=H=0;J-=o/2;for(var F=0;F<r;F++){var M=B(F*x*2/
t),K=C(F*x*2/t);g[E+0]=M*H;g[E+1]=J;g[E+2]=K*H;n[E+0]=s<0||s>A?0:M*D;n[E+1]=s<0?-1:s>A?1:z;n[E+2]=s<0||s>A?0:K*D;b[G+0]=F/t;b[G+1]=I;G+=2;E+=3}}for(s=0;s<A+a;s++)for(F=0;F<t;F++){l=(s*t+F)*6;q[l+0]=r*(s+0)+0+F;q[l+1]=r*(s+0)+1+F;q[l+2]=r*(s+1)+1+F;q[l+3]=r*(s+0)+0+F;q[l+4]=r*(s+1)+1+F;q[l+5]=r*(s+1)+0+F}h.Model.call(this,u.extend({vertices:g,normals:n,texCoords:b,indices:q},c||{}))};h.TruncatedCone.prototype=Object.create(h.Model.prototype);h.Cone=function(c){c.topRadius=0;c.topCap=!!c.cap;c.bottomCap=
!!c.cap;c.bottomRadius=c.radius||3;h.TruncatedCone.call(this,c)};h.Cone.prototype=Object.create(h.TruncatedCone.prototype);h.Cylinder=function(c){c.bottomRadius=c.radius;c.topRadius=c.radius;h.TruncatedCone.call(this,c)};h.Cylinder.prototype=Object.create(h.TruncatedCone.prototype);h.Plane=function(c){var l=c.type,i=l.split(","),o=c[i[0]+"len"],t=c[i[1]+"len"],A=c["n"+i[0]]||1;i=c["n"+i[1]]||1;var s=c.offset;numVertices=(A+1)*(i+1);positions=new Float32Array(numVertices*3);normals=new Float32Array(numVertices*
3);texCoords=new Float32Array(numVertices*2);for(var w=i3=i2=0;w<=i;w++)for(var a=0;a<=A;a++){var b=a/A,g=w/i;texCoords[i2+0]=b;texCoords[i2+1]=g;i2+=2;switch(l){case "x,y":positions[i3+0]=o*b-o*0.5;positions[i3+1]=t*g-t*0.5;positions[i3+2]=s;normals[i3+0]=0;normals[i3+1]=0;normals[i3+2]=1;break;case "x,z":positions[i3+0]=o*b-o*0.5;positions[i3+1]=s;positions[i3+2]=t*g-t*0.5;normals[i3+0]=0;normals[i3+1]=1;normals[i3+2]=0;break;case "y,z":positions[i3+0]=s;positions[i3+1]=o*b-o*0.5;positions[i3+2]=
t*g-t*0.5;normals[i3+0]=1;normals[i3+1]=0;normals[i3+2]=0}i3+=3}l=A+1;o=[];for(w=0;w<i;w++)for(a=0;a<A;a++){t=(w*A+a)*6;o[t+0]=(w+0)*l+a;o[t+1]=(w+1)*l+a;o[t+2]=(w+0)*l+a+1;o[t+3]=(w+1)*l+a;o[t+4]=(w+1)*l+a+1;o[t+5]=(w+0)*l+a+1}h.Model.call(this,u.extend({vertices:positions,normals:normals,texCoords:texCoords,indices:o},c))};h.Plane.prototype=Object.create(h.Model.prototype);h.id=u.time();PhiloGL.O3D=h})();(function(){var y={Vertex:{},Fragment:{}},v=y.Fragment;y.Vertex.Default="#define LIGHT_MAX 40\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color;\nattribute vec4 pickingColor;\nattribute vec2 texCoord1;\nuniform mat4 viewMatrix;\nuniform mat4 viewInverseMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 viewProjectionMatrix;\nuniform mat4 worldMatrix;\nuniform mat4 worldInverseMatrix;\nuniform mat4 worldInverseTransposeMatrix;\nuniform mat4 objectMatrix;\nuniform vec3 cameraPosition;\nuniform bool enableLights;\nuniform vec3 ambientColor;\nuniform vec3 directionalColor;\nuniform vec3 lightingDirection;\nuniform vec3 pointLocation[LIGHT_MAX];\nuniform vec3 pointColor[LIGHT_MAX];\nuniform int numberPoints;\nuniform bool useReflection;\nvarying vec3 vReflection;\nvarying vec4 vColor;\nvarying vec4 vPickingColor;\nvarying vec2 vTexCoord;\nvarying vec4 vNormal;\nvarying vec3 lightWeighting;\nvoid main(void) {\nvec4 mvPosition = worldMatrix * vec4(position, 1.0);\nvec4 transformedNormal = worldInverseTransposeMatrix * vec4(normal, 1.0);\nif(!enableLights) {\nlightWeighting = vec3(1.0, 1.0, 1.0);\n} else {\nvec3 plightDirection;\nvec3 pointWeight = vec3(0.0, 0.0, 0.0);\nfloat directionalLightWeighting = max(dot(transformedNormal.xyz, lightingDirection), 0.0);\nfor (int i = 0; i < LIGHT_MAX; i++) {\nif (i < numberPoints) {\nplightDirection = normalize((viewMatrix * vec4(pointLocation[i], 1.0)).xyz - mvPosition.xyz);\npointWeight += max(dot(transformedNormal.xyz, plightDirection), 0.0) * pointColor[i];\n} else {\nbreak;\n}\n}\nlightWeighting = ambientColor + (directionalColor * directionalLightWeighting) + pointWeight;\n}\nif (useReflection) {\nvReflection = (viewInverseMatrix[3] - (worldMatrix * vec4(position, 1.0))).xyz;\n} else {\nvReflection = vec3(1.0, 1.0, 1.0);\n}\nvColor = color;\nvPickingColor = pickingColor;\nvTexCoord = texCoord1;\nvNormal = transformedNormal;\ngl_Position = projectionMatrix * worldMatrix * vec4(position, 1.0);\n}";
v.Default="#ifdef GL_ES\nprecision highp float;\n#endif\nvarying vec4 vColor;\nvarying vec4 vPickingColor;\nvarying vec2 vTexCoord;\nvarying vec3 lightWeighting;\nvarying vec3 vReflection;\nvarying vec4 vNormal;\nuniform bool hasTexture1;\nuniform sampler2D sampler1;\nuniform bool hasTextureCube1;\nuniform samplerCube samplerCube1;\nuniform bool enablePicking;\nuniform bool hasPickingColors;\nuniform vec3 pickColor;\nuniform float reflection;\nuniform float refraction;\nuniform bool hasFog;\nuniform vec3 fogColor;\nuniform float fogNear;\nuniform float fogFar;\nvoid main(){\nif (!hasTexture1) {\ngl_FragColor = vec4(vColor.rgb * lightWeighting, vColor.a);\n} else {\ngl_FragColor = vec4(texture2D(sampler1, vec2(vTexCoord.s, vTexCoord.t)).rgb * lightWeighting, 1.0);\n}\nif (hasTextureCube1) {\nvec3 nReflection = normalize(vReflection);\nvec3 reflectionValue;\nif (refraction > 0.0) {\nreflectionValue = refract(nReflection, vNormal.xyz, refraction);\n} else {\nreflectionValue = -reflect(nReflection, vNormal.xyz);\n}\nvec4 cubeColor = textureCube(samplerCube1, vec3(-reflectionValue.x, -reflectionValue.y, reflectionValue.z));\ngl_FragColor = vec4(mix(gl_FragColor.xyz, cubeColor.xyz, reflection), 1.0);\n}\nif (enablePicking) {\nif (hasPickingColors) {\ngl_FragColor = vPickingColor;\n} else {\ngl_FragColor = vec4(pickColor, 1.0);\n}\n}\nif (hasFog) {\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\nfloat fogFactor = smoothstep(fogNear, fogFar, depth);\ngl_FragColor = mix(gl_FragColor, vec4(fogColor, gl_FragColor.w), fogFactor);\n}\n}";
PhiloGL.Shaders=y})();(function(){var y=PhiloGL.Vec3,v=function(k,m,d){d=u.merge({lights:{enable:false,ambient:{r:0.2,g:0.2,b:0.2},directional:{direction:{x:1,y:1,z:1},color:{r:0,g:0,b:0}}},effects:{fog:false}},d||{});this.program=d.program?k[d.program]:k;this.camera=m;this.models=[];this.config=d};v.prototype={add:function(){for(var k=0,m=this.models,d=arguments.length;k<d;k++){var f=arguments[k];f.id=f.id||u.uid();m.push(f);this.defineBuffers(f)}},remove:function(k){var m=this.models;k=m.indexOf(k);
k>-1&&m.splice(k,1)},getProgram:function(k){var m=this.program;if(m.$$family!="program"&&k&&k.program){m=m[k.program];m.use()}return m},defineBuffers:function(k){var m=this.getProgram(k),d=k.dynamic;k.dynamic=true;k.setAttributes(m);k.setVertices(m);k.setColors(m);k.setPickingColors(m);k.setNormals(m);k.setTexCoords(m);k.setIndices(m);k.dynamic=d},beforeRender:function(k){this.setupLighting(k);this.setupEffects(k);var m=this.camera,d=m.position,f=m.view;m=m.projection;var j=f.mulMat4(m),h=j.invert();
k.setUniforms({cameraPosition:[d.x,d.y,d.z],projectionMatrix:m,viewMatrix:f,viewProjectionMatrix:j,viewInverseMatrix:f.invert(),viewProjectionInverseMatrix:h})},setupLighting:function(k){var m=this.config.lights,d=m.ambient,f=m.directional,j=f.color,h=f.direction,c=m.enable;m=m.points&&u.splat(m.points)||[];f=m.length;var l=[],i=[],o=[],t=[];h=(new y(h.x,h.y,h.z)).$unit().$scale(-1);k.setUniform("enableLights",c);if(c){k.setUniform("ambientColor",[d.r,d.g,d.b]);k.setUniform("directionalColor",[j.r,
j.g,j.b]);k.setUniform("lightingDirection",[h.x,h.y,h.z]);k.setUniform("numberPoints",f);for(d=0;d<f;d++){c=m[d];j=c.position;h=c.color||c.diffuse;c=c.specular;l.push(j.x,j.y,j.z);i.push(h.r,h.g,h.b);o.push(+!!c);c?t.push(c.r,c.g,c.b):t.push(0,0,0)}k.setUniforms({pointLocation:l,pointColor:i});k.setUniforms({enableSpecular:o,pointSpecularColor:t})}},setupEffects:function(k){var m=this.config.effects.fog,d=m.color||{r:0.5,g:0.5,b:0.5};m?k.setUniforms({hasFog:true,fogNear:m.near,fogFar:m.far,fogColor:[d.r,
d.g,d.b]}):k.setUniform("hasFog",false)},render:function(k){k=k||{};var m=this.camera,d=this.program,f=k.renderProgram,j=u.type(d);j=!f&&j=="object";k=u.extend({onBeforeRender:u.empty,onAfterRender:u.empty},k||{});!j&&this.beforeRender(f||d);for(var h=0,c=this.models,l=c.length;h<l;++h){var i=c[h];if(i.display){d=f||this.getProgram(i);j&&this.beforeRender(d);i.onBeforeRender(d,m);k.onBeforeRender(i,h);this.renderObject(i,d);k.onAfterRender(i,h);i.onAfterRender(d,m)}}},renderToTexture:function(k,m){m=
m||{};var d=N.textures[k+"-texture"],f=N.textureMemo[k+"-texture"];this.render(m);p.bindTexture(f.textureType,d);p.generateMipmap(f.textureType);p.bindTexture(f.textureType,null)},renderObject:function(k,m){var d=this.camera,f=k.matrix,j=d.view.mulMat4(f),h=j.invert(),c=h.transpose();k.setState(m);m.setUniforms({objectMatrix:f,worldMatrix:j,worldInverseMatrix:h,worldInverseTransposeMatrix:c});if(k.render)k.render(p,m,d);else k.$indicesLength?p.drawElements(k.drawType!==undefined?p.get(k.drawType):
p.TRIANGLES,k.$indicesLength,p.UNSIGNED_SHORT,0):p.drawArrays(k.drawType!==undefined?p.get(k.drawType):p.TRIANGLES,0,k.$verticesLength/3);k.unsetState(m)},setupPicking:function(){var k=PhiloGL.Program.fromDefaultShaders(),m=v.PICKING_RES;N.setFrameBuffer("$picking",{width:N.canvas.width/m>>0,height:N.canvas.height/m>>0,bindToTexture:{parameters:[{name:"TEXTURE_MAG_FILTER",value:"LINEAR"},{name:"TEXTURE_MIN_FILTER",value:"LINEAR",generateMipmap:false}]},bindToRenderBuffer:true});N.setFrameBuffer("$picking",
false);this.pickingProgram=k},pick:function(k,m){this.pickingProgram||this.setupPicking();var d={},f=[],j=N.usedProgram,h=this.pickingProgram,c=v.PICKING_RES,l=this.config,i=l.lights.enable,o=l.effects.fog,t=p.canvas.width,A=p.canvas.height,s=[],w=new Uint8Array(4),a=0,b;l.lights.enable=false;l.effects.fog=false;h.use();N.setFrameBuffer("$picking",true);h.setUniform("enablePicking",true);p.disable(p.BLEND);p.viewport(0,0,t/c>>0,A/c>>0);p.clear(p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT);p.readPixels(0,
0,1,1,p.RGBA,p.UNSIGNED_BYTE,w);b=w[0]+w[1]*256+w[2]*65536;this.renderToTexture("$picking",{renderProgram:h,onBeforeRender:function(n,q){if(q==b)a=1;var r=q+a,x=!!n.pickingColors;h.setUniform("hasPickingColors",x);if(x)f.push(n);else{s[0]=r%256;s[1]=(r/256>>0)%256;s[2]=(r/65536>>0)%256;h.setUniform("pickColor",[s[0]/255,s[1]/255,s[2]/255]);d[s.join()]=n}}});p.readPixels(k/c>>0,(A-m)/c>>0,1,1,p.RGBA,p.UNSIGNED_BYTE,w);c=[w[0],w[1],w[2]].join();c=d[c];if(!c){A=0;for(var g=f.length;A<g;A++){c=f[A];t=
c.pick(w);if(t!==false)c.$pickingIndex=t;else c=false}}N.setFrameBuffer("$picking",false);h.setUniform("enablePicking",false);l.lights.enable=i;l.effects.fog=o;j&&j.use();return c&&c.pickable&&c}};v.MAX_TEXTURES=10;v.MAX_POINT_LIGHTS=50;v.PICKING_RES=4;PhiloGL.Scene=v})();(function(){function y(v,k){for(var m=this.workers=[];k--;)m.push(new Worker(v))}y.prototype={map:function(v){var k=this.workers,m=this.configs=[],d=0;for(k=k.length;d<k;d++)m.push(v&&v(d));return this},reduce:function(v){for(var k=
v.reduceFn,m=this.workers,d=this.configs,f=m.length,j=v.initialValue,h=function(o){f--;j=j===undefined?o.data:k(j,o.data);if(f==0)v.onComplete(j)},c=0,l=f;c<l;c++){var i=m[c];i.onmessage=h;i.postMessage(d[c])}return this}};PhiloGL.WorkerGroup=y})();(function(){var y=function(j){this.opt=u.merge({delay:0,duration:1E3,transition:function(h){return h},onCompute:u.empty,onComplete:u.empty},j||{})},v=y.Queue=[];y.prototype={timer:null,time:null,start:function(j){this.opt=u.merge(this.opt,j||{});this.time=
u.time();this.animating=true;v.push(this)},step:function(){if(this.animating){var j=u.time(),h=this.time,c=this.opt,l=c.delay,i=c.duration;if(!(j<h+l))if(j<h+l+i){j=c.transition((j-h)/(i+l));c.onCompute.call(this,j)}else{this.animating=false;c.onCompute.call(this,1);c.onComplete.call(this)}}}};y.compute=function(j,h,c){return j+(h-j)*c};y.Transition={linear:function(j){return j}};var k=y.Transition;(function(){var j=function(l,i){i=u.splat(i);return u.extend(l,{easeIn:function(o){return l(o,i)},easeOut:function(o){return 1-
l(1-o,i)},easeInOut:function(o){return o<=0.5?l(2*o,i)/2:(2-l(2*(1-o),i))/2}})},h={Pow:function(l,i){return Math.pow(l,i[0]||6)},Expo:function(l){return Math.pow(2,8*(l-1))},Circ:function(l){return 1-Math.sin(Math.acos(l))},Sine:function(l){return 1-Math.sin((1-l)*Math.PI/2)},Back:function(l,i){i=i[0]||1.618;return Math.pow(l,2)*((i+1)*l-i)},Bounce:function(l){for(var i,o=0,t=1;;o+=t,t/=2)if(l>=(7-4*o)/11){i=t*t-Math.pow((11-6*o-11*l)/4,2);break}return i},Elastic:function(l,i){return Math.pow(2,10*
--l)*Math.cos(20*l*Math.PI*(i[0]||1)/3)}},c;for(c in h)k[c]=j(h[c]);["Quad","Cubic","Quart","Quint"].forEach(function(l,i){k[l]=j(function(o){return Math.pow(o,[i+2])})})})();var m=self||window,d=function(){var j=[];if(v.length){for(var h=0,c=v.length,l;h<c;h++){l=v[h];l.step();l.animating&&j.push(l)}y.Queue=v=j}};if(m){var f=false;["webkitAnimationTime","mozAnimationTime","animationTime","webkitAnimationStartTime","mozAnimationStartTime","animationStartTime"].forEach(function(j){if(j in m){y.animationTime=
function(){return m[j]};f=true}});if(!f)y.animationTime=u.time;f=false;["webkitRequestAnimationFrame","mozRequestAnimationFrame","requestAnimationFrame"].forEach(function(j){if(j in m){y.requestAnimationFrame=function(h){m[j](function(){d();h()})};f=true}});if(!f)y.requestAnimationFrame=function(j){setTimeout(function(){d();j()},1E3/60)}}PhiloGL.Fx=y})();(function(){var y={},v=function(){};v.postProcess=function(k){var m=N.program[k.program],d=k.fromTexture?u.splat(k.fromTexture):[],f=k.toFrameBuffer,
j=!!k.toScreen,h=k.width||N.canvas.width,c=k.height||N.canvas.height;d=new PhiloGL.O3D.Plane({type:"x,y",xlen:1,ylen:1,offset:0,textures:d,program:k.program});var l=new PhiloGL.Camera(45,1,0.1,100,{position:{x:0,y:0,z:1}}),i=new PhiloGL.Scene(m,l);l.update();if(f){f in N.frameBufferMemo||N.setFrameBuffer(f,{width:h,height:c,bindToTexture:{parameters:[{name:"TEXTURE_MAG_FILTER",value:"LINEAR"},{name:"TEXTURE_MIN_FILTER",value:"LINEAR_MIPMAP_NEAREST",generateMipmap:false}]},bindToRenderBuffer:true});
m.use();N.setFrameBuffer(f,true);p.viewport(0,0,h,c);p.clear(p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT);i.add(d);m.setUniforms(k.uniforms||{});i.renderToTexture(f);N.setFrameBuffer(f,false)}else if(j){m.use();p.viewport(0,0,h,c);p.clear(p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT);i.add(d);m.setUniforms(k.uniforms||{});i.render()}return this};y.Image=v;PhiloGL.Media=y})()})();
